# .claude Directory - Context Refresh Guide

**Last Updated:** 2026-01-25 (Added ha-documentation-updater skill #13, 6/11 rooms documented, archive structure operational)
**Purpose:** Enable Claude to quickly rebuild effective context after conversation compaction
**Version:** 1.1

---

## Quick Start After Compaction

Copy and paste one of these commands at the start of a new session:

### Minimal Context (Recommended for most sessions)
```
Read .claude/skills/README.md and .claude/skills/ha-known-error-detector.md
```

**What you get:**
- Complete index of all 14 skills and when to use them
- 7 critical error patterns (prevents 30%+ of historical errors)
- Complete workflow integration patterns
- Ready to work on most tasks

**Token cost:** ~12,000 tokens (~45KB)

### Full Context Refresh (After 1+ week break)
```
Read .claude/skills/README.md, .claude/skills/ha-known-error-detector.md, .claude/REFLECTION-METRICS.md, and .claude/ROOM-DOCUMENTATION-PROGRESS.md
```

**What you get:**
- Complete skill index
- Critical error patterns
- Current project status (rooms 6/11 documented)
- Monthly improvement metrics

**Token cost:** ~30,000 tokens (~100KB)

---

## Task-Specific Context Loading

After loading minimal context, load additional files based on your task:

### For Automation Review/Validation
```
Load validation context: Read .claude/skills/ha-yaml-quality-reviewer.md and .claude/skills/ha-consolidation-analyzer.md
```

### For Room Documentation Work
```
Load documentation context: Read .claude/ROOM-DOCUMENTATION-PROGRESS.md and .claude/AGENT-HA-ROOM-DOCUMENTATION.md
```

### For Consolidation Work
```
Load consolidation context: Read .claude/skills/ha-motion-consolidator.md and .claude/skills/ha-consolidation-analyzer.md
```

### For Monthly Reflection
```
Load reflection context: Read .claude/skills/ha-reflection-reviewer.md and .claude/REFLECTION-METRICS.md
```

### For Documentation System Work
```
Load doc system context: Read .claude/skills/ha-documentation-updater.md, .claude/documentation-update-log.md, and .claude/HA-DOCUMENTATION-PROJECT-STATUS.md
```

---

## Directory Structure

### Always Current (Never Archive)

#### Skills Directory (`skills/`)
All 13 specialized skills and methodologies (6 optimization + 5 validation + 1 documentation + 1 issue management). Load by topic as needed:
- `README.md` - Master skill index (LOAD FIRST - v1.2)
- `ha-known-error-detector.md` - 7 critical error patterns (LOAD FIRST)
- `ha-yaml-quality-reviewer.md` - Comprehensive YAML validation
- `ha-consolidation-analyzer.md` - Consolidation opportunity scoring
- `ha-motion-consolidator.md` - Motion automation consolidation patterns
- `ha-reflection-reviewer.md` - Monthly error analysis and learning
- `ha-room-documentation-generator.md` - Room setup documentation
- `ha-consolidation-pre-check.md` - Pre-consolidation safety validation
- `ha-automation-id-manager.md` - Automation ID validation and assignment
- `ha-entity-reference-validator.md` - Entity reference cross-validation
- `ha-package-review.md` - Package quality assessment
- `ha-repo-status.md` - Repository state analysis
- `ha-github-issue-creator.md` - GitHub enhancement issue creation
- `ha-documentation-updater.md` - Refresh HA documentation cache

#### Agents Directory (`agents/`)
Agent specifications for specialized work:
- `ha-code-optimizer.md` - Code duplication analysis
- `ha-package-validator.md` - Package validation

#### Reference Documentation
Home Assistant documentation cache (auto-generated by ha-documentation-updater):
- `home-assistant-automation-yaml-reference.md` - Automation syntax
- `home-assistant-templating-reference.md` - Template syntax
- `home-assistant-scripts-reference.md` - Script syntax
- `home-assistant-splitting-configuration-reference.md` - Config organization
- `home-assistant-template-sensors-reference.md` - Sensor creation

#### Project Status & Tracking
- `ROOM-DOCUMENTATION-PROGRESS.md` - Current rooms being documented (6/11 complete)
- `HA-DOCUMENTATION-PROJECT-STATUS.md` - Doc system implementation status
- `REFLECTION-METRICS.md` - Monthly error trends and improvements
- `documentation-update-log.md` - Audit trail of doc changes

#### Configuration & Policies
- `settings.local.json` - Security permissions (do not modify)
- `SKILLS-ROADMAP.md` - Future skill development plan
- `monthly-scan-template.md` - Template for monthly scans
- `scan-procedures.md` - Comprehensive scan procedures
- `COMMIT-CONVENTIONS.md` - ðŸš¨ IRON CLAD LAW: No Claude attribution in commits

### Archive (Historical Context)

Created first of each month, stores:
- `archive/reflections/YYYY-MM/` - Reflection files >3 months old
- `archive/scans/YYYY/` - Scan reports >6 months old
- `archive/projects/[name]/` - Completed project documentation

---

## Critical Files Quick Reference

| File | Purpose | Load When |
|------|---------|-----------|
| `COMMIT-CONVENTIONS.md` | ðŸš¨ No Claude attribution - iron clad law | Before making any commits |
| `skills/README.md` | Master skill index | Every session start |
| `skills/ha-known-error-detector.md` | 7 error patterns to prevent | Every session start |
| `REFLECTION-METRICS.md` | Error trends and improvements | Monthly reviews or status checks |
| `ROOM-DOCUMENTATION-PROGRESS.md` | Room doc project status | When continuing room documentation |
| `HA-DOCUMENTATION-PROJECT-STATUS.md` | Doc system implementation status | Before doc system work |
| HA reference docs (5 files) | Syntax reference | When validating automation code |

---

## Claude's Automatic Context Detection

After loading minimal context, I automatically load additional files when:

1. **User mentions specific room** â†’ Load that room's setup documentation if it exists
2. **User asks to validate/review** â†’ Load ha-yaml-quality-reviewer.md
3. **User reports error** â†’ Check ha-known-error-detector.md for pattern match
4. **User mentions consolidation** â†’ Load ha-consolidation-analyzer.md
5. **First of month** â†’ Suggest loading reflection context
6. **User mentions "continue"** â†’ Load project status files to understand ongoing work

---

## How This Strategy Works

### Phase 1: Minimal Context Load
Load `skills/README.md` + `ha-known-error-detector.md` = 45KB, ~12,000 tokens
- Fast to load
- Comprehensive index of all capabilities
- Critical error prevention
- Enough to ask intelligent questions

### Phase 2: Task-Specific Loading
Based on detected task, load specialized files
- Preserves tokens for actual work
- Context matches immediate need
- Always possible to load more

### Phase 3: Automatic Detection
Claude proactively identifies needed context from user intent
- Seamless experience
- No need for manual specification
- Takes initiative to load relevant files

### Phase 4: As-Needed Reference
Load HA documentation when validating syntax or complex patterns
- Only when needed
- Prevents token waste on unused content
- Keeps focus on task

---

## Minimal Context: What's Included

When you load `skills/README.md` and `ha-known-error-detector.md`, Claude has:

### From skills/README.md:
- All 14 skill names and purposes (6 optimization + 6 validation/safety + 1 documentation + 1 issue management)
- When to use each skill
- Complete workflows (Quick/Full/Critical paths)
- Phase integration (Phases 4-6)
- Lessons learned and reusable patterns
- Quick reference checklists

### From ha-known-error-detector.md:
- Error Pattern 1: response_variable syntax
- Error Pattern 2: Entity domain/name mismatches
- Error Pattern 3: Invalid condition descriptions
- Error Pattern 4: Unquoted emoji strings
- Error Pattern 5: Automation ID format
- Error Pattern 6: Timer placement in conditionals
- Error Pattern 7: Unsafe attribute access

### From REFLECTION-METRICS.md (if loaded):
- Current error rate (30% â†’ improving)
- Top issues by category
- Validation rules that work
- Quarterly improvement targets

---

## File Archiving Strategy

### Monthly Archiving (First of Each Month)

**Move reflections >3 months old:**
```
.claude/REFLECTION-KITCHEN-2025-10-15.md
  â†’ .claude/archive/reflections/2025-10/
```

**Move scan reports >6 months old:**
```
.claude/scan-2025-07-15.md
  â†’ .claude/archive/scans/2025/
```

**Move completed project files:**
```
.claude/OLD-PROJECT-STATUS.md
  â†’ .claude/archive/projects/[project-name]/
```

**Keep permanently:**
- All `skills/` files (living documentation)
- All `agents/` files
- All HA reference docs (refreshable via Skills)
- Project templates and procedures
- `REFLECTION-METRICS.md` (running metrics)
- `documentation-update-log.md` (audit trail)
- `settings.local.json` (configuration)

---

## Verification Tests

### Test 1: Can I list all skills?
After minimal context load, ask: "What skills are available?"
Expected: Claude lists all 14 skills with brief descriptions.

### Test 2: Can I identify error patterns?
After minimal context load, ask: "What error patterns should I avoid?"
Expected: Claude lists all 7 error patterns with examples.

### Test 3: Task-specific loading works?
Ask: "Review the kitchen automations"
Expected: Claude loads validation skills, then performs review.

### Test 4: Status awareness?
After minimal + project load, ask: "What's the status of room documentation?"
Expected: Claude knows 6/11 rooms are complete, identifies next rooms.

---

## Usage Examples

### Example 1: Post-Compaction Recovery (New Session)

```
User: "I'm back. Get up to speed on what we're working on."

Claude: "Let me load my core context."
[Reads skills/README.md and ha-known-error-detector.md]
"Context refreshed. I have:
- Index of all 14 skills (6 optimization + 6 validation/safety + 1 documentation + 1 issue management)
- 7 critical error patterns
- Understanding of complete workflows

What would you like to work on?"
```

### Example 2: Task Transition

```
User: "We've been doing documentation. Now I need to review the stairs package."

Claude: "I'll load the validation skills for automation review."
[Reads ha-yaml-quality-reviewer.md and ha-consolidation-analyzer.md]
"Ready. Let me analyze the stairs automations..."
```

### Example 3: Status Check After Break

```
User: "Full context refresh - I haven't worked on this in a week."

Claude: "Loading full context..."
[Reads 4-5 core files covering skills, errors, metrics, and project status]
"Context restored. Here's the status:
- Skills: All 13 available (6 optimization + 5 validation + 1 documentation + 1 issue management)
- Project: 6/11 rooms documented (Bathroom next)
- Error rate: 30% (from January reflection)

What would you like to continue?"
```

---

## Important Notes

### Order Matters
Always load in this order:
1. `skills/README.md` (index to everything)
2. `skills/ha-known-error-detector.md` (prevent mistakes)
3. Task-specific files (as needed)
4. HA reference docs (for validation)

### Compaction Happens Automatically
- Every N messages, conversation is compacted
- You lose detailed context from previous turns
- Use these refreshes to rebuild quickly
- Effective context is 45-100KB, well within token budget

### This Guide is Your Anchor
When confused about context:
- "Read this file to understand the strategy" â†’ Point to `.claude/README.md`
- "What should I load for this task?" â†’ Check the task-specific section above
- "Where is X documentation?" â†’ Check the directory structure

---

## Next Steps When You Load Context

### After minimal context (skills README + error detector):
1. Confirm you can list all 14 skills
2. Confirm you understand the 7 error patterns
3. Ask: "What would you like me to work on?"

### After task-specific loading:
1. Begin the specific task
2. Load HA reference docs as needed
3. Proactively catch errors using loaded patterns

### After status loading:
1. Understand project progress
2. Identify next steps
3. Plan the work session

---

## Summary

**Core Strategy:**
- **Minimal refresh:** Always start with `skills/README.md` + `ha-known-error-detector.md`
- **Task-specific:** Load additional skills based on work needed
- **Automatic detection:** I proactively load context based on your intent
- **Reference on demand:** Load HA docs when validating specific syntax

**Token efficiency:**
- Minimal: 12K tokens
- Full: 30K tokens
- Task-specific: 3-8K tokens each
- HA reference: 2-5K tokens each

**Success metric:**
- Can rebuild effective context in under 2 minutes
- Know all 14 skills and 7 error patterns
- Ready to work on any task

---

**Version:** 1.2
**Created:** 2026-01-25
**Status:** Ready for Use
**Last Updated:** 2026-01-25 (Updated to match skills/README.md v1.2)
**Verification:** All 10 test scenarios passing (see CONTEXT-REFRESH-TEST-PLAN.md)
