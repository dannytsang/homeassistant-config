name: Generate Changelog

on:
  push:
    branches:
      - main
    paths:
      - '**.yaml'
      - '**.yml'
      - 'automations.yaml'
      - 'scripts.yaml'
      - 'scenes.yaml'
      - 'configuration.yaml'

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for changelog
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        run: |
          cat << 'HEADER' > CHANGELOG.md
          # Changelog

          All notable changes to Home Assistant configuration.

          ## Recent Changes (Last 20 Commits)

          HEADER
          
          # Generate changelog from git log
          git log -20 --pretty=format:"- **%h** - %s (%an, %ar)" --no-merges >> CHANGELOG.md
          
          # Add sections for different types of changes
          echo -e "\n\n## By Category\n" >> CHANGELOG.md
          
          # Automations
          echo "### ðŸ¤– Automations" >> CHANGELOG.md
          git log -20 --pretty=format:"- %s (%h)" --no-merges -- "automations.yaml" "packages/*/automation*.yaml" >> CHANGELOG.md || echo "_No recent changes_" >> CHANGELOG.md
          echo -e "\n" >> CHANGELOG.md
          
          # Scripts
          echo "### ðŸ“œ Scripts" >> CHANGELOG.md
          git log -20 --pretty=format:"- %s (%h)" --no-merges -- "scripts.yaml" "script.yaml" "packages/*/script*.yaml" >> CHANGELOG.md || echo "_No recent changes_" >> CHANGELOG.md
          echo -e "\n" >> CHANGELOG.md
          
          # Integrations
          echo "### ðŸ”Œ Integrations" >> CHANGELOG.md
          git log -20 --pretty=format:"- %s (%h)" --no-merges -- "packages/integrations/*.yaml" >> CHANGELOG.md || echo "_No recent changes_" >> CHANGELOG.md
          echo -e "\n" >> CHANGELOG.md
          
          # Rooms
          echo "### ðŸ  Rooms" >> CHANGELOG.md
          git log -20 --pretty=format:"- %s (%h)" --no-merges -- "packages/rooms/*.yaml" >> CHANGELOG.md || echo "_No recent changes_" >> CHANGELOG.md
          echo -e "\n" >> CHANGELOG.md
          
          # ESPHome
          echo "### ðŸ”§ ESPHome" >> CHANGELOG.md
          git log -20 --pretty=format:"- %s (%h)" --no-merges -- "esphome/*.yaml" >> CHANGELOG.md || echo "_No recent changes_" >> CHANGELOG.md
          echo -e "\n" >> CHANGELOG.md
          
          # Footer with stats
          echo -e "\n---" >> CHANGELOG.md
          echo -e "\n### Statistics\n" >> CHANGELOG.md
          echo "- Total commits: $(git rev-list --count HEAD)" >> CHANGELOG.md
          echo "- Configuration files: $(find . -name '*.yaml' -o -name '*.yml' | wc -l)" >> CHANGELOG.md
          echo "- Last updated: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> CHANGELOG.md
          echo "- Branch: main" >> CHANGELOG.md

      - name: Commit Changelog
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: update changelog [skip ci]" && git push)
