name: Pull Request — Validation

permissions:
  contents: read

# yamllint disable-line rule:truthy
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect file changes
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.filter.outputs.config }}
    steps:
      - uses: actions/checkout@v5
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            config:
              - '**/*.yaml'
              - '**/*.yml'
              - 'esphome/**'

  ha-stable:
    # Use the exact check name your branch protection requires
    name: Home Assistant Core Stable Configuration Check
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5

      # When there are NO config changes: mark as "skipped" (but succeed)
      - name: Mark skipped (no YAML/esphome changes)
        if: ${{ needs.changes.outputs.config != 'true' }}
        run: |
          {
            echo "## 🏠 Home Assistant Config Validation"
            echo
            echo "✅ **Skipped** — no \`*.yaml\`, \`*.yml\`, or \`esphome/**\` changes detected."
            echo "- PR: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
            echo "- Commit: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      # When there ARE config changes: run the real stable check
      - name: Prepare config for CI
        if: ${{ needs.changes.outputs.config == 'true' }}
        run: |
          mkdir -p camera
          sed -i -e '/battery_notes\:/,+2d' \
                 -e '/delete\:/,+1d' \
                 -e '/powercalc\:/,+2d' \
                 -e '/sonoff\:/,+3d' configuration.yaml

      - name: Validate (stable)
        if: ${{ needs.changes.outputs.config == 'true' }}
        id: ha
        uses: frenck/action-home-assistant@v1
        with:
          path: "./"
          secrets: ./secrets.yaml.sample
          version: "stable"

      - name: Summarize results
        if: always()
        run: |
          {
            echo "## 🏠 Home Assistant Config Validation"
            echo
            if [ "${{ needs.changes.outputs.config }}" = "true" ]; then
              echo "- **Version tested:** stable"
              echo "- **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              if [[ "${{ steps.ha.outcome }}" == "success" ]]; then
                echo "✅ Passed"
              else
                echo "❌ Failed – check the logs above"
              fi
            else
              echo "✅ **Skipped** — no \`*.yaml\`, \`*.yml\`, or \`esphome/**\` changes detected."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
