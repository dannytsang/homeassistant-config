name: Push - Validation

permissions:
  contents: read

# yamllint disable-line rule:truthy
on:
  push:
    branches: [main]
    paths:
      - '**.yaml'
      - '**.yml'
      - 'custom_components/**'
      - 'esphome/**'
      - '!*.md'
  schedule:
    # Weekly heads-up against future channels (times are UTC on GitHub)
    - cron: "0 8 * * 6"
  # Allow manual runs from the Actions tab
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect file changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      esphome: ${{ steps.filter.outputs.esphome }}
    steps:
      - uses: actions/checkout@v5
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            esphome:
              - 'esphome/**'

  validate:
    name: Validate config
    needs: changes
    uses: ./.github/workflows/_ha-validate.yml
    permissions:
      contents: read
    with:
      # Run ESPHome if esphome/** changed, OR on the weekly schedule
      run_esphome: ${{ needs.changes.outputs.esphome == 'true' || github.event_name == 'schedule' }}

  changelog:
    name: Generate Changelog
    needs: [validate]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate Changelog
        run: |
          cat << 'HEADER' > CHANGELOG.md
          # Changelog

          All notable changes to Home Assistant configuration.

          ## Recent Changes (Last 20 Commits)
          HEADER

          {
            # Generate changelog from git log
            git log -20 --pretty=format:"- **%h** - %s (%an, %ar)" --no-merges

            # By Category
            printf "\n\n## By Category\n\n"

            # Automations
            printf "### ðŸ¤– Automations\n"
            git log -20 --pretty=format:"- %s (%h)" --no-merges -- "automations.yaml" "packages/*/automation*.yaml" || printf "_No recent changes_\n"
            printf "\n"

            # Scripts
            printf "### ðŸ“œ Scripts\n"
            git log -20 --pretty=format:"- %s (%h)" --no-merges -- "scripts.yaml" "script.yaml" "packages/*/script*.yaml" || printf "_No recent changes_\n"
            printf "\n"

            # Integrations
            printf "### ðŸ”Œ Integrations\n"
            git log -20 --pretty=format:"- %s (%h)" --no-merges -- "packages/integrations/*.yaml" || printf "_No recent changes_\n"
            printf "\n"

            # Rooms
            printf "### ðŸ  Rooms\n"
            git log -20 --pretty=format:"- %s (%h)" --no-merges -- "packages/rooms/*.yaml" || printf "_No recent changes_\n"
            printf "\n"

            # ESPHome
            printf "### ðŸ”§ ESPHome\n"
            git log -20 --pretty=format:"- %s (%h)" --no-merges -- "esphome/*.yaml" || printf "_No recent changes_\n"
            printf "\n"

            # Footer with stats
            printf "\n---\n"
            printf "\n### Statistics\n\n"
            printf -- "- Total commits: %s\n" "$(git rev-list --count HEAD)"
            printf -- "- Configuration files: %s\n" "$(find . -name '*.yaml' -o -name '*.yml' | wc -l)"
            printf -- "- Last updated: %s\n" "$(date '+%Y-%m-%d %H:%M:%S UTC')"
            printf -- "- Branch: main\n"
          } >> CHANGELOG.md

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update changelog"
          title: "ðŸ“ Update Changelog"
          body: |
            Auto-generated changelog update from recent commits.

            This PR updates the CHANGELOG.md file with the latest changes.
          branch: changelog-update
          delete-branch: true
          labels: documentation
          add-paths: CHANGELOG.md

  deploy:
    name: Deploy changes
    needs: [validate]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production
    permissions:
      contents: read
    steps:
      - name: Connect Tailscale
        id: ts
        uses: tailscale/github-action@v4
        if: ${{ needs.validate.result == 'success' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:homeassistant-ci

      - name: Deploy (POST webhook with retries)
        uses: Wandalen/wretry.action@v3.8.0
        if: ${{ steps.ts.outcome == 'success' }}
        with:
          action: fjogeleit/http-request-action@v1
          with: |
            url: '${{ secrets.DEPLOYMENT_URL }}'
            method: 'POST'
            timeout: 30000
            customHeaders: '{"Content-Type":"application/json"}'
            data: '{ "key_token":"${{ secrets.PULL_KEY }}" }'
            preventFailureOnNoResponse: false
          attempt_limit: 5
          attempt_delay: 3000
      - name: Post run summary
        run: |
          {
            echo "### Deploy Summary"
            echo ""
            echo "* Event: \`${{ github.event_name }}\`"
            echo "* Ref: \`${{ github.ref }}\`"
            echo "* SHA: \`${{ github.sha }}\`"
            echo "* Timestamp: \`$(date -u +"%Y-%m-%dT%H:%M:%SZ")\`"
          } >> "$GITHUB_STEP_SUMMARY"
