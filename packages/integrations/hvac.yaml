# Created by Danny Tsang <danny@tsang.uk>
# Integration: https://www.home-assistant.io/integrations/hive/
script:
  set_central_heating_to_away_mode:
    alias: Set Central Heating To Away Mode
    icon: mdi:hvac
    sequence:
      - if:
          - or:
              - not:
                  - condition: state
                    entity_id: climate.thermostat
                    state: "heat"
              - not:
                  - condition: state
                    entity_id: climate.thermostat
                    attribute: temperature
                    state: 7
        then:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: "Setting heating to :running: away mode."
                  title: ":hotsprings: :droplet: Boiler"
              - service: climate.set_temperature
                target:
                  entity_id: climate.thermostat
                data:
                  hvac_mode: "heat"
                  temperature: 7
    mode: single
  set_central_heating_to_home_mode:
    alias: Set Central Heating To Home Mode
    icon: mdi:hvac
    sequence:
      - if:
          - not:
              - condition: state
                entity_id: climate.thermostat
                state: "auto"
        then:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: "Setting heating to :house_with_garden: home mode."
                  title: ":hotsprings: :droplet: Boiler"
              - service: climate.set_hvac_mode
                data:
                  hvac_mode: auto
                target:
                  entity_id: climate.thermostat
    mode: single
  set_central_heating_to_off:
    alias: Set Central Heating Off
    icon: mdi:hvac-off
    sequence:
      - if:
          - not:
              - condition: state
                entity_id: climate.thermostat
                state: "off"
        then:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: "Setting heating to off."
                  title: ":hotsprings: :droplet: Boiler"
              - service: climate.set_hvac_mode
                data:
                  hvac_mode: "off"
                target:
                  entity_id: climate.thermostat
    mode: single
  set_how_water_to_home_mode:
    alias: Set Hot Water To Home
    icon: mdi:water-boiler-auto
    sequence:
      - if:
          - condition: state
            entity_id: input_boolean.enable_hive_hacs_integration
            state: "on"
        then:
          - if:
              - not:
                  - condition: state
                    entity_id: water_heater.hot_water
                    state: "eco"
            then:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Turning on the hot water."
                      title: ":hotsprings: :droplet: Boiler"
                  - service: water_heater.set_operation_mode
                    data:
                      operation_mode: "eco"
                    target:
                      entity_id: water_heater.hot_water
        else:
          - if:
              - not:
                  - condition: state
                    entity_id: water_heater.hot_water
                    state: "auto"
            then:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Turning on the hot water."
                      title: ":hotsprings: :droplet: Boiler"
                  - service: water_heater.set_operation_mode
                    data:
                      operation_mode: "auto"
                    target:
                      entity_id: water_heater.hot_water
    mode: single
  set_how_water_to_away_mode:
    alias: Set Hot Water To Off
    icon: mdi:water-boiler-off
    sequence:
      - if:
          - not:
              - condition: state
                entity_id: water_heater.hot_water
                state: "off"
        then:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: "Turning off the hot water."
                  title: ":hotsprings: :droplet: Boiler"
              - service: water_heater.set_operation_mode
                data:
                  operation_mode: "off"
                target:
                  entity_id: water_heater.hot_water
    mode: single
  set_how_water_to_on:
    alias: Set Hot Water To On
    icon: mdi:water-boiler
    sequence:
      - if:
          - not:
              - condition: state
                entity_id: water_heater.hot_water
                state: "on"
        then:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: "Turning on the hot water."
                  title: ":hotsprings: :droplet: Boiler"
              - service: water_heater.set_operation_mode
                data:
                  operation_mode: "on"
                target:
                  entity_id: water_heater.hot_water
    mode: single

sensor:
  # historical stats
  - platform: history_stats
    name: Heating On Duration Today
    entity_id: sensor.thermostat_action
    state: "heating"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Heating On Duration Yesterday
    entity_id: sensor.thermostat_action
    state: "heating"
    type: time
    end: "{{ now().replace(hour=0, minute=0, second=0) }}"
    duration:
      hours: 24

template:
  - sensor:
      - name: "Thermostat Action"
        unique_id: 8dff3606-6aaf-4713-a668-140e71271416
        state: "{{ state_attr('climate.thermostat', 'hvac_action') }}"
