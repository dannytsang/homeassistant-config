conversation:
  intents:
    getBatteryLevel:
      - "[How much] battery is left"
      - "[What is the] (battery|charge) (level|remaining)"
    getBatteryRunTime:
      - "How long will the battery last [for]"
      - "How long will the battery run [for]"
      - "[What is the] battery (run time|runtime|hour|hours)"
      - "When will the battery run out"
    getBatterySummary:
      - "Battery summary"
    getChargingScheduleSummary:
      - "[What] [is the] charging schedule [summary]"
      - "[How] [is the] charging schedule [set]"
    getCurrentElectricityRates:
      - "[What is the current] [electricity] [unit] (rate|rates)"
    getExportSchedule:
      - "[What] [is the] export schedule"
    getInverterMode:
      - "[What is the] inverter mode"
    getNextElectricityRates:
      - "[What is the] next [electricity] [unit] (rate|rates)"
    getPreviousElectricityRates:
      - "[What was the] (old|previous|last) [electricity] [unit] (rate|rates)"
    getSolarForecastLeft:
      - "[How much] solar [generation is] (left|remaining) [today]"
      - "Remaining solar [generation] [forecast] [today]"
    getSolarForecastToday:
      - "[What is the] solar forecast today"
    getSolarForecastTomorrow:
      - "[What is the] solar forecast"
    getSolarGeneratedToday:
      - "[How much] solar [has] [generated|created] [today|so far]"

intent_script:
  getBatteryLevel:
    speech:
      text: >-
        {{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}
  getBatteryRunTime:
    speech:
      text: >-
        {{ states('sensor.battery_charge_remaining_hours') }}
  getBatterySummary:
    speech:
      text: >-
        {{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}
        and will run out
        {% set charge_time = as_timestamp(states('sensor.battery_charge_remaining_hours')) %}
        {% set charge_date = charge_time | timestamp_custom('%Y-%m-%d') %}
        {% set today = now().strftime('%Y-%m-%d') %}
        {% set tomorrow = (now() + timedelta(days=1)).strftime('%Y-%m-%d') %}
        {% if charge_date == today %}
          at {{ charge_time | timestamp_custom('%H:%M') }}
        {% elif charge_date == tomorrow %}
          tomorrow at {{ charge_time | timestamp_custom('%H:%M') }}
        {% else %}
          at {{ charge_time | timestamp_custom('%d/%m/%Y %H:%M') }}
        {% endif %}
  getChargingScheduleSummary:
    speech:
      text: >-
        Charging schedule summary:


        Cost nothing: {{ states('input_boolean.solar_assistant_charge_electricity_cost_nothing') }}

        Cost below nothing: {{ states('input_boolean.solar_assistant_charge_electricity_cost_below_nothing') }}


        Forecast Based: {{ states('input_boolean.enable_forecast_based_charging') }}


        Below export: {{ states('input_boolean.enable_permanent_charge_below_export') }}

        Below export schedule: {{ states('group.below_export_charging_schedules') }}
        {% if states('group.below_export_charging_schedules') == 'on' %}
        {% for s in state_attr('group.below_export_charging_schedules', 'entity_id') -%}
        {% if states(s) == 'on' %}
        # {{ state_attr(s, 'friendly_name') }}
        from: {{ as_timestamp(state_attr('binary_sensor.charge_below_export_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'after'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        to: {{ as_timestamp(state_attr('binary_sensor.charge_below_export_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'before'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        next start: {{ as_timestamp(state_attr('binary_sensor.charge_below_export_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'next_update'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
        {%- endfor -%}
        {%- endif -%}

        Battery first schedule: {{ states('group.battery_first_charging_schedules') }}
        {% if states('group.battery_first_charging_schedules') == 'on' %}
        {% for s in state_attr('group.battery_first_charging_schedules', 'entity_id') -%}
        {% if states(s) == 'on' %}
        # {{ state_attr(s, 'friendly_name') }}
        from: {{ as_timestamp(state_attr('binary_sensor.battery_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'after'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        to: {{ as_timestamp(state_attr('binary_sensor.battery_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'before'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        next start: {{ as_timestamp(state_attr('binary_sensor.battery_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'next_update'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
        {%- endfor -%}
        {%- endif -%}


        Grid first schedule: {{ states('group.grid_first_charging_schedules') }}
        {% if states('group.grid_first_charging_schedules') == 'on' %}
        {% for s in state_attr('group.grid_first_charging_schedules', 'entity_id') -%}
        {% if states(s) == 'on' %}
        # {{ state_attr(s, 'friendly_name') }}
        from: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'after'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        to: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'before'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        next start: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'next_update'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
        {%- endfor -%}
        {%- endif -%}


        Maintain charge schedule: {{ states('group.maintain_battery_first_charging_schedules') }}
        {% if states('group.maintain_battery_first_charging_schedules') == 'on' %}
        {% for s in state_attr('group.maintain_battery_first_charging_schedules', 'entity_id') -%}
        {% if states(s) == 'on' %}
        # {{ state_attr(s, 'friendly_name') }}
        from: {{ as_timestamp(state_attr('binary_sensor.maintain_charge_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'after'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        to: {{ as_timestamp(state_attr('binary_sensor.maintain_charge_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'before'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        next start: {{ as_timestamp(state_attr('binary_sensor.maintain_charge_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'next_update'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
        {%- endfor -%}
        {%- endif -%}
  getCurrentElectricityRates:
    speech:
      text: >-
        {{ states('sensor.octopus_energy_electricity_current_rate')|float(0)|round(2) }}
        {{ state_attr('sensor.octopus_energy_electricity_current_rate', 'unit_of_measurement') }}.
  getExportSchedule:
    speech:
      text: >-
        Grid first schedule: {{ states('group.grid_first_charging_schedules') }}
        {% if states('group.grid_first_charging_schedules') == 'on' %}
        {% for s in state_attr('group.grid_first_charging_schedules', 'entity_id') -%}
        {% if states(s) == 'on' %}
        # {{ state_attr(s, 'friendly_name') }}
        from: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'after'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        to: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'before'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        next start: {{ as_timestamp(state_attr('binary_sensor.grid_first_schedule_' ~ s.split('_')[s.split('_')|length - 1], 'next_update'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
        {%- endfor -%}
        {%- endif -%}
  getInverterMode:
    speech:
      text: >-
        {{ states('sensor.growatt_sph_inverter_mode') }}
  getNextElectricityRates:
    speech:
      text: >-
        {{ states('sensor.electricity_next_rate')|float(0)|round(2) }}
        {{ state_attr('sensor.electricity_next_rate', 'unit_of_measurement') }}.
  getPreviousElectricityRates:
    speech:
      text: >-
        {{ states('sensor.electricity_previous_rate')|float(0)|round(2) }}
        {{ state_attr('sensor.electricity_previous_rate', 'unit_of_measurement') }}.
  getSolarForecastLeft:
    speech:
      text: >-
        {{ (states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0) - states('sensor.growatt_sph_pv_energy')|float(0))|round(2) }}
        {{ state_attr('sensor.growatt_sph_pv_energy', 'unit_of_measurement') }} remaining.
  getSolarForecastToday:
    speech:
      text: >-
        Today's forecast is
        {{ states('sensor.total_solar_forecast_estimated_energy_production_today', with_unit=True) }}.
  getSolarForecastTomorrow:
    speech:
      text: >-
        Tomorrow's forecast is
        {{ states('sensor.total_solar_forecast_estimated_energy_production_tomorrow', with_unit=True) }}.
  getSolarGeneratedToday:
    speech:
      text: >-
        {{ states('sensor.growatt_sph_pv_energy', with_unit=True) }}
