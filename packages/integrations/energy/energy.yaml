# Created by Danny Tsang <danny@tsang.uk>
automation:
  # region Notifications
  - id: "1661076689668"
    alias: "Energy: Battery Charged And Forecasted Excess Solar"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: sensor.growatt_sph_battery_state_of_charge
        above: input_number.battery_charged_notification
    conditions:
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: sensor.total_solar_forecast_estimated_energy_production_this_hour
            above: 0
          - condition: numeric_state
            entity_id: sensor.total_solar_forecast_estimated_energy_production_next_hour
            above: 0
      - not:
          - condition: state
            entity_id: sensor.growatt_sph_inverter_mode
            state: "Battery first"
      - alias: Not from an unknown state before
        condition: template
        value_template: "{{ trigger.from_state.state != 'unknown'}}"
    actions:
      - action: script.energy_notify_excess_solar
        data: {}
    mode: single
  - id: "1660858653319"
    alias: "Energy: Solar Forecast Tomorrow"
    description: ""
    triggers:
      - trigger: time
        at: "21:00:00"
    conditions:
      - alias: Check tariff is on Agile
        condition: template
        value_template: >-
          {{ 'AGILE' in state_attr('event.octopus_energy_electricity_current_day_rates', 'tariff_code')|upper }}
    actions:
      - alias: update forecast
        action: script.update_solcast
        data: {}
      - parallel:
          - if:
              - condition: numeric_state
                entity_id: sensor.total_solar_forecast_estimated_energy_production_tomorrow
                below: input_number.solar_generation_minimum_threshold
            then:
              - action: script.send_to_home_log
                data:
                  message: >-
                    Forecast generation is expected to be low
                    ({{ states('sensor.total_solar_forecast_estimated_energy_production_tomorrow') }}<
                    {{ states('input_number.solar_generation_minimum_threshold', with_unit=True) }}).

                    Incrementing counter from {{ states('input_number.consecutive_forecast_days_below_solar_generation') }} to
                    {{ (states('input_number.consecutive_forecast_days_below_solar_generation')|int(0)) + 1 }}
                    {{ state_attr('input_number.consecutive_forecast_days_below_solar_generation', 'unit_of_measurement') }}.
                  title: ":sunny: :zap: Solar"
                  log_level: "Normal"
              - action: input_number.increment
                data: {}
                target:
                  entity_id: input_number.consecutive_forecast_days_below_solar_generation
            else:
              - action: input_number.set_value
                data:
                  value: 0
                target:
                  entity_id: input_number.consecutive_forecast_days_below_solar_generation
          - action: script.energy_notify_tomorrows_solar_forecast
            data: {}
    mode: single
  - id: "1664743590782"
    alias: "Energy: Battery Charged Today"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: sensor.growatt_sph_battery_state_of_charge
        above: input_number.growatt_battery_charged_threshold
    conditions:
      - condition: state
        entity_id: input_boolean.battery_charged_today
        state: "off"
    actions:
      - action: script.send_to_home_log
        data:
          message: Battery charged today
          title: ":sunny: :zap: Solar"
          log_level: "Debug"
      - action: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.battery_charged_today
      - if:
          - condition: numeric_state
            entity_id: input_number.consecutive_days_battery_not_charged
            above: 0
        then:
          - action: script.send_to_home_log
            data:
              message: Resetting days not fully charged.
              title: ":sunny: :zap: Solar"
              log_level: "Debug"
          - action: input_number.set_value
            data:
              value: 0
            target:
              entity_id: input_number.consecutive_days_battery_not_charged
    mode: single
  - id: "1664743700827"
    alias: "Energy: Reset Battery Charged Today"
    description: ""
    triggers:
      - trigger: time
        at: "00:00:00"
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.battery_charged_today
                state: "on"
            sequence:
              - parallel:
                  - action: script.send_to_home_log
                    data:
                      message: Resetting battery charged today.
                      title: ":sunny: :zap: Solar"
                      log_level: "Debug"
                  - action: input_boolean.turn_off
                    data: {}
                    target:
                      entity_id: input_boolean.battery_charged_today
          - conditions:
              - condition: state
                entity_id: input_boolean.battery_charged_today
                state: "off"
            sequence:
              - action: script.send_to_home_log
                data:
                  message: >-
                    Battery did not fully charge today
                    (> {{ states('input_number.growatt_battery_charged_threshold', with_unit=True) }}).
                    Adding a day to count
                    ({{ states('input_number.consecutive_days_battery_not_charged') }}).
                  title: ":sunny: :zap: Solar"
                  log_level: "Debug"
              - action: input_number.increment
                data: {}
                target:
                  entity_id: input_number.consecutive_days_battery_not_charged
    mode: single
  - id: "1663589154517"
    alias: "Energy: Solar Production exceed threshold"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: sensor.total_solar_forecast_estimated_energy_production_today
        above: input_number.solar_generation_minimum_threshold
    conditions: []
    actions:
      - action: script.send_to_home_log
        data:
          message: Production above threshold. Resetting Forecast
          title: ":sunny: :zap: Solar"
          log_level: "Debug"
    mode: single
  - id: "1664744505278"
    alias: "Energy: Consecutive Days Battery Not Charged"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: input_number.consecutive_days_battery_not_charged
        above: 6
    conditions: []
    actions:
      - action: script.send_direct_notification
        data:
          message:
            It has been {{ states('input_number.consecutive_days_battery_not_charged')
            }} days where the battery has not been charged fully.
          title: ":sunny: :zap: Solar"
          people:
            entity_id:
              - person.danny
    mode: single
  - id: "1663588514009"
    alias: "Energy: Consecutive Low Solar Generation"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: input_number.consecutive_forecast_days_below_solar_generation
        above: 6
    conditions: []
    actions:
      - action: script.send_direct_notification
        data:
          message:
            It has been {{ states('input_number.consecutive_forecast_days_below_solar_generation')
            }} days with low solar generation.
          title: ":sunny: :zap: Solar"
          people:
            entity_id:
              - person.danny
    mode: single
  - id: "1674508693884"
    alias: "Energy: Battery Charge Notification"
    description: Used for Demand Flexibility Service
    triggers:
      - trigger: time
        at: "15:55:00"
    conditions:
      - condition: template
        value_template: "{{ (states('sensor.growatt_sph_battery_state_of_charge')|int(0)) >
        ((states('number.growatt_sph_load_first_stop_discharge')|int(0)) + 1) }}"
    actions:
      - action: script.send_direct_notification
        data:
          message: >-
            {{ states('sensor.growatt_sph_battery_state_of_charge') }}%
            (That is {{ state_attr('sensor.battery_charge_remaining_hours', 'duration') }}) remaining.
          title: ":house_with_garden: ðŸ”‹ House Battery"
          people:
            entity_id:
              - person.danny
    mode: single
  - id: "1704121569476"
    alias: "Energy: Low Battery Before Peak Time"
    description: "TODO: Make this dynamic"
    triggers:
      - trigger: time
        at: "14:00:00"
      - trigger: time
        at: "15:00:00"
    conditions:
      - alias: Battery runtime less than 19:00 (usually end of peak time)
        condition: template
        value_template: >-
          {{ today_at("19:00") > as_datetime(states('sensor.battery_charge_remaining_hours')) }}
      - alias: Not already charging battery
        not:
        - condition: state
          entity_id: sensor.growatt_sph_inverter_mode
          state: "Battery first"
      - alias: Check tariff is on Agile
        condition: template
        value_template: >-
          {{ 'AGILE' in state_attr('event.octopus_energy_electricity_current_day_rates', 'tariff_code')|upper }}
    actions:
      - action: script.send_direct_notification
        data:
          message: >-
            Battery will not last beyond 19:00 today
            ({{ as_datetime(states('sensor.battery_charge_remaining_hours')) }}).
            Consider charging the battery.
          title: Solar
          people:
            entity_id:
              - person.danny
    mode: single
  - id: "1680444237958"
    alias: "Energy: Power Cut Notification"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - sensor.growatt_sph_load_power
        to: "0"
        for:
          hours: 0
          minutes: 1
          seconds: 0
    conditions: []
    actions:
      - action: script.send_direct_notification
        data:
          message:
            No electricity consumption detected for over a minute. Check for power
            cut.
          title: "âš ï¸ :zap: :house_with_garden: House âš ï¸"
    mode: single
  - id: "1712404842177"
    alias: "Energy: High Grid Power Draw"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id:
          - sensor.house_current
        above: sensor.grid_max_import_power_warning
    conditions: []
    actions:
      - action: script.send_direct_notification
        metadata: {}
        data:
          message: >-
            Current draw is close to cut out fuse
            ({{ (states('sensor.grid_max_import_power_warning')|float(0))|round(2) }}/{{ states('input_number.cut_out_fuse_size') }}).
            Consider turning devices off.
          title: "Energy: House"
          people:
            entity_id:
              - person.danny
              - person.terina
    mode: single
  - id: "1736798645231"
    alias: "Energy: Battery Depleted"
    description: "Notifies when battery runs out and switches to grid power"
    triggers:
      - trigger: numeric_state
        entity_id: sensor.growatt_sph_battery_state_of_charge
        below: 11
        for:
          minutes: 1
    conditions:
      - condition: numeric_state
        entity_id: sensor.house_grid_import_power
        above: 0
    actions:
      - parallel:
          - action: script.send_to_home_log
            data:
              message: >-
                ðŸ”‹âš ï¸ Battery depleted ({{ states('sensor.growatt_sph_battery_state_of_charge') }}%).
                Now using grid power.
              title: ":zap: Energy"
              log_level: "Normal"
          - action: script.send_direct_notification
            data:
              title: "ðŸ”‹ Battery Depleted"
              message: >-
                Battery charge at {{ states('sensor.growatt_sph_battery_state_of_charge') }}%.
                Now importing {{ states('sensor.house_grid_import_power') }}W from grid.
    mode: single
  # region Octopus
  - id: "1719080490915"
    alias: "Energy: Saving Session Started"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.octopus_energy_octoplus_saving_sessions
        not_from: "unavailable"
        to: "on"
    conditions: []
    actions:
      - action: script.send_direct_notification
        metadata: {}
        data:
          message: Energy Saver Session Started
          title: Energy
          people:
            entity_id:
              - person.danny
              - person.terina
    mode: single
  - id: "1719080490916"
    alias: "Energy: Saving Session Finished"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.octopus_energy_octoplus_saving_sessions
        not_from: "unavailable"
        to: "off"
    conditions: []
    actions:
      - action: script.send_direct_notification
        metadata: {}
        data:
          message: Energy Saver Session Finished
          title: Energy
          people:
            entity_id:
              - person.danny
              - person.terina
    mode: single

group:
  battery_first_charging_schedules:
    name: "Battery First Charging Schedules"
    entities:
      - input_boolean.enable_battery_first_schedule_1
      - input_boolean.enable_battery_first_schedule_2
  below_export_charging_schedules:
    name: "Battery First Charging Schedules"
    entities:
      - input_boolean.enable_charge_below_export_schedule_1
      - input_boolean.enable_charge_below_export_schedule_2
      - input_boolean.enable_charge_below_export_schedule_3
  grid_first_charging_schedules:
    name: "Grid First Charging Schedules"
    entities:
      - input_boolean.enable_grid_first_schedule_1
  maintain_battery_first_charging_schedules:
    name: "Maintain Battery First Charging Schedules"
    entities:
      - binary_sensor.maintain_charge_first_schedule_1
      - binary_sensor.maintain_charge_first_schedule_2

script:
  # region Forecast data
  todays_solar_forecast_data:
    alias: Today's Solar Forecast Data
    sequence:
      - action: weather.get_forecasts
        continue_on_error: true
        target:
          entity_id: weather.home
        data:
          type: daily
        response_variable: weather
      - variables:
          weather_condition: >-
            {%- if weather is defined -%}
            {{ weather['weather.home'].forecast[1].condition }}
            {%- else -%}
            {{ none }}
            {%- endif -%}
          weather_temperature: >-
            {%- if weather is defined -%}
            {{ weather['weather.home'].forecast[1].temperature }}
            {%- else -%}
            {{ none }}
            {%- endif -%}
      - action: script.battery_charge_compensation_ratio
        continue_on_error: true
        data:
          weather_condition: "{{ weather_condition }}"
        response_variable: compensation_ratio
      - variables:
          forecast: >-
            {#- If Forecast.io is unavailable, fallback to Forecast.io -#}
            {%- if states('sensor.total_solar_forecast_estimated_energy_production_today') not in ('unavailable', 'unknown') -%}
            {{ states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0) }}
            {%- else -%}
            {{ states('sensor.solcast_pv_forecast_forecast_today')|float(0) }}
            {%- endif -%}
          forecast_source: >-
            {%- if states('sensor.total_solar_forecast_estimated_energy_production_tomorrow') not in ('unavailable', 'unknown') -%}
            Forecast.io
            {%- else -%}
            Solcast
            {%- endif -%}
          last_changed: >-
            {#- If Solcast is unavailable, fallback to Forecast.io -#}
            {%- if states('sensor.solcast_pv_forecast_forecast_today') not in ('unavailable', 'unknown') -%}
            {{ states.sensor.solcast_pv_forecast_forecast_today.last_changed }}
            {%- else -%}
            {{ states.sensor.total_solar_forecast_estimated_energy_production_today.last_changed }}
            {%- endif -%}
      - action: script.calculate_charge_battery_amount
        continue_on_error: true
        data:
          forecast_kwh: "{{ forecast|default(0, true) }}"
        response_variable: battery
      - variables:
          estimate_charge_percentage_based_on_solar: >-
            {{ battery.target_soc }}
          estimate_charge_kwh_based_on_solar: >-
            {{ (states('input_number.solar_battery_size')|float(0)
            *(1-(states('number.growatt_sph_load_first_stop_discharge')|float(0)/100)))
            *(estimate_charge_percentage_based_on_solar|float(0)/100) }}
          estimate_charge_hours_based_on_solar: >-
            {{ (states('input_number.solar_battery_size')|float(0)
            *(1-(states('number.growatt_sph_load_first_stop_discharge')|float(0)/100)))
            *(estimate_charge_percentage_based_on_solar|float(0)/100)
            / states('input_number.solar_battery_max_charge_rate')|float(0) }}
          estimate_charge_percentage: >-
            {{ estimate_charge_percentage_based_on_solar }}
          estimate_charge_kwh: >-
            {{ estimate_charge_kwh_based_on_solar }}
          estimate_charge_hours: >-
            {{ estimate_charge_hours_based_on_solar }}
          solar_forecast_data: >-
            {{
              {
              'estimate_charge_percentage': estimate_charge_percentage|round(2),
              'estimate_charge_kwh': estimate_charge_kwh|round(2),
              'charge_hours': estimate_charge_hours|round(2),
              'charge_hours_rounded': (estimate_charge_hours * 2)|round(0, 'ceil')/2,
              'weather_condition': ""~weather_condition~"",
              'weather_temperature': weather_temperature,
              'weather_compensation_ratio': compensation_ratio.weather_compensation_ratio,
              'last_changed': ""~last_changed~""
              }
            }}
      - stop: "Stop running the rest of the sequence"
        response_variable: "solar_forecast_data"
  tomorrows_solar_forecast_data:
    alias: Tomorrow's Solar Forecast Data
    sequence:
      - action: weather.get_forecasts
        continue_on_error: true
        target:
          entity_id: weather.home
        data:
          type: daily
        response_variable: weather
      - variables:
          weather_condition: >-
            {%- if weather is defined -%}
            {{ weather['weather.home'].forecast[1].condition }}
            {%- else -%}
            {{ none }}
            {%- endif -%}
          weather_temperature: >-
            {%- if weather is defined -%}
            {{ weather['weather.home'].forecast[1].temperature }}
            {%- else -%}
            {{ none }}
            {%- endif -%}
      - action: script.battery_charge_compensation_ratio
        continue_on_error: true
        data:
          weather_condition: "{{ weather_condition }}"
        response_variable: compensation_ratio
      - variables:
          forecast: >-
            {#- If Forecast.io is unavailable, fallback to solcast -#}
            {%- if states('sensor.total_solar_forecast_estimated_energy_production_tomorrow') not in ('unavailable', 'unknown') -%}
            {{ states('sensor.total_solar_forecast_estimated_energy_production_tomorrow')|float(0) }}
            {%- else -%}
            {{ states('sensor.solcast_pv_forecast_forecast_tomorrow')|float(0) }}
            {%- endif -%}
          forecast_source: >-
            {%- if states('sensor.total_solar_forecast_estimated_energy_production_tomorrow') not in ('unavailable', 'unknown') -%}
            Forecast.io
            {%- else -%}
            Solcast
            {%- endif -%}
          last_changed: >-
            {#- If Solcast is unavailable, fallback to Forecast.io -#}
            {%- if states('sensor.solcast_pv_forecast_forecast_tomorrow') not in ('unavailable', 'unknown') -%}
            {{ states.sensor.solcast_pv_forecast_forecast_tomorrow.last_changed }}
            {%- else -%}
            {{ states.sensor.total_solar_forecast_estimated_energy_production_tomorrow.last_changed }}
            {%- endif -%}
      - action: script.calculate_charge_battery_amount
        continue_on_error: true
        data:
          forecast_kwh: "{{ forecast|default(0, true) }}"
        response_variable: battery
      - variables:
          estimate_charge_percentage_based_on_solar: >-
            {{ battery.target_soc }}
          estimate_charge_kwh_based_on_solar: >-
            {{ (states('input_number.solar_battery_size')|float(0)
            *(1-(states('number.growatt_sph_load_first_stop_discharge')|float(0)/100)))
            *(estimate_charge_percentage_based_on_solar|float(0)/100) }}
          estimate_charge_hours_based_on_solar: >-
            {{ (states('input_number.solar_battery_size')|float(0)
            *(1-(states('number.growatt_sph_load_first_stop_discharge')|float(0)/100)))
            *(estimate_charge_percentage_based_on_solar|float(0)/100)
            / states('input_number.solar_battery_max_charge_rate')|float(0) }}
          estimate_charge_percentage: >-
            {{ estimate_charge_percentage_based_on_solar }}
          estimate_charge_kwh: >-
            {{ estimate_charge_kwh_based_on_solar }}
          estimate_charge_hours: >-
            {{ estimate_charge_hours_based_on_solar }}
          solar_forecast_data: >-
            {{
              {
              'generation_forecast': forecast,
              'generation_forecast_unit_of_measurement': ""~'kWh'~"",
              'generation_forecast_source': ""~forecast_source~"",
              'estimate_charge_percentage': estimate_charge_percentage|round(2),
              'estimate_charge_kwh': estimate_charge_kwh|round(2),
              'charge_hours': estimate_charge_hours|round(2),
              'charge_hours_rounded': (estimate_charge_hours * 2)|round(0, 'ceil')/2,
              'weather_condition': ""~weather_condition~"",
              'weather_temperature': weather_temperature,
              'weather_compensation_ratio': compensation_ratio.weather_compensation_ratio,
              'last_changed': ""~last_changed~""
              }
            }}
      - stop: "Stop running the rest of the sequence"
        response_variable: "solar_forecast_data"
  battery_charge_compensation_ratio:
    alias: Battery Charge Compensation Ratio
    fields:
      weather_condition:
        description: Text description of the weather condition
        example: cloudy
        required: true
        selector:
          select:
            custom_value: true
            options:
              - exceptional
              - cloudy
              - fog
              - lightning
              - lightning-rainy
              - partlycloudy
              - pouring
              - rainy
              - snowy
              - sunny
              - windy
              - windy-variant
    sequence:
      - variables:
          ratio: >-
            {%- if weather_condition == "rainy" or weather_condition == "pouring" -%}
            1.5
            {%- elif weather_condition == "cloudy" -%}
            1.5
            {%- elif weather_condition == "partlycloudy" -%}
            1.25
            {%- elif weather_condition == "sunny" -%}
            1
            {%- elif weather_condition == "lightning"-%}
            1.25
            {%- elif weather_condition == "lightning-rainy" -%}
            1.25
            {%- elif weather_condition == "windy" or weather_condition == "windy-variant" -%}
            1
            {%- elif weather_condition == "snowy" -%}
            1.25
            {%- elif weather_condition == "fog" -%}
            1.5
            {%- elif weather_condition == "exceptional" -%}
            1
            {%- endif -%}
          formatted_data: >-
            {{
              {
                'weather_condition': ""~weather_condition~"",
                'weather_compensation_ratio': ratio
              }
            }}
      - stop: "Stop running the rest of the sequence"
        response_variable: "formatted_data"
  calculate_charge_battery_amount:
    alias: Calculate Charge Battery Amount
    fields:
      forecast_kwh:
        description: Forecast amount of solar generation
        required: true
        selector:
          number:
            min: 0
            max: 50
            step: 2
            unit_of_measurement: "kWh"
    sequence:
      - variables:
          soc_target: >-
            {%- if forecast_kwh|float(0) < 5 -%}
            100
            {%- elif forecast_kwh|float(0) >= 5
            and forecast_kwh|float(0) < 8.25 -%}
            85
            {%- elif forecast_kwh|float(0) >= 8.25
            and forecast_kwh|float(0) < 11.5 -%}
            70
            {%- elif forecast_kwh|float(0) >= 11.5
            and forecast_kwh|float(0) < 13 -%}
            65
            {%- elif forecast_kwh|float(0) >= 13
            and forecast_kwh|float(0) < 15 -%}
            50
            {%- elif forecast_kwh|float(0) >= 15
            and forecast_kwh|float(0) < 17 -%}
            45
            {%- elif forecast_kwh|float(0) >= 17
            and forecast_kwh|float(0) < 18 -%}
            40
            {%- elif forecast_kwh|float(0) >= 18 -%}
            23
            {%- endif -%}
          formatted_data: >-
            {{
              {
                'forecast': forecast_kwh,
                'target_soc': soc_target
              }
            }}
      - stop: "Stop running the rest of the sequence"
        response_variable: "formatted_data"
  energy_notify_tomorrows_solar_forecast:
    alias: Energy Notify Tomorrow's Solar Forecast
    variables:
      avg_hourly_energy_usage: >-
        {%- if states('input_select.home_mode')|lower == 'holiday' -%}
        {{ states('sensor.home_electricity_power_daily_average_over_a_day')|float(1) }}
        {%- else -%}
        {{ states('sensor.home_electricity_power_daily_average_over_a_week')|float(1) }}
        {%- endif -%}
    sequence:
      - action: script.tomorrows_solar_forecast_data
        response_variable: solar_forecast_data
      - variables:
          start_generation_datetime: >-
            {%- from 'get_solar_forecast.jinja' import get_first_solar_generation %}
            {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', 0.01) }}
      - variables:
          start_generation_kwh: >-
            {%- from 'get_solar_forecast.jinja' import get_first_solar_generation %}
            {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'pv_estimate', 'pv_estimate', 0.01) }}
          self_sustaining_generation_datetime: >-
            {%- from 'get_solar_forecast.jinja' import get_first_solar_generation %}
            {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', avg_hourly_energy_usage) }}
          self_sustaining_generation_kwh: >-
            {%- from 'get_solar_forecast.jinja' import get_first_solar_generation %}
            {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'pv_estimate', 'pv_estimate', avg_hourly_energy_usage) }}
      - variables:
          last_self_sustaining_generation_datetime: >-
            {%- from 'get_solar_forecast.jinja' import get_last_solar_generation %}
            {{ get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', avg_hourly_energy_usage) }}
          last_self_sustaining_generation_kwh: >-
            {%- from 'get_solar_forecast.jinja' import get_last_solar_generation %}
            {{ get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'pv_estimate', 'pv_estimate', avg_hourly_energy_usage) }}
          last_generation_datetime: >-
            {%- from 'get_solar_forecast.jinja' import get_last_solar_generation %}
            {{ get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', 0.01) }}
          last_generation_kwh: >-
            {%- from 'get_solar_forecast.jinja' import get_last_solar_generation %}
            {{ get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'pv_estimate', 'pv_estimate', 0.01) }}
      - variables:
          forecast_text: >-
            {%- from 'emoji.jinja' import get_weather -%}
            Tomorrows ({{ (as_timestamp(now()) - (24*3600)) | timestamp_custom('%Y-%m-%d', True) }})
            weather is {{ get_weather(solar_forecast_data.weather_condition, 'Slack') }} with a generation of
            {{ solar_forecast_data.generation_forecast|float(0)|round(2) }}
            {{ solar_forecast_data.generation_forecast_unit_of_measurement }}
            {#- If Solcast is unavailable, fallback to Forecast.io -#}
            {% if states('sensor.solcast_pv_forecast_forecast_tomorrow') not in ('unavailable', 'unknown') %}
            {%- from 'get_solar_forecast.jinja' import get_first_solar_generation, get_last_solar_generation %}
            and will start at {{ as_timestamp(start_generation_datetime)|timestamp_custom('%H:%M:%S') }}
            ({{ start_generation_kwh|float(0)|round(2) }} kWh).

            {%- if self_sustaining_generation_kwh|float(-1) != -1 %}
            The first self sustaining generation ({{ avg_hourly_energy_usage }} kWh) will occur at
            {{ as_timestamp(self_sustaining_generation_datetime)|timestamp_custom('%H:%M:%S') }}
            ({{ self_sustaining_generation_kwh|round(2) }} kWh).
            {%- endif %}

            {%- if last_self_sustaining_generation_kwh|float(-1) != -1 %}


            The last self sustaining generation of the day will be at
            {{ as_timestamp(last_self_sustaining_generation_datetime)|timestamp_custom('%H:%M:%S') }}
            ({{ last_self_sustaining_generation_kwh|round(2) }} kWh)
            finishing at
            {{ as_timestamp(last_generation_datetime)|timestamp_custom('%H:%M:%S') }}
            ({{ last_generation_kwh|round(2) }} kWh).
            {%- elif get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', 0.01) is not none %}


            The last generation of the day will be at
            {{ as_timestamp(get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', 0.01))|timestamp_custom('%H:%M:%S') }}
            ({{ get_last_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'pv_estimate', 'pv_estimate', 0.01)|round(2) }} kWh).
            {%- endif %}
            {%- else -%}
            {{ states('sensor.total_solar_forecast_estimated_energy_production_tomorrow')|float(0)|round(2) }}
            {{ state_attr('sensor.total_solar_forecast_estimated_energy_production_tomorrow','unit_of_measurement') }}.
            {%- endif %}
      - action: script.send_direct_notification
        data:
          message: >-
            {{ forecast_text }}


            The battery is {{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }} charged. The household load is
            {{ states('sensor.growatt_sph_load_power')|float(-1)|round(2) }} {{ state_attr('sensor.growatt_sph_load_power', 'unit_of_measurement') }}
            with an estimated run time of
            {{ as_timestamp(states('sensor.battery_charge_remaining_hours'))|timestamp_custom('%Y-%m-%d %H:%M:%S') }} ({{ state_attr('sensor.battery_charge_remaining_hours', 'duration') }}).


            Charge :house_with_garden:ðŸ”‹ battery to
            {{ solar_forecast_data.estimate_charge_percentage }}%
            ({{ solar_forecast_data.estimate_charge_kwh }} kWh).
            Charge time is {{ solar_forecast_data.charge_hours }} ({{ solar_forecast_data.charge_hours_rounded }}) hours
            ({{ (solar_forecast_data.charge_hours_rounded*2) }} slots).


            {%- if states('input_select.home_mode')|lower == 'holiday' %}
            Using daily average: {{ states('sensor.home_electricity_power_daily_average_over_a_day')|float(1) }}
            {%- endif %}
          title: ":sunny: :zap: Solar"
          people:
            entity_id:
              - person.danny
              - person.terina
  remaining_solar_forecast_today:
    alias: Remaining Solar Forecast Today
    variables:
      remaining: >-
        {
          'value':{{ (states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0) - states('sensor.growatt_sph_pv_energy')|float(0))|round(2) }},
          'unit_of_measurement': '{{ state_attr('sensor.growatt_sph_pv_energy', 'unit_of_measurement') }}'
        }
    sequence:
      - stop: End
        response_variable: remaining
  get_first_solar_generation:
    alias: Get First Solar Generation
    fields:
      forecast_entity:
        description: The entity ID that has the forecast as an attribute.
        example: sensor.solcast_pv_forecast_forecast_tomorrow
        default: sensor.solcast_pv_forecast_forecast_tomorrow
        required: true
        selector:
          text:
      attribute_name:
        description: Attribute name containing the list of forecast information.
        example: detailedForecast
        default: detailedForecast
        required: true
        selector:
          text:
      get_attribute:
        description: Attribute name of the value to return.
        example: period_start
        required: true
        selector:
          text:
      generation_attribute_name:
        description: Name of attribute containing the kWh generation.
        example: pv_estimate
        selector:
          text:
      min_generation:
        description: >-
          (Optional) first occurrence above specified kWh.
          If not set then the first hour with any generation will be returned.
        selector:
          number:
            min: 0
            max: 50
            step: 0.01
            unit_of_measurement: kWh
    variables:
      solar: >-
        {%- set forecast = namespace(value=[]) -%}
        {%- for period in state_attr(forecast_entity, attribute_name) -%}
        {%- if period.get(generation_attribute_name|default('pv_estimate', true)) > min_generation|default(0, true) -%}
        {%- set forecast.value = period.get(get_attribute) -%}
        {%- break -%}
        {%- endif -%}
        {%- endfor -%}
        {#- If no results were found, return none -#}
        {%- if get_attribute == 'pv_estimate' -%}
        {{
        {
        'forecast': forecast.value|default(none, true)
        }
        }}
        {%- else -%}
        {{
        {
        'forecast': ""~forecast.value|default(none, true)~""
        }
        }}
        {%- endif -%}
    sequence:
      - stop: End
        response_variable: solar
  get_last_solar_generation:
    alias: Get Last Solar Generation
    fields:
      forecast_entity:
        description: The entity ID that has the forecast as an attribute.
        example: sensor.solcast_pv_forecast_forecast_tomorrow
        default: sensor.solcast_pv_forecast_forecast_tomorrow
        required: true
      attribute_name:
        description: Attribute name containing the list of forecast information.
        example: detailedForecast
        default: detailedForecast
        required: true
      get_attribute:
        description: Attribute name of the value to return.
        example: period_start
        required: true
      generation_attribute_name:
        description: Name of attribute containing the kWh generation.
        example: pv_estimate
      min_generation:
        description: >-
          (Optional) first occurrence above specified kWh.
          If not set then the first hour with any generation will be returned.
    variables:
      solar: >-
        {%- set forecast = namespace(value=[]) -%}
        {%- for period in state_attr(forecast_entity, attribute_name)|reverse -%}
        {%- if period.get(generation_attribute_name) > min_generation|default(0, true) -%}
        {%- set forecast.value = period.get(get_attribute) -%}
        {%- break -%}
        {%- endif -%}
        {%- endfor -%}
        {#- If no results were found, return none -#}
        {%- if get_attribute == 'pv_estimate' -%}
        {{
        {
        'forecast': forecast.value|default(none, true)
        }
        }}
        {%- else -%}
        {{
        {
        'forecast': ""~forecast.value|default(none, true)~""
        }
        }}
        {%- endif -%}
    sequence:
      - stop: End
        response_variable: solar
  energy_notify_excess_solar:
    alias: Energy Notify Excess Solar
    variables:
      people_home: "{% set people = namespace(home=[]) %}
        {% for p in state_attr('group.adult_people', 'entity_id')|default([]) %}
        {% if states(p) == 'home' %}
        {% set people.home = people.home + [p] %}
        {% endif %}
        {% endfor %}
        {{ people.home }}"
      message: >-
        ðŸ”‹ Battery charged to
        ({{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}).
        {% if ((states('sensor.growatt_battery_charge_power')|float(0)) > 0) and
        state_attr('sensor.time_to_charge_battery', 'time_remaining') is not none %}
        It will take around {{ state_attr('sensor.time_to_charge_battery', 'time_remaining') }}
        to charge the battery.
        {% endif %}
        It's estimated to produce
        {{ states('sensor.total_solar_forecast_estimated_energy_production_next_hour', with_unit=True) }}
        in the next hour.

        {% if states('sensor.total_solar_forecast_estimated_energy_production_today') %}
        There's {{ states('sensor.solcast_pv_forecast_forecast_remaining_today', with_unit=True) }} remaining.
        {% elif (states('sensor.growatt_sph_pv_energy')|float(0))|round(2) < (states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0)) %}


        There's approximately
        {{ ((states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0)) -
        (states('sensor.growatt_sph_pv_energy')|float(0)))|round(2) }}
        (out of {{ (states('sensor.total_solar_forecast_estimated_energy_production_today')|float(0))|round(2) }})
        {{ state_attr('sensor.total_solar_forecast_estimated_energy_production_today', 'unit_of_measurement') }}
        to be produced to the end of the day ({{ as_timestamp(state_attr('sun.sun','next_setting')) | timestamp_custom('%H:%M') }}).
        {% endif %}
      title: ":sunny: :zap: Solar"
    sequence:
      - if:
          - condition: template
            value_template: "{{ (people_home|default([]))|length > 0 }}"
        then:
          - action: script.send_direct_notification
            data:
              message: "{{ message }}"
              title: ":sunny: :zap: :electric_plug: Solar"
              people:
                entity_id: "{{ people_home }}"
        else:
          - action: script.send_to_home_log
            data:
              message: "{{ message }}"
              title: ":sunny: :zap: :electric_plug: Solar"
              log_level: "Normal"
    mode: single
    icon: mdi:solar-power

template:
  - trigger:
      - trigger: state
        entity_id:
          - sensor.house_power
          - sensor.smart_meter_electricity_power
    sensor:
      - name: "Grid Power"
        unique_id: e697ba51-edd8-40cd-b797-ee79786c0415
        state: >-
          {%- if states('sensor.house_power')|is_number -%}
            {{ states('sensor.house_power')|float(0) }}
          {%- elif states('sensor.smart_meter_electricity_power')|is_number -%}
            {{ states('sensor.smart_meter_electricity_power')|float(0)*1000 }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.house_power')|is_number or states('sensor.smart_meter_electricity_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
  - trigger:
      - trigger: state
        entity_id:
          - sensor.house_power
          - sensor.smart_meter_electricity_power
    sensor:
      - name: "Grid Import Power"
        unique_id: 09f48f73-ea68-421f-868c-ffd20cd8eab8
        state: >-
          {%- if states('sensor.house_power')|float(0) > 0 -%}
            {{ states('sensor.house_power')|float(0) }}
          {%- elif states('sensor.smart_meter_electricity_power')|float(0) > 0 -%}
            {{ states('sensor.smart_meter_electricity_power')|float(0) }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.house_power')|is_number or states('sensor.smart_meter_electricity_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - trigger: state
        entity_id:
          - sensor.house_power
          - sensor.smart_meter_electricity_power
    sensor:
      - name: "Grid Export Power"
        unique_id: ed52b9f5-fddd-4797-85a1-b4fb6df8cd0e
        state: >-
          {% if states('sensor.house_power')|float(0) < 0 -%}
            {{ states('sensor.house_power')|float(0)|abs }}
          {%- elif states('sensor.smart_meter_electricity_power')|float(0) < 0 -%}
            {{ states('sensor.smart_meter_electricity_power')|float(0)|abs }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.house_power')|is_number or states('sensor.smart_meter_electricity_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - trigger: state
        entity_id:
          - input_number.cut_out_fuse_size
    sensor:
      - name: "Grid Amp Import Warning"
        unique_id: 02d4ee4e-967f-4b1a-80c1-a2b9dca61d01
        state: >-
          {{ states('input_number.cut_out_fuse_size')|float(100) * 0.9 }}
        availability: "{{ states('input_number.cut_out_fuse_size')|is_number }}"
        icon: mdi:fuse-alert
        unit_of_measurement: "A"
