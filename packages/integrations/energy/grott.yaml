# Created by Danny Tsang <danny@tsang.uk>
mqtt:
  sensor:
    # Example from: https://github.com/johanmeijer/grott/blob/master/examples/Home%20Assistent/sensors_growatt_eng.yaml
    # Reference MQTT keys: https://github.com/johanmeijer/grott/wiki/MQTT
    - state_topic: energy/growatt
      value_template: "{{ value_json['device'] }}"
      unique_id: growatt_serial
      name: Growatt - Serial number
      icon: mdi:select-inverse
    - state_topic: energy/growatt
      value_template: "{{ as_timestamp(strptime(value_json['time'], '%Y-%m-%dT%H:%M:%S')) | timestamp_custom('%Y-%m-%d') }}"
      unique_id: growatt_date
      device_class: date
      name: Growatt - Date
      icon: mdi:calendar
    - state_topic: energy/growatt
      value_template: "{{ as_timestamp(strptime(value_json['time'], '%Y-%m-%dT%H:%M:%S')) | timestamp_custom('%H:%M:%S') }}"
      unique_id: growatt_time
      name: Growatt - Time
      icon: mdi:clock-digital
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['totworktime'] | int / 2 }}"
      unique_id: growatt_working_time
      unit_of_measurement: "s"
      name: Growatt - Working Time
    - state_topic: energy/growatt
      value_template: >
        {% if (value_json['values']['pvstatus'] | int == 0) %}
          Waiting
        {% elif (value_json['values']['pvstatus'] | int == 1) %}
          Normal
        {% elif (value_json['values']['pvstatus'] | int == 2) %}
          Fault
        {% else %}
          Unknown ({{ value_json['values']['pvstatus'] }})
        {% endif %}
      unique_id: growatt_status
      name: Growatt - State
      icon: mdi:power-settings
    - state_topic: energy/growatt
      value_template: >
        {% if (value_json['values']['uwsysworkmode'] | int == 0) %}
          Waiting
        {% elif (value_json['values']['uwsysworkmode'] | int == 1) %}
          Self-test
        {% elif (value_json['values']['uwsysworkmode'] | int == 3) %}
          Fault
        {% elif (value_json['values']['uwsysworkmode'] | int == 4) %}
          Flash
        {% elif (value_json['values']['uwsysworkmode'] | int == 5) %}
          Normal
        {% elif (value_json['values']['uwsysworkmode'] | int == 6) %}
          Battery Online
        {% elif (value_json['values']['uwsysworkmode'] | int == 7) %}
          PV Offline
        {% elif (value_json['values']['uwsysworkmode'] | int == 6) %}
          Battery Offline
        {% else %}
          Unknown ({{ value_json['values']['uwsysworkmode'] }})
        {% endif %}
      unique_id: growatt_system_work_mode
      name: Growatt - System Work Mode
      icon: mdi:power-settings
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['systemfaultword0'] }}"
      unique_id: growatt_system_fault_0
      name: Growatt - System Fault 0
      icon: mdi:flash-alert
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['systemfaultword1'] }}"
      unique_id: growatt_system_fault_1
      name: Growatt - System Fault 1
      icon: mdi:flash-alert
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['systemfaultword2'] }}"
      unique_id: growatt_system_fault_2
      name: Growatt - System Fault 2
      icon: mdi:flash-alert
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['systemfaultword3'] }}"
      unique_id: growatt_system_fault_3
      name: Growatt - System Fault 3
      icon: mdi:flash-alert
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['systemfaultword4'] }}"
      unique_id: growatt_system_fault_4
      name: Growatt - System Fault 4
      icon: mdi:flash-alert
    - state_topic: energy/growatt
      value_template: "{{ value_json['buffered'] }}"
      unique_id: growatt_buffered
      name: Growatt - Buffered
      icon: mdi:cached

    # Usage
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['plocaloadr'] | float / 10000 }}"
      unique_id: growatt_load
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Load Consumption
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['elocalload_tod'] | float / 10 }}"
      unique_id: growatt_load_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - Load Consumption Today
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['elocalload_tot'] | float / 10 }}"
      unique_id: growatt_load_lifetime
      device_class: energy
      unit_of_measurement: "kWh"
      state_class: total
      name: Growatt - Load Consumption Lifetime

    # Export
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pactogridr'] | float / 10000 }}"
      unique_id: growatt_export
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Export To Grid
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['etogrid_tod'] | float / 10 }}"
      unique_id: growatt_export_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - Export To Grid Today
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['etogrid_tot'] | float / 10 }}"
      unique_id: growatt_export_lifetime
      device_class: energy
      unit_of_measurement: "kWh"
      state_class: total
      name: Growatt - Export To Grid Lifetime

    # String 1 (Back)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv1watt'] | float / 10000 }}"
      unique_id: growatt_string1_watt
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - String 1 (Watt)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv1voltage'] | float / 10 }}"
      unique_id: growatt_string1_voltage
      device_class: voltage
      unit_of_measurement: "V"
      name: Growatt - String 1 (Voltage)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv1current'] | float / 10 }}"
      unique_id: growatt_string1_current
      device_class: current
      unit_of_measurement: "A"
      name: Growatt - String 1 (Current)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['epv1today'] | float / 10 }}"
      unique_id: growatt_string1_generated_energy_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - String 1 Generated Today
      icon: mdi:solar-power
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['epv1total'] | float / 10 }}"
      unique_id: growatt_string1_generated_energy_total
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - String 1 Generated energy (Total)
      icon: mdi:solar-power

    # String 2 (Front)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv2watt'] | float / 10000 }}"
      unique_id: growatt_string2_watt
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - String 2 (Watt)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv2voltage'] | float / 10 }}"
      unique_id: growatt_string2_voltage
      device_class: voltage
      unit_of_measurement: "V"
      name: Growatt - String 2 (Voltage)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pv2current'] | float / 10 }}"
      unique_id: growatt_string2_current
      device_class: current
      unit_of_measurement: "A"
      name: Growatt - String 2 (Current)
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['epv2today'] | float / 10 }}"
      unique_id: growatt_string2_generated_energy_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - String 2 Generated Today
      icon: mdi:solar-power
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['epv2total'] | float / 10 }}"
      unique_id: growatt_string2_generated_energy_total
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - String 2 Generated energy (Total)
      icon: mdi:solar-power

    # Solar Total
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['epvtotal'] | float / 10 }}"
      unique_id: growatt_total_solar_generated_energy_lifetime
      device_class: energy
      unit_of_measurement: "kWh"
      state_class: total
      name: Growatt - Solar Generated Energy Lifetime
      icon: mdi:solar-power
      # Solar + Battery
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvenergytoday'] | float / 10 }}"
      unique_id: growatt_self_generated_energy_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - Self Generated Energy Today
      icon: mdi:solar-power
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvpowerin'] | float / 10000 }}"
      unique_id: growatt_input_power
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Input watt
      icon: mdi:solar-power
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvpowerout'] | float / 10000 }}"
      unique_id: growatt_output_power
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Solar Generation
      icon: mdi:solar-power

    # Grid
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pactouserr'] | float / 10000 }}"
      unique_id: growatt_grid_import
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Grid Import
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvgridpower'] | float / 10000 }}"
      unique_id: growatt_grid_phase_voltage_watts
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Grid Phase Power
      icon: mdi:flash
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvgridvoltage'] | float / 10 }}"
      unique_id: growatt_grid_phase_voltage
      device_class: voltage
      unit_of_measurement: "V"
      name: Growatt - Grid Phase Power
      icon: mdi:flash
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvgridcurrent'] | float }}"
      unique_id: growatt_grid_phase_current
      device_class: current
      unit_of_measurement: "A"
      name: Growatt - Grid Phase Current
      icon: mdi:flash
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvfrequentie'] | float /100 }}"
      unique_id: growatt_grid_phase_frequency
      device_class: frequency
      unit_of_measurement: "Hz"
      name: Growatt - Grid Phase Frequency
      icon: mdi:waveform

    # Temperatures
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvtemperature'] | float / 10 }}"
      unique_id: growatt_inverer_temperature
      device_class: temperature
      unit_of_measurement: "°C"
      name: Growatt - Inverter temperature
    # Inside inverter temperature
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pvipmtemperature'] | float / 10 }}"
      unique_id: growatt_ipm_temperature
      device_class: temperature
      unit_of_measurement: "°C"
      name: Growatt - IPM temperature

    # Battery 1
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['SOC'] | int }}"
      unique_id: growatt_battery_soc
      device_class: battery
      unit_of_measurement: "%"
      name: Growatt - Battery 1 State of Charge
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['p1charge1'] | float / 10000 }}"
      unique_id: growatt_battery_charge_rate
      device_class: power
      unit_of_measurement: "kW"
      name: Growatt - Battery 1 Charge Rate
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['eharge1_tod'] | float / 10 }}"
      unique_id: growatt_battery_charged_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - Battery 1 Charged Today
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['eharge1_tot'] | float / 10 }}"
      unique_id: growatt_battery_charged_lifetime
      device_class: energy
      unit_of_measurement: "kWh"
      state_class: total
      name: Growatt - Battery 1 Charged Lifetime
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['pdischarge1'] | float / 10000 }}"
      unique_id: growatt_battery_discharge_rate
      device_class: power
      state_class: total
      unit_of_measurement: "kW"
      name: Growatt - Battery 1 Discharged Rate
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['edischarge1_tod'] | float / 10 }}"
      unique_id: growatt_battery_discharged_today
      device_class: energy
      unit_of_measurement: "kWh"
      name: Growatt - Battery 1 Discharged Today
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['edischarge1_tot'] | float / 10 }}"
      unique_id: growatt_battery_discharged_lifetime
      device_class: energy
      unit_of_measurement: "kWh"
      state_class: total
      name: Growatt - Battery 1 Discharged Lifetime
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['vbat'] | float / 10 }}"
      unique_id: growatt_battery_voltage
      device_class: voltage
      unit_of_measurement: "V"
      name: Growatt - Battery 1 Voltage
    # Miscellaneous
    - state_topic: energy/growatt
      value_template: "{{ value_json['values']['spbusvolt'] | float / 1000 }}"
      unique_id: growatt_bus_voltage
      device_class: voltage
      unit_of_measurement: "V"
      name: Growatt - Bus Voltage

sensor:
  - platform: statistics
    name: "Home Electricity Power Daily Average Over An Hour"
    entity_id: sensor.growatt_load_consumption
    state_characteristic: mean
    max_age:
      hours: 1
  - platform: statistics
    name: "Home Electricity Power Daily Average Over A Day"
    entity_id: sensor.growatt_load_consumption
    state_characteristic: mean
    max_age:
      hours: 24
  - platform: statistics
    name: "Home Electricity Power Daily Average Over A Week"
    entity_id: sensor.growatt_load_consumption
    state_characteristic: mean
    max_age:
      days: 7

template:
  # Grott
  - trigger:
      - platform: state
        entity_id:
          - input_number.growatt_battery_discharge_stop_soc
          - sensor.growatt_battery_1_state_of_charge
    sensor:
      - name: "Usable Battery State of Charge"
        unique_id: a681cc96-bfb5-407c-bc9d-d93f4a0f854f
        state: "{{ ((states('sensor.growatt_battery_1_state_of_charge')|float(0)) - (states('input_number.growatt_battery_discharge_stop_soc')|float(0)))/100 }}"
        attributes:
          discharge_stop_soc: >-
            {{ states('input_number.growatt_battery_discharge_stop_soc') }}
          soc: >-
            {{ states('sensor.growatt_battery_1_state_of_charge') }}
        device_class: "battery"
        unit_of_measurement: "%"
  - trigger:
      - platform: state
        entity_id:
          - input_number.solar_battery_size
          - sensor.growatt_load_consumption
          - sensor.usable_battery_state_of_charge
    sensor:
      - name: "Battery Run Time"
        unique_id: c5955655-eb91-4bd7-9f8f-afc4e4f0c58c
        # Formula:
        # (Battery Size x useable charge remaining) / current usage = kWh remaining
        state: "{{ now() + timedelta( seconds = (((states('input_number.solar_battery_size')|float(0) * states('sensor.usable_battery_state_of_charge')|float(0)) / (states('sensor.growatt_load_consumption')|replace('0','1')|float(1))) * 60 * 60)|round(0)) }}"
        icon: mdi:battery-clock-outline
        attributes:
          duration: >-
            {% set ts = (((states('input_number.solar_battery_size')|float(0) * states('sensor.usable_battery_state_of_charge')|float(0)) / (states('sensor.growatt_load_consumption')|replace('0','1')|float(1))) * 60 * 60)|round(0) %}
            {{ '{:02d}:{:02d}:{:02d}'.format(ts // 3600, (ts % 3600) // 60, (ts % 3600) % 60) }}
        device_class: "timestamp"
  - trigger:
      - platform: state
        entity_id:
          - input_number.solar_battery_size
          - sensor.growatt_battery_1_charge_rate
          - sensor.growatt_battery_1_state_of_charge
    sensor:
      - name: "Time To Charge Battery"
        unique_id: 78ea1413-0d1c-4b89-b109-c961fc30f84d
        # 359999 seconds = 99:99:99 suration (H:M:S)
        state: "{{ now() + timedelta( seconds = (((((states('input_number.solar_battery_size')|float(0)) * (1 - (states('sensor.growatt_battery_1_state_of_charge')|float(0)/100))) /([states('sensor.growatt_battery_1_charge_rate')|float(1),1]|max|float(1)))*60*60)|round(0)) if (states('sensor.growatt_battery_1_charge_rate')|float(0)) != 0 else 359999) }}"
        icon: mdi:battery-clock
        attributes:
          duration: >-
            {% set ts = (((((states('input_number.solar_battery_size')|float(0)) * (1 - (states('sensor.growatt_battery_1_state_of_charge')|float(0)/100))) /([states('sensor.growatt_battery_1_charge_rate')|float(1),1]|max|float(1)))*60*60)|round(0)) if (states('sensor.growatt_battery_1_charge_rate')|float(0)) != 0 else 359999 %}
            {{ '{:02d}:{:02d}:{:02d}'.format(ts // 3600, (ts % 3600) // 60, (ts % 3600) % 60) }}
        device_class: "timestamp"
