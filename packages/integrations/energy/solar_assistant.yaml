# Created by Danny Tsang <danny@tsang.uk>
automation:
  # Unit rate related automations
  - id: "1691009694611"
    alias: "Solar Assistant: Check Electricity Rates"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.electricity_current_rate
        below: sensor.electricity_export_current_rate
      - platform: state
        entity_id: sensor.electricity_current_rate
        to: sensor.electricity_export_current_rate
      - platform: numeric_state
        entity_id: sensor.electricity_current_rate
        below: 0
      - platform: state
        entity_id: sensor.electricity_current_rate
        to: "0"
      - platform: time_pattern
        minutes: "5"
      - platform: time_pattern
        minutes: "35"
      - platform: homeassistant
        event: start
    condition:
      - condition: state
        entity_id: input_boolean.enable_solar_assistant_automations
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.enable_home_battery_start_charge_time
                state: "on"
              - condition: time
                before: input_datetime.home_battery_start_charge_time
            sequence:
              - service: script.send_direct_notification
                data:
                  message: >-
                    Electrictity rate
                    ({{ states('sensor.electricity_current_rate', with_unit=True) }}) has fallen
                    below export ({{ states('sensor.electricity_export_current_rate', with_unit=True) }}).
                    but before schedule charge
                    ({{ states('input_datetime.home_battery_start_charge_time', with_unit=True) }}).
                    Skipping.
                  title: Solar Assistant
                  people:
                    entity_id:
                      - person.danny
        default:
          - parallel:
              - if:
                  - condition: state
                    entity_id: input_boolean.enable_home_battery_start_charge_time
                    state: "on"
                  - condition: time
                    after: input_datetime.home_battery_start_charge_time
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.enable_home_battery_start_charge_time
                    data: {}
              - service: script.solar_assistant_check_charging_mode
                data:
                  event: "event"
    mode: single
  - id: "1689626117481"
    alias: "Solar Assistant: Electricity Rates Starts To Cost"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.electricity_current_rate
        above: 0
      - platform: numeric_state
        entity_id: sensor.electricity_current_rate
        above: sensor.electricity_export_current_rate
    condition:
      - condition: state
        entity_id: input_boolean.enable_solar_assistant_automations
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.electricity_current_rate
                below: sensor.electricity_export_current_rate
            sequence:
              - service: script.send_to_home_log
                data:
                  message: >-
                    Electrictity rate has gove above 0
                    ({{ states('sensor.electricity_current_rate', with_unit=True) }})p/kw
                    but below export
                    ({{ states('sensor.electricity_export_current_rate', with_unit=True) }}).
                    Keeping house battery charged.
                  title: Solar Assistant
                  log_level: "Debug"
        default:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: >-
                    Electrictity rate has gove above 0
                    ({{ states('sensor.electricity_current_rate', with_unit=True) }})p/kw.
                  title: Solar Assistant
                  log_level: "Debug"
              - service: script.load_first_priority_mode
                data: {}
    mode: single

script:
  battery_first_priority_mode:
    alias: Solar Assistant Battery First Priority Mode
    description: ""
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Battery first
        then:
          - service: script.send_to_home_log
            data:
              message: >-
                Priority is already set to battery first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - service: script.send_to_home_log
            data:
              message: >-
                Setting priority from {{ states('select.growatt_sph_work_mode_priority') }}
                to battery first.
              title: Solar Assistant
              log_level: "Debug"
          - alias: Make sure inverter mode schedules are turned off
            service: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to battery first
            service: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Battery first
    mode: single
  grid_first_priority_mode:
    alias: Solar Assistant Gird First Priority Mode
    description: ""
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Grid first
        then:
          - service: script.send_to_home_log
            data:
              message: >-
                Priority is already set to grid first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - if:
              - not:
                  - condition: state
                    entity_id: select.myenergi_eddi_operating_mode
                    state: "Stopped"
            then:
              - service: script.send_direct_notification
                data:
                  message: >-
                    Setting priority from {{ states('select.growatt_sph_work_mode_priority') }}
                    to grid first. FYI eddi is still on.
                  title: Solar Assistant
                  people:
                    entity_id:
                      - person.danny
            else:
              - service: script.send_to_home_log
                data:
                  message: >-
                    Setting priority from {{ states('select.growatt_sph_work_mode_priority') }}
                    to grid first.
                  title: Solar Assistant
                  log_level: "Debug"
          - alias: Make sure inverter mode schedules are turned off
            service: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to export first
            service: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Gird first
    mode: single
  load_first_priority_mode:
    alias: Solar Assistant Load First Priority Mode
    description: >-
      Disable battery first schedule which is automatically
      set when changing work mode to battery first.
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Load first
          - condition: state
            entity_id: switch.growatt_sph_battery_first_slot_1_enabled
            state: "off"
          - condition: state
            entity_id: switch.growatt_sph_grid_first_slot_1_enabled
            state: "off"
        then:
          - service: script.send_to_home_log
            data:
              message: >-
                Priority is already set to load first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - service: script.send_to_home_log
            data:
              message: >-
                Setting priority from {{ states('select.growatt_sph_work_mode_priority') }}
                to load first.
              title: Solar Assistant
              log_level: "Debug"
          - alias: Make sure inverter mode schedules are turned off
            service: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to load first
            service: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Load first
    mode: single
  solar_assistant_turn_off_mode_schedules:
    alias: Solar Assistant Turn Off Mode Schedules
    description: >-
      Disable battery first schedule which is automatically
      set when changing work mode to battery first.
    sequence:
      - parallel:
          - repeat:
              sequence:
                - service: switch.turn_off
                  target:
                    entity_id: switch.growatt_sph_battery_first_slot_1_enabled
                  data: {}
                - delay:
                    seconds: 5
              until:
                - condition: state
                  entity_id: switch.growatt_sph_battery_first_slot_1_enabled
                  state: "off"
                  for:
                    seconds: 30
          - repeat:
              sequence:
                - service: switch.turn_off
                  target:
                    entity_id: switch.growatt_sph_grid_first_slot_1_enabled
                  data: {}
                - delay:
                    seconds: 5
              until:
                - condition: state
                  entity_id: switch.growatt_sph_grid_first_slot_1_enabled
                  state: "off"
                  for:
                    seconds: 30
    mode: single
  maintain_battery_soc:
    alias: Solar Assistant Maintain Battery SOC
    description: ""
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Battery first
        then:
          - service: script.send_to_home_log
            data:
              message: >-
                Priority is already set to battery first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - service: script.send_to_home_log
            data:
              message: >-
                Setting priority from {{ states('select.growatt_sph_work_mode_priority') }}
                to battery first.
              title: Solar Assistant
              log_level: "Debug"
          - alias: Set battery stop charging %
            service: number.set_value
            target:
              entity_id: number.growatt_sph_battery_first_stop_charge
            data:
              value: "{{ state('sensor.growatt_sph_battery_state_of_charge')|float(100) }}"
          - alias: Make sure inverter mode schedules are turned off
            service: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to battery first
            service: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Battery first
    mode: single
  solar_assistant_check_charging_mode:
    alias: Solar Assistant Check Charging Mode
    description: ""
    fields:
      event:
        description: The trigger for running a electricity rate check.
        example: time
        required: true
        selector:
          select:
            options:
              - event
              - time
    sequence:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.electricity_current_rate
                above: sensor.electricity_export_current_rate
              - not:
                  - condition: state
                    entity_id: select.growatt_sph_work_mode_priority
                    state: Load first
              - condition: template
                value_template: "{{ event == 'time'}}"
            sequence:
              - parallel:
                  - service: script.send_direct_notification
                    data:
                      message: >-
                        Electrictity rate has gove above 0
                        ({{ states('sensor.electricity_current_rate', with_unit=True) }})p/kw
                        and inverter has not switched from
                        {{ states('select.growatt_sph_work_mode_priority') }} to load first mode.
                      title: Solar Assistant
                      people:
                        entity_id:
                          - person.danny
                  - service: script.load_first_priority_mode
                    data: {}
          - conditions:
              - or:
                  - condition: state
                    entity_id: sensor.electricity_current_rate
                    state: "0"
                  - condition: numeric_state
                    entity_id: sensor.electricity_current_rate
                    below: 0
              - not:
                  - condition: state
                    entity_id: select.growatt_sph_work_mode_priority
                    state: Battery first
              - condition: state
                entity_id: input_boolean.solar_assistant_charge_electricity_cost_nothing
                state: "on"
            sequence:
              - parallel:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ event == 'time'}}"
                        sequence:
                          - service: script.send_direct_notification
                            data:
                              message: >-
                                Electrictity rate has gove above 0
                                ({{ states('sensor.electricity_current_rate', with_unit=True) }})p/kw
                                and inverter has not switched from
                                {{ states('select.growatt_sph_work_mode_priority') }} to load first mode.
                              title: Solar Assistant
                              people:
                                entity_id:
                                  - person.danny
                    default:
                      - service: script.send_direct_notification
                        data:
                          message: >-
                            Electrictity rate
                            ({{ states('sensor.electricity_current_rate', with_unit=True) }}) has fallen
                            below £0.00 ({{ states('sensor.electricity_export_current_rate', with_unit=True) }}).
                            Charging house battery.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                  - service: script.battery_first_priority_mode
                    data: {}
          - conditions:
              - condition: numeric_state
                entity_id: sensor.electricity_current_rate
                below: sensor.electricity_export_current_rate
              - not:
                  - condition: state
                    entity_id: select.growatt_sph_work_mode_priority
                    state: Battery first
              - condition: state
                entity_id: input_boolean.solar_assistant_charge_below_export
                state: "on"
            sequence:
              - parallel:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ event == 'time'}}"
                        sequence:
                          - service: script.send_direct_notification
                            data:
                              message: >-
                                Electrictity rate
                                ({{ states('sensor.electricity_current_rate', with_unit=True) }}) has fallen
                                below £0.00 ({{ states('sensor.electricity_export_current_rate', with_unit=True) }})
                                and inverter has not switched to battery first mode.
                              title: Solar Assistant
                              people:
                                entity_id:
                                  - person.danny
                    default:
                      - service: script.send_direct_notification
                        data:
                          message: >-
                            Electricity unit rate is the
                            {{ iif(states('sensor.electricity_current_rate')|float(0) < states('sensor.electricity_export_current_rate')|float(0), 'below', 'same') }}
                            export rate
                            ({{ states('sensor.electricity_current_rate') ~'<=' ~
                            states('sensor.electricity_export_current_rate') }}). Charging house battery.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                  - service: script.battery_first_priority_mode
                    data: {}
        default: []
    mode: single

template:
  # Solar Assistant
  - trigger:
      - platform: state
        entity_id:
          - sensor.growatt_sph_battery_power
    sensor:
      - name: "Growatt Battery Discharge Power"
        unique_id: 251bd989-90a2-4e1b-81d0-b6d87f934eeb
        state: >-
          {{ iif(states('sensor.growatt_sph_battery_power')|float(0) < 0, states('sensor.growatt_sph_battery_power')|float(0)|abs, 0) }}
        availability: "{{ states('sensor.growatt_sph_battery_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - platform: state
        entity_id:
          - sensor.growatt_sph_battery_power
    sensor:
      - name: "Growatt Battery Charge Power"
        unique_id: fe4f9f9c-4a61-4b27-9122-9c17ce5da164
        state: >-
          {% if states('sensor.growatt_sph_battery_power')|float(0) > 0 -%}
            {{ states('sensor.growatt_sph_battery_power')|float(0) }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.growatt_sph_battery_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - platform: state
        entity_id:
          - sensor.growatt_sph_grid_power
    sensor:
      - name: "Growatt Grid Import Power"
        unique_id: 09f48f73-ea68-421f-868c-ffd20cd8eab8
        state: >-
          {%- if states('sensor.growatt_sph_grid_power')|float(0) > 0 -%}
            {{ states('sensor.growatt_sph_grid_power')|float(0) }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.growatt_sph_grid_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - platform: state
        entity_id:
          - sensor.growatt_sph_grid_power
    sensor:
      - name: "Growatt Grid Export Power"
        unique_id: ed52b9f5-fddd-4797-85a1-b4fb6df8cd0e
        state: >-
          {% if states('sensor.growatt_sph_grid_power')|float(0) < 0 -%}
            {{ states('sensor.growatt_sph_grid_power')|float(0)|abs }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.growatt_sph_grid_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
