# Created by Danny Tsang <danny@tsang.uk>
automation:
  # Unit rate related automations
  - id: "1691009694611"
    alias: "Solar Assistant: Check Solar Mode"
    description: ""
    triggers:
      - trigger: time_pattern
        minutes: "1"
        id: time
      - trigger: time_pattern
        minutes: "5"
        id: time_backup
      - trigger: time_pattern
        minutes: "31"
        id: time
      - trigger: time_pattern
        minutes: "35"
        id: time_backup
    conditions:
      - condition: state
        entity_id: input_boolean.enable_solar_assistant_automations
        state: "on"
      - not:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: "unavailable"
    actions:
      - choose:
          - alias: Rates remain above export
            conditions:
              - condition: trigger
                id:
                  - time
              - condition: numeric_state
                entity_id: sensor.electricity_previous_rate
                above: sensor.electricity_export_current_rate
              - condition: numeric_state
                entity_id: sensor.electricity_current_rate
                above: sensor.electricity_export_current_rate
            sequence:
              - action: script.solar_assistant_check_charging_mode
                data:
                  event: "event"
                  current_electricity_import_rate: "{{ states('sensor.electricity_current_rate') }}"
                  current_electricity_import_rate_unit: "{{ state_attr('sensor.electricity_current_rate', 'unit_of_measurement') }}"
                  current_electricity_export_rate: "{{ states('sensor.electricity_export_current_rate') }}"
        default:
          - choose:
              - conditions:
                  - condition: trigger
                    id: "time_backup"
                sequence:
                  - action: script.solar_assistant_check_charging_mode
                    data:
                      event: "time"
                      current_electricity_import_rate: "{{ states('sensor.electricity_current_rate') }}"
                      current_electricity_import_rate_unit: "{{ state_attr('sensor.electricity_current_rate', 'unit_of_measurement') }}"
                      current_electricity_export_rate: "{{ states('sensor.electricity_export_current_rate') }}"
            default: []
    mode: restart

script:
  battery_first_priority_mode:
    alias: Solar Assistant Battery First Priority Mode
    description: ""
    fields:
      max_charge:
        name: Max Charge
        description: >-
          When battery reaches this charge state,
          it will stop charging and keep it at this level (maintain mode).
        default: 100
        selector:
          number:
            min: 10
            max: 100
            unit_of_measurement: "%"
    sequence:
      - alias: Set battery stop charging %
        action: number.set_value
        target:
          entity_id: number.growatt_sph_battery_first_stop_charge
        data:
          value: >-
            {{ max_charge|default(100, true)|float(100) }}
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Battery first
        then:
          - action: script.send_to_home_log
            data:
              message: >-
                Priority is already set to battery first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - action: script.send_to_home_log
            data:
              message: >-
                Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                to battery first.
              title: Solar Assistant
              log_level: "Debug"
          - alias: Make sure inverter mode schedules are turned off
            action: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to battery first
            action: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Battery first
    mode: single
  grid_first_priority_mode:
    alias: Solar Assistant Grid First Priority Mode
    description: ""
    fields:
      max_discharge:
        name: Max Discharge
        description: >-
          When battery reaches this charge state,
          it will stop exporting and keep it at this level.
        default: 50
        selector:
          number:
            min: 10
            max: 100
            unit_of_measurement: "%"
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Grid first
        then:
          - action: script.send_to_home_log
            data:
              message: >-
                Priority is already set to grid first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          # Do this first so it does not overlap with setting work mode which automatically enable grid schedule 1.
          - alias: Make sure inverter mode schedules are turned off
            action: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - choose:
              - conditions:
                  - not:
                      - condition: state
                        entity_id: select.myenergi_eddi_operating_mode
                        state: "Stopped"
                      - condition: state
                        entity_id: select.myenergi_zappi_charge_mode
                        state: "Stopped"
                      - condition: state
                        entity_id: sensor.myenergi_zappi_plug_status
                        state: EV Disconnected
                sequence:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                            to export(grid) first. Stopping Zappi and Eddi.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                              - person.terina
                      - action: select.select_option
                        data:
                          option: Stopped
                        target:
                          entity_id: select.myenergi_eddi_operating_mode
                      - action: select.select_option
                        data:
                          option: Stopped
                        target:
                          entity_id: select.myenergi_zappi_charge_mode
              - conditions:
                  - not:
                      - condition: state
                        entity_id: select.myenergi_eddi_operating_mode
                        state: "Stopped"
                sequence:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                            to export(grid) first. Stopping Zappi and Eddi.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                              - person.terina
                      - action: select.select_option
                        data:
                          option: Stopped
                        target:
                          entity_id: select.myenergi_eddi_operating_mode
                      - action: select.select_option
                        data:
                          option: Stopped
                        target:
                          entity_id: select.myenergi_zappi_charge_mode
              - conditions:
                  - not:
                      - condition: state
                        entity_id: select.myenergi_zappi_charge_mode
                        state: "Stopped"
                      - condition: state
                        entity_id: sensor.myenergi_zappi_plug_status
                        state: EV Disconnected
                sequence:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                            to export(grid) first and stopping Zappi.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                              - person.terina
                      - action: select.select_option
                        data:
                          option: Stopped
                        target:
                          entity_id: select.myenergi_zappi_charge_mode
            default:
              - action: script.send_to_home_log
                data:
                  message: >-
                    Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                    to grid first.
                  title: Solar Assistant
                  log_level: "Debug"
          - alias: Set stop charge level
            action: number.set_value
            target:
              entity_id: number.growatt_sph_battery_first_stop_charge
            data:
              value: >-
                {{ states('number.growatt_sph_grid_first_stop_discharge')|default(50, true)|float(100) }}
          - alias: Set inverter mode to export first
            action: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Grid first
    mode: single
  load_first_priority_mode:
    alias: Solar Assistant Load First Priority Mode
    description: >-
      Disable battery first schedule which is automatically
      set when changing work mode to battery first.
    sequence:
      - if:
          - condition: state
            entity_id: select.growatt_sph_work_mode_priority
            state: Load first
          - condition: state
            entity_id: switch.growatt_sph_battery_first_slot_1_enabled
            state: "off"
          - condition: state
            entity_id: switch.growatt_sph_grid_first_slot_1_enabled
            state: "off"
        then:
          - action: script.send_to_home_log
            data:
              message: >-
                Priority is already set to load first. Skipping.
              title: Solar Assistant
              log_level: "Normal"
        else:
          - action: script.send_to_home_log
            data:
              message: >-
                Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                to load first.
              title: Solar Assistant
              log_level: "Debug"
          - alias: Make sure inverter mode schedules are turned off
            action: script.solar_assistant_turn_off_mode_schedules
            data: {}
          - alias: Set inverter mode to load first
            action: select.select_option
            target:
              entity_id:
                - select.growatt_sph_work_mode_priority
            data:
              option: Load first
    mode: single
  solar_assistant_turn_off_mode_schedules:
    alias: Solar Assistant Turn Off Mode Schedules
    description: >-
      Disable battery first schedule which is automatically
      set when changing work mode to battery first.
    sequence:
      - parallel:
          - repeat:
              sequence:
                - action: switch.turn_off
                  target:
                    entity_id: switch.growatt_sph_battery_first_slot_1_enabled
                  data: {}
                - delay:
                    seconds: 5
              until:
                - condition: state
                  entity_id: switch.growatt_sph_battery_first_slot_1_enabled
                  state: "off"
                  for:
                    seconds: 30
          - repeat:
              sequence:
                - action: switch.turn_off
                  target:
                    entity_id: switch.growatt_sph_grid_first_slot_1_enabled
                  data: {}
                - delay:
                    seconds: 5
              until:
                - condition: state
                  entity_id: switch.growatt_sph_grid_first_slot_1_enabled
                  state: "off"
                  for:
                    seconds: 30
    mode: single
  maintain_battery_soc:
    alias: Solar Assistant Maintain Battery SOC
    description: "Used in UI"
    sequence:
      - alias: Set battery stop charging %
        action: number.set_value
        target:
          entity_id: number.growatt_sph_battery_first_stop_charge
        data:
          value: "{{ states('sensor.growatt_sph_battery_state_of_charge')|float(100) }}"
      - alias: Make sure inverter mode schedules are turned off
        action: script.solar_assistant_turn_off_mode_schedules
        data: {}
      - if:
          - or:
              - not:
                  - condition: state
                    entity_id: select.growatt_sph_work_mode_priority
                    state: Battery first
              - condition: numeric_state
                entity_id: number.growatt_sph_battery_first_stop_charge
                above: sensor.growatt_sph_battery_state_of_charge
        then:
          - parallel:
              - action: script.send_to_home_log
                data:
                  message: >-
                    Set battery first stop charging to {{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}.
                    Setting priority from {{ states('sensor.growatt_sph_inverter_mode') }}
                    to battery first.
                  title: Solar Assistant
                  log_level: "Debug"
              - alias: Set inverter mode to battery first
                action: script.battery_first_priority_mode
                data:
                  max_charge: "{{ states('sensor.growatt_sph_battery_state_of_charge')|int(100) }}"
        else:
          - action: script.send_to_home_log
            data:
              message: >-
                Set battery first stop charging to {{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}.
                Already in battery first mode.
              title: Solar Assistant
              log_level: "Debug"

    mode: single
  solar_assistant_check_charging_mode:
    alias: Solar Assistant Check Charging Mode
    description: ""
    trace:
      stored_traces: 120
    fields:
      event:
        description: The trigger for running an electricity rate check.
        example: time
        required: true
        selector:
          select:
            options:
              - event
              - time
      current_electricity_import_rate:
        description: Pounds per kiloWatt for importing.
        example: "0.1501"
        selector:
          number:
            min: -15
            max: 100
            step: 2
      current_electricity_import_rate_unit:
        description: Unit describing the unit rate.
        example: "GBP/kWh"
        selector:
          text:
      current_electricity_export_rate:
        description: Pence per kiloWatt for exporting.
        example: "0.15"
        selector:
          number:
            min: 0
            max: 50
            step: 2
      current_electricity_export_rate_unit:
        description: Unit describing the unit rate.
        example: "GBP/kWh"
        selector:
          text:
    sequence:
      - variables:
          current_import_rate: "{{ current_electricity_import_rate|default(states('sensor.electricity_current_rate'), true) }}"
          current_export_rate: "{{ current_electricity_export_rate|default(states('sensor.electricity_current_rate'), true) }}"
      - if:
          - condition: time
            after: "00:00:00"
            before: "08:00:00"
        then:
          - action: script.todays_solar_forecast_data
            response_variable: solar_forecast_data
        else:
          - action: script.tomorrows_solar_forecast_data
            response_variable: solar_forecast_data
      - choose:
          - alias: Battery First Schedule
            conditions:
              - or:
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_battery_first_schedule_1
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.battery_first_schedule_1
                        state: "on"
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_battery_first_schedule_2
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.battery_first_schedule_2
                        state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Battery schedule is enabled and on. Switching from
                            {{ states('sensor.growatt_sph_inverter_mode') }} to battery first mode.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                      - action: script.battery_first_priority_mode
                        data: {}
          - alias: Grid First Schedule
            conditions:
              - or:
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_grid_first_schedule_1
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.grid_first_schedule_1
                        state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Grid first"
                then:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Grid schedule is enabled and on. Switching from
                            {{ states('sensor.growatt_sph_inverter_mode') }} to load first mode.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                      - action: script.grid_first_priority_mode
                        data: {}
          - alias: Maintenance First Schedule
            conditions:
              - or:
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_maintain_charge_first_schedule_1
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.maintain_charge_first_schedule_1
                        state: "on"
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_maintain_charge_first_schedule_2
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.maintain_charge_first_schedule_2
                        state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Maintain"
                then:
                  - parallel:
                      - action: script.send_direct_notification
                        data:
                          message: >-
                            Maintenance schedule is enabled and on. Switching from
                            {{ states('sensor.growatt_sph_inverter_mode') }} to maintenance first mode.
                          title: Solar Assistant
                          people:
                            entity_id:
                              - person.danny
                      - action: script.battery_first_priority_mode
                        data:
                          max_charge: "{{ states('sensor.growatt_sph_battery_state_of_charge')|float(100) }}"
          - alias: "Unit rate is 0p/kw"
            conditions:
              - condition: template
                value_template: "{{ current_import_rate == 0 }}"
              - condition: state
                entity_id: input_boolean.solar_assistant_charge_electricity_cost_nothing
                state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - parallel:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ event == 'time'}}"
                            sequence:
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    Electricity rate is
                                    ({{ current_import_rate ~ ' ' ~ current_electricity_import_rate_unit }})p/kw
                                    and inverter has not switched from
                                    {{ states('sensor.growatt_sph_inverter_mode') }} to load first mode.
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                        default:
                          - action: script.send_direct_notification
                            data:
                              message: >-
                                Electricity rate costs nothing
                                ({{ current_export_rate ~ ' ' ~ current_electricity_export_rate_unit }}).
                                Charging house battery.
                              title: Solar Assistant
                              people:
                                entity_id:
                                  - person.danny
                      - action: number.set_value
                        target:
                          entity_id: number.growatt_sph_battery_first_stop_charge
                        data:
                          value: "100"
                      - action: script.battery_first_priority_mode
                        data: {}
          - alias: "Unit rate is below 0p/kw"
            conditions:
              - condition: template
                value_template: "{{ current_import_rate < 0 }}"
              - condition: state
                entity_id: input_boolean.solar_assistant_charge_electricity_cost_below_nothing
                state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - parallel:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ event == 'time'}}"
                            sequence:
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    Electricity rate has gone below 0
                                    ({{ current_import_rate ~ ' ' ~ current_electricity_import_rate_unit }})p/kw
                                    and inverter has not switched from
                                    {{ states('sensor.growatt_sph_inverter_mode') }} to load first mode.
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                        default:
                          - action: script.send_direct_notification
                            data:
                              message: >-
                                Electricity rate
                                ({{ current_import_rate ~ ' ' ~ current_electricity_import_rate_unit }}) has fallen
                                below 0.00 GBP/kWh.
                                Charging house battery.
                              title: Solar Assistant
                              people:
                                entity_id:
                                  - person.danny
                      - action: number.set_value
                        target:
                          entity_id: number.growatt_sph_battery_first_stop_charge
                        data:
                          value: "100"
                      - action: script.battery_first_priority_mode
                        data: {}
          - alias: Unit rate below export and charge below export enabled
            conditions:
              - condition: template
                value_template: "{{ current_import_rate < current_electricity_export_rate }}"
              - condition: template
                value_template: "{{ current_import_rate > 0 }}"
              - or:
                  - condition: state
                    entity_id: input_boolean.enable_permanent_charge_below_export
                    state: "on"
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_charge_below_export_schedule_1
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.charge_below_export_schedule_1
                        state: "on"
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_charge_below_export_schedule_2
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.charge_below_export_schedule_2
                        state: "on"
                  - and:
                      - condition: state
                        entity_id: input_boolean.enable_charge_below_export_schedule_3
                        state: "on"
                      - condition: state
                        entity_id: binary_sensor.charge_below_export_schedule_3
                        state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - parallel:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ event == 'time'}}"
                            sequence:
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    Electricity rate
                                    ({{ current_import_rate ~ ' ' ~ current_electricity_import_rate_unit }}) has fallen
                                    below export ({{ current_export_rate ~ ' ' ~ current_electricity_export_rate_unit }})
                                    and inverter has not switched to battery first mode.
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                        default:
                          - action: script.send_to_home_log
                            data:
                              message: >-
                                Electricity unit rate is below export rate
                                ({{ current_import_rate ~'<=' ~ current_export_rate }}). Charging house battery.
                              title: Solar Assistant
                              debug: "Debug"
                      - action: number.set_value
                        target:
                          entity_id: number.growatt_sph_battery_first_stop_charge
                        data:
                          value: "100"
                      - action: script.battery_first_priority_mode
                        data: {}
          - alias: Unit rate below target rate and charge below export enabled
            conditions:
              - condition: state
                entity_id: input_boolean.enable_target_electricity_unit_rate
                state: "on"
              - condition: template
                value_template: "{{ current_import_rate < states('input_number.target_electricity_unit_rate')|float(0) }}"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - parallel:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ event == 'time'}}"
                            sequence:
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    Electricity rate
                                    ({{ current_import_rate }}) has fallen
                                    below export ({{ current_export_rate ~ ' ' ~ current_electricity_export_rate_unit }})
                                    and inverter has not switched to battery first mode.
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                        default:
                          - action: script.send_to_home_log
                            data:
                              message: >-
                                Electricity unit rate is below target rate
                                ({{ current_import_rate|round(0) ~'<=' ~
                                states('input_number.target_electricity_unit_rate') }}). Charging house battery.
                              title: Solar Assistant
                              debug: "Debug"
                      - action: number.set_value
                        target:
                          entity_id: number.growatt_sph_battery_first_stop_charge
                        data:
                          value: "100"
                      - action: script.battery_first_priority_mode
                        data: {}
          - alias: Octopus scheduled charge enabled
            conditions:
              - condition: state
                entity_id: input_boolean.charge_octopus_schedule
                state: "on"
              - or:
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 1 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_1_hour
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 1.5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_1_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 2 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_2_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 2.5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_2_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 3 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_3_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 3.5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_3_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 4 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_4_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 4.5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_4_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 5.5 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_5_5_hours
                        state: "on"
                  - and:
                      - condition: template
                        value_template: "{{ solar_forecast_data.charge_hours_rounded == 6 }}"
                      - condition: state
                        entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_6_hours
                        state: "on"
            sequence:
              - if:
                  - not:
                      - condition: state
                        entity_id: sensor.growatt_sph_inverter_mode
                        state: "Battery first"
                then:
                  - if:
                      - or:
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 1 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_1_hour
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 1.5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_1_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 2 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_2_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 2.5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_2_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 3 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_3_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 3.5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_3_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 4 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_4_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 4.5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_4_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 5.5 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_5_5_hours
                                state: "on"
                          - and:
                              - condition: template
                                value_template: "{{ solar_forecast_data.charge_hours_rounded == 6 }}"
                              - condition: state
                                entity_id: binary_sensor.octopus_energy_target_overnight_home_battery_charge_6_hours
                                state: "on"
                    then:
                      - action: weather.get_forecasts
                        target:
                          entity_id: weather.home
                        data:
                          type: daily
                        response_variable: weather
                      - parallel:
                          - if:
                              - condition: template
                                value_template: "{{ event == 'time'}}"
                            then:
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    Scheduled to charge
                                    {{ solar_forecast_data.charge_hours }}({{ solar_forecast_data.charge_hours_rounded }})
                                    hour{{ iif(solar_forecast_data.charge_hours > 1,'s','') }}
                                    and inverter has not switched to battery first mode.
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                            else:
                              - variables:
                                  first_generation_datetime: >-
                                    {%- from 'get_solar_forecast.jinja' import get_first_solar_generation -%}
                                    {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_today', 'detailedForecast', 'period_start', 'pv_estimate') }}
                                  runtime: >-
                                    {{now() + timedelta( seconds = states('sensor.battery_runtime_duration')|int(0)) }}
                                  first_sustained_hour_calculation: >-
                                    {%- from 'get_solar_forecast.jinja' import get_first_solar_generation -%}
                                    {%- if now().hour > 7 -%}
                                    {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_tomorrow', 'detailedForecast', 'period_start', 'pv_estimate', states('sensor.home_electricity_power_daily_average_over_a_week')|float(1))|default(none, true) }}
                                    {%- else -%}
                                    {{ get_first_solar_generation('sensor.solcast_pv_forecast_forecast_today', 'detailedForecast', 'period_start', 'pv_estimate', states('sensor.home_electricity_power_daily_average_over_a_week')|float(1))|default(none, true) }}
                                    {%- endif -%}
                                  formatted_runtime: >-
                                    {%- from 'get_solar_forecast.jinja' import get_first_solar_generation -%}
                                    {%- if first_generation_datetime is not none -%}
                                    {{ (as_timestamp(runtime) -
                                    as_timestamp(first_generation_datetime))|round(0) }}
                                    {%- endif -%}
                                continue_on_error: true
                              - variables:
                                  first_sustained_hour: >-
                                    {%- if first_sustained_hour_calculation|default(none, true) -%}
                                    {{ as_timestamp(first_sustained_hour_calculation)|int(0) }}
                                    {%- else -%}
                                    {{ none }}
                                    {%- endif -%}
                                continue_on_error: true
                              - variables:
                                  formatted_sustained_runtime: >-
                                    {%- if first_sustained_hour_calculation|default(none, true) -%}
                                    {{ (as_timestamp(runtime) - as_timestamp(first_sustained_hour_calculation))|round(0) }}
                                    {%- else -%}
                                    {{ none }}
                                    {%- endif -%}
                                continue_on_error: true
                              - variables:
                                  runtime_greater_than_first_generation: >-
                                    {%- if runtime|default(none, true) is not none and first_generation_datetime is not none -%}
                                    {{ as_timestamp(runtime) > as_timestamp(first_generation_datetime) }}
                                    {%- else -%}
                                    {{ false }}
                                    {%- endif -%}
                                continue_on_error: true
                              - action: script.send_direct_notification
                                data:
                                  message: >-
                                    {%- from 'get_solar_forecast.jinja' import get_first_solar_generation -%}
                                    Scheduled to charge
                                    {{ solar_forecast_data.charge_hours }}({{ solar_forecast_data.charge_hours_rounded }})
                                    hour{{ iif(solar_forecast_data.charge_hours > 1,'s','') }}.
                                    Charging house battery ({{ states('sensor.growatt_sph_battery_state_of_charge', with_unit=True) }}).


                                    Weather condition: {{ solar_forecast_data.weather_condition }}

                                    Weather temperature: {{ solar_forecast_data.weather_temperature }}

                                    Weather compensation ratio: {{ solar_forecast_data.weather_compensation_ratio }}


                                    {% if runtime|default(none, true) is not none %}
                                    Estimate battery runtime: {{ as_timestamp(runtime)|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
                                    {%- endif %}

                                    {% if first_generation_datetime|default(none, true) is not none %}
                                    First Generation at: {{ as_timestamp(first_generation_datetime)|timestamp_custom('%Y-%m-%d %H:%M:%S') }}
                                    {%- endif %}

                                    Runtime > first Generation: {{ runtime_greater_than_first_generation }}

                                    {% if formatted_runtime|default(none, true) is not none %}
                                    Time Over First Generation: {{ '{:02d}:{:02d}:{:02d}'.format(formatted_runtime // 3600, (formatted_runtime % 3600) // 60, (formatted_runtime % 3600) % 60) }}
                                    {%- endif %}

                                    {% if first_sustained_hour|default(none, true) is number -%}
                                    First Self Sustainable Generation: {{ first_sustained_hour|timestamp_custom('%H:%M:%S') }}

                                    Runtime > Self Sustainable Generation: {{ as_timestamp(runtime) > first_sustained_hour }}
                                    {% else -%}
                                    First Self Sustainable Generation: N/A

                                    Runtime > Self Sustainable Generation: N/A
                                    {% endif -%}

                                    {%- if formatted_sustained_runtime|default(none, true) is number %}
                                    Time Over Sustainable Generation: {{ '{:02d}:{:02d}:{:02d}'.format(formatted_sustained_runtime // 3600, (formatted_sustained_runtime % 3600) // 60, (formatted_sustained_runtime % 3600) % 60) }}
                                    {% else %}
                                    Time Over Sustainable Generation: N/A
                                    {% endif %}
                                  title: Solar Assistant
                                  people:
                                    entity_id:
                                      - person.danny
                                continue_on_error: true
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ solar_forecast_data.estimate_charge_percentage|int(100) < states('sensor.growatt_sph_battery_state_of_charge')|int(0) }}"
                                    sequence:
                                      - action: script.send_direct_notification
                                        data:
                                          message: >-
                                            Battery SOC ({{ states('sensor.growatt_sph_battery_state_of_charge') }}%) > Target charge ({{ solar_forecast_data.estimate_charge_percentage|int(100) }}%).
                                            Skipping charge.
                                          title: Solar Assistant
                                          people:
                                            entity_id:
                                              - person.danny
                                  - alias: Battery runtime > first generation
                                    conditions:
                                      - condition: template
                                        value_template: "{{ runtime_greater_than_first_generation }}"
                                    sequence:
                                      - action: script.send_direct_notification
                                        data:
                                          message: >-
                                            Runtime > first Generation. Skipping charge.
                                          title: Solar Assistant
                                          people:
                                            entity_id:
                                              - person.danny
                                default:
                                  - action: script.battery_first_priority_mode
                                    data:
                                      max_charge: "{{ solar_forecast_data.estimate_charge_percentage|int(100) }}"
                                continue_on_error: true
          - alias: Rates go above export fail safe
            conditions:
              - condition: template
                value_template: "{{ current_import_rate > current_export_rate }}"
              - not:
                  - condition: state
                    entity_id: select.growatt_sph_work_mode_priority
                    state: Load first
              - condition: template
                value_template: "{{ event == 'time'}}"
            sequence:
              - parallel:
                  - action: script.send_direct_notification
                    data:
                      message: >-
                        Electricity rate has gone above export
                        ({{ current_export_rate ~ ' ' ~ current_electricity_export_rate_unit }})
                        {{ current_import_rate ~ ' ' ~ current_electricity_import_rate_unit }}
                        and inverter has not switched from
                        {{ states('sensor.growatt_sph_inverter_mode') }} to load first mode.


                        Switching.
                      title: Solar Assistant
                      people:
                        entity_id:
                          - person.danny
                  - action: script.load_first_priority_mode
                    data: {}
          - alias: Default mode
            conditions:
              - not:
                  - condition: state
                    entity_id: sensor.growatt_sph_inverter_mode
                    state: "Load first"
            sequence:
              - parallel:
                  - action: script.send_to_home_log
                    data:
                      message: >-
                        Default mode: Changing to Load first.
                      title: Solar Assistant
                      debug: "Debug"
                  - action: script.load_first_priority_mode
                    data: {}
        default: []
    mode: single

sensor:
  - platform: statistics
    name: "Home Electricity Power Average Over An Hour"
    unique_id: 97f8c377-acd2-4d92-a2f2-6bbf5ca0b110
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: mean
    max_age:
      hours: 1
  - platform: statistics
    name: "Home Electricity Power Average Over A Day"
    unique_id: 74b261eb-6feb-473d-87b4-8eca961be99d
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: mean
    max_age:
      hours: 24
  - platform: statistics
    name: "Home Electricity Power Average Over A Week"
    unique_id: 47f78be2-bea5-499c-926b-50b48f92f202
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: mean
    max_age:
      days: 7
  - platform: statistics
    name: "Home Electricity Power Average Over A Month"
    unique_id: c0b7e702-5468-4cb1-8221-8067cf44c3e1
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: mean
    max_age:
      days: 30
  - platform: statistics
    name: "Home Electricity Power Median Over An Hour"
    unique_id: b9256d7e-504c-43e2-ac7d-f77ed5b69aaa
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: median
    max_age:
      hours: 1
  - platform: statistics
    name: "Home Electricity Power Median Over A Day"
    unique_id: 82ff2fd7-2694-4171-b0ec-3cafc52205cf
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: median
    max_age:
      hours: 24
  - platform: statistics
    name: "Home Electricity Power Median Over A Week"
    unique_id: fe221135-0a10-414b-8954-137ea83aa73f
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: median
    max_age:
      days: 7
  - platform: statistics
    name: "Home Electricity Power Median Over A Month"
    unique_id: 5891e92f-7bbc-4c51-941e-aa005fba93f9
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: median
    max_age:
      days: 30
  - platform: statistics
    name: "Home Electricity Power Standard Deviation Over An Hour"
    unique_id: 3b115d2e-f765-4e47-b53d-03ff61ca6ada
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: standard_deviation
    max_age:
      hours: 1
  - platform: statistics
    name: "Home Electricity Power Standard Deviation Over A Day"
    unique_id: 3a0d219c-2dc3-4ef5-8964-23e739768499
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: standard_deviation
    max_age:
      hours: 24
  - platform: statistics
    name: "Home Electricity Power Standard Deviation Over A Week"
    unique_id: c5a650f5-7d46-4918-a484-485831c7a922
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: standard_deviation
    max_age:
      days: 7
  - platform: statistics
    name: "Home Electricity Power Standard Deviation Over A Month"
    unique_id: 15d61ca0-bf3f-4959-a526-bb4c5b9f851b
    entity_id: sensor.growatt_sph_load_power
    state_characteristic: standard_deviation
    max_age:
      days: 30

template:
  # Solar Assistant
  - trigger:
      - trigger: state
        entity_id:
          - sensor.growatt_sph_battery_power
    sensor:
      - name: "Growatt SPH Battery Discharge Power"
        unique_id: 251bd989-90a2-4e1b-81d0-b6d87f934eeb
        state: >-
          {{ iif(states('sensor.growatt_sph_battery_power')|float(0) < 0, states('sensor.growatt_sph_battery_power')|float(0)|abs, 0) }}
        availability: "{{ states('sensor.growatt_sph_battery_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - trigger: state
        entity_id:
          - sensor.growatt_sph_battery_power
    sensor:
      - name: "Growatt SPH Battery Charge Power"
        unique_id: fe4f9f9c-4a61-4b27-9122-9c17ce5da164
        state: >-
          {% if states('sensor.growatt_sph_battery_power')|float(0) > 0 -%}
            {{ states('sensor.growatt_sph_battery_power')|float(0) }}
          {%- else -%}
            0
          {%- endif -%}
        availability: "{{ states('sensor.growatt_sph_battery_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "W"
        state_class: "measurement"
  - trigger:
      - trigger: state
        entity_id:
          - number.growatt_sph_battery_first_stop_charge
          - switch.growatt_sph_battery_first_slot_1_enabled
          - switch.growatt_sph_grid_first_slot_1_enabled
          - sensor.growatt_sph_inverter_mode
          - select.growatt_sph_work_mode_priority
    sensor:
      - name: "Growatt SPH Inverter Mode"
        unique_id: da2d35ac-8c82-4d85-8529-25f28d3e7712
        state: >-
          {%- if states('switch.growatt_sph_battery_first_slot_1_enabled') == 'on' and
          states('number.growatt_sph_battery_first_stop_charge')|int(100) < 100 -%}
          Maintain
          {%- elif states('switch.growatt_sph_battery_first_slot_1_enabled') == 'on' -%}
          Battery first
          {%- elif states('switch.growatt_sph_grid_first_slot_1_enabled') == 'on' -%}
          Grid first
          {%- else -%}
          {{ states('select.growatt_sph_work_mode_priority') }}
          {%- endif -%}
        icon: >-
          {%- if states('switch.growatt_sph_battery_first_slot_1_enabled') == 'on' and
          states('number.growatt_sph_battery_first_stop_charge')|int(100) < 100 -%}
          mdi:power-plug-battery
          {%- elif states('switch.growatt_sph_battery_first_slot_1_enabled') == 'on' -%}
          mdi:battery-charging
          {%- elif states('switch.growatt_sph_grid_first_slot_1_enabled') == 'on' -%}
          mdi:battery-minus-variant
          {%- else -%}
          mdi:home-battery
          {%- endif -%}
  - trigger:
      - trigger: state
        entity_id:
          - number.growatt_sph_load_first_stop_discharge
          - sensor.growatt_sph_battery_state_of_charge
    sensor:
      - name: "Usable Battery State of Charge"
        unique_id: a681cc96-bfb5-407c-bc9d-d93f4a0f854f
        state: "{{ ((states('sensor.growatt_sph_battery_state_of_charge')|float(0)) - (states('number.growatt_sph_load_first_stop_discharge')|float(0)))/100 }}"
        attributes:
          discharge_stop_soc: >-
            {{ states('number.growatt_sph_load_first_stop_discharge') }}
          soc: >-
            {{ states('sensor.growatt_sph_battery_state_of_charge') }}
        device_class: "battery"
        unit_of_measurement: "%"
  - trigger:
      - trigger: state
        entity_id:
          - input_number.solar_battery_size
          - sensor.growatt_sph_load_power
          - sensor.usable_battery_state_of_charge
    sensor:
      - name: "Battery Runtime"
        unique_id: c5955655-eb91-4bd7-9f8f-afc4e4f0c58c
        # Formula:
        # (Battery Size x useable charge remaining) / current usage = kWh remaining
        state: "{{ now() + timedelta( seconds = (((states('input_number.solar_battery_size')|float(0) * states('sensor.usable_battery_state_of_charge')|float(0)) / (states('sensor.growatt_sph_load_power')|replace('0','1')|float(1))) * 60 * 60)|round(0)) }}"
        icon: mdi:battery-clock-outline
        attributes:
          duration: >-
            {% set ts = (((states('input_number.solar_battery_size')|float(0) * states('sensor.usable_battery_state_of_charge')|float(0)) / (states('sensor.growatt_sph_load_power')|replace('0','1')|float(1))) * 60 * 60)|round(0) %}
            {{ '{:02d}:{:02d}:{:02d}'.format(ts // 3600, (ts % 3600) // 60, (ts % 3600) % 60) }}
        device_class: "timestamp"
  - trigger:
      - trigger: state
        entity_id:
          - input_number.solar_battery_size
          - sensor.growatt_sph_load_power
          - sensor.usable_battery_state_of_charge
    sensor:
      - name: "Battery Runtime Duration"
        unique_id: b3055c12-734f-4091-8d1b-c995d25f815e
        # Formula:
        # (Battery Size x useable charge remaining) / current usage = kWh remaining
        state: >-
          {{ (((states('input_number.solar_battery_size')|float(0) * states('sensor.usable_battery_state_of_charge')|float(0)) / (states('sensor.growatt_sph_load_power')|replace('0','1')|float(1))) * 60 * 60)|round(0) }}
        icon: mdi:battery-clock-outline
        unit_of_measurement: "s"
        device_class: "duration"
  - trigger:
      - trigger: state
        entity_id:
          - input_number.solar_battery_size
          - sensor.growatt_battery_charge_power
          - sensor.growatt_sph_battery_state_of_charge
    sensor:
      - name: "Time To Charge Battery"
        unique_id: 78ea1413-0d1c-4b89-b109-c961fc30f84d
        # 359999 seconds = 99:99:99 duration (H:M:S)
        state: "{{ now() + timedelta( seconds = (((((states('input_number.solar_battery_size')|float(0)) * (1 - (states('sensor.growatt_sph_battery_state_of_charge')|float(0)/100))) /([states('sensor.growatt_battery_charge_power')|float(1),1]|max|float(1)))*60*60)|round(0)) if (states('sensor.growatt_battery_charge_power')|float(0)) != 0 else 359999) }}"
        icon: mdi:battery-clock
        attributes:
          duration: >-
            {% set ts = (((((states('input_number.solar_battery_size')|float(0)) * (1 - (states('sensor.growatt_sph_battery_state_of_charge')|float(0)/100))) /([states('sensor.growatt_battery_charge_power')|float(1),1]|max|float(1)))*60*60)|round(0)) if (states('sensor.growatt_battery_charge_power')|float(0)) != 0 else 359999 %}
            {{ '{:02d}:{:02d}:{:02d}'.format(ts // 3600, (ts % 3600) // 60, (ts % 3600) % 60) }}
        device_class: "timestamp"
  - trigger:
      - trigger: state
        entity_id:
          - sensor.growatt_battery_charge_power
          - sensor.growatt_sph_inverter_mode
    sensor:
      - name: "Growatt SPH Estimated AC Battery Charge Power"
        unique_id: fd5d04da-c5aa-496c-82dc-0252b6dd54b7
        state: >-
          {%- if states('sensor.growatt_sph_inverter_mode') not in ['unavailable', 'unknown'] and
          states('sensor.grid_power')|float(0) > 0 and
          (states('sensor.growatt_sph_pv_power')|float(0) - states('sensor.growatt_sph_load_power')|float(0)) > 0 -%}
          {{ (states('sensor.growatt_battery_charge_power')|float(0) -
          (states('sensor.growatt_sph_pv_power')|float(0) - states('sensor.growatt_sph_load_power')|float(0)))|round(4) }}
          {%- else -%}
          {{ states('sensor.growatt_battery_charge_power')|float(0) }}
          {%- endif -%}
        availability: "{{ states('sensor.growatt_sph_battery_power')|is_number }}"
        device_class: "power"
        unit_of_measurement: "kW"
        state_class: "measurement"
