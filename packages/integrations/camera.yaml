# Created by Danny Tsang <danny@tsang.uk>
camera:
  - platform: local_file
    file_path: !secret camera_deepstack_conservatory
    name: deepstack_conservatory_latest
  - platform: local_file
    file_path: !secret camera_deepstack_driveway
    name: deepstack_driveway_latest
  - platform: local_file
    file_path: !secret camera_deepstack_frontdoor
    name: deepstack_dront_door_latest
  - platform: local_file
    file_path: !secret camera_deepstack_lounge
    name: deepstack_lounge_latest
  - platform: local_file
    file_path: !secret camera_deepstack_upstairs
    name: deepstack_upstairs_latest
group:
  all_cameras:
    name: All Cameras
    icon: mdi:cctv
    entities:
      - switch.conservatory_camera_detect
      - switch.conservatory_camera_snapshots
      - switch.driveway_camera_detect
      - switch.driveway_camera_snapshots
      - switch.lounge_camera_detect
      - switch.lounge_camera_snapshots
      - switch.upstairs_camera_detect
      - switch.upstairs_camera_snapshots
  indoor_downstairs_cameras:
    name: All Cameras
    icon: mdi:cctv
    entities:
      - switch.conservatory_camera_detect
      - switch.conservatory_camera_snapshots
      - switch.lounge_camera_detect
      - switch.lounge_camera_snapshots
      - switch.upstairs_camera_detect
      - switch.upstairs_camera_snapshots
  indoor_cameras:
    name: Indoor Cameras
    icon: mdi:cctv
    entities:
      - switch.conservatory_camera_detect
      - switch.conservatory_camera_snapshots
      - switch.lounge_camera_detect
      - switch.lounge_camera_snapshots
      - switch.upstairs_camera_detect
      - switch.upstairs_camera_snapshots
image_processing:
  # Object
  - platform: deepstack_object
    ip_address: !secret deepstack_host
    port: 5000
    timeout: 20
    api_key: !secret deepstack_api_key
    save_file_folder: !secret image_processing_conservatory
    save_file_format: png
    save_timestamped_file: true
    always_save_latest_file: true
    scale: 0.75
    targets:
      - target: person
        confidence: 30
      - target: cat
        confidence: 50
      - target: dog
        confidence: 50
      - target: knife
        confidence: 25
    source:
      - entity_id: camera.conservatory
  - platform: deepstack_object
    ip_address: !secret deepstack_host
    port: 5000
    timeout: 20
    api_key: !secret deepstack_api_key
    save_file_folder: !secret image_processing_driveway
    save_file_format: png
    save_timestamped_file: true
    always_save_latest_file: true
    scale: 0.75
    targets:
      - target: person
      - target: vehicle
        confidence: 60
      - target: car
        confidence: 40
    source:
      - entity_id: camera.driveway
  - platform: deepstack_object
    ip_address: !secret deepstack_host
    port: 5000
    timeout: 20
    api_key: !secret deepstack_api_key
    save_file_folder: !secret image_processing_front_door
    save_file_format: png
    save_timestamped_file: true
    always_save_latest_file: true
    scale: 0.75
    targets:
      - target: person
        confidence: 40
      - target: cat
        confidence: 75
      - target: dog
        confidence: 75
      - target: knife
        confidence: 50
    source:
      - entity_id: camera.front_door
  - platform: deepstack_object
    ip_address: !secret deepstack_host
    port: 5000
    timeout: 20
    api_key: !secret deepstack_api_key
    save_file_folder: !secret image_processing_lounge
    save_file_format: png
    save_timestamped_file: true
    always_save_latest_file: true
    scale: 0.75
    targets:
      - target: person
        confidence: 25
      - target: cat
        confidence: 50
      - target: dog
        confidence: 50
      - target: knife
        confidence: 25
    source:
      - entity_id: camera.lounge
  - platform: deepstack_object
    ip_address: !secret deepstack_host
    port: 5000
    timeout: 20
    api_key: !secret deepstack_api_key
    save_file_folder: !secret image_processing_upstairs
    save_file_format: png
    save_timestamped_file: true
    always_save_latest_file: true
    scale: 0.75
    targets:
      - target: person
        confidence: 40
      - target: cat
        confidence: 50
      - target: dog
        confidence: 50
      - target: knife
        confidence: 25
    source:
      - entity_id: camera.upstairs
input_text:
  latest_deepstack_conservatory_file_path:
    name: Latest DeepStack Conservatory Picture
    initial: !secret camera_deepstack_conservatory_public
    icon: mdi:cctv
  latest_deepstack_driveway_file_path:
    initial: !secret camera_deepstack_driveway_public
    name: Latest DeepStack Driveway Picture
    icon: mdi:cctv
  latest_deepstack_frontdoor_file_path:
    initial: !secret camera_deepstack_frontdoor_public
    name: Latest DeepStack Front Door Picture
    icon: mdi:cctv
  latest_deepstack_lounge_file_path:
    initial: !secret camera_deepstack_lounge_public
    name: Latest DeepStack Lounge Picture
    icon: mdi:cctv
  latest_deepstack_upstairs_file_path:
    initial: !secret camera_deepstack_upstairs_public
    name: Latest DeepStack Upstairs Picture
    icon: mdi:cctv
  latest_frigate_conservatory_file_path:
    name: Latest Frigate Conservatory Picture
    initial: !secret camera_frigate_conservatory_public
    icon: mdi:cctv
  latest_frigate_conservatory_person_file_path:
    name: Latest Frigate Conservatory Person Picture
    initial: !secret camera_frigate_conservatory_person_public
    icon: mdi:account-box
  latest_frigate_driveway_file_path:
    initial: !secret camera_frigate_driveway_public
    name: Latest Frigate Driveway Picture
    icon: mdi:cctv
  latest_frigate_driveway_person_file_path:
    name: Latest Frigate Driveway Person Picture
    initial: !secret camera_frigate_driveway_person_public
    icon: mdi:account-box
  latest_frigate_lounge_file_path:
    initial: !secret camera_frigate_lounge_public
    name: Latest Frigate Lounge Picture
    icon: mdi:cctv
  latest_frigate_lounge_person_file_path:
    initial: !secret camera_frigate_lounge_person_public
    name: Latest Frigate Lounge Person Picture
    icon: mdi:account-box
  latest_frigate_upstairs_file_path:
    initial: !secret camera_frigate_upstairs_public
    name: Latest Frigate Upstairs Picture
    icon: mdi:cctv
  latest_frigate_upstairs_person_file_path:
    initial: !secret camera_frigate_upstairs_person_public
    name: Latest Frigate Upstairs Person Picture
    icon: mdi:account-box
script:
  conservatory_camera_process_image:
    alias: Conservatory Camera Process Image
    icon: mdi:camera
    description: "Send conservatory camera image for processing and post a message."
    fields:
      message:
        description: Message to post
      title:
        description: Header to the message posted.
    sequence:
      - service: image_processing.scan
        target:
          entity_id: image_processing.deepstack_object_conservatory
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: image_processing.deepstack_object_conservatory
                above: "0"
            sequence:
              - service: shell_command.copy_conservatory_deepstack_files
              - service: script.post_to_home_log_with_local_attachments
                data:
                  title: "{{ title }}"
                  message: "{{ message }}"
                  filePath: "{{ states('input_text.latest_deepstack_conservatory_file_path') }}"
              - service: script.post_to_home_log
                data:
                  message: >-
                    The following detected in the conservatory:{% for object in state_attr('image_processing.deepstack_object_conservatory','targets_found') %}{% for key, value in object.items() %}{{ '\n* ' ~ key ~ ' (' ~ value ~ '%)' }}{% endfor %}{% endfor %}
        default:
          - service: script.post_to_home_log
            data:
              message: ":white_check_mark: Nothing detected in conservatory."
    mode: single
  driveway_camera_process_objects:
    alias: Driveway camera process objects
    icon: mdi:camera
    description: "Send driveway camera image for processing and post a message."
    fields:
      message:
        description: Message to post
      title:
        description: Header to the message posted.
    sequence:
      - service: image_processing.scan
        target:
          entity_id: image_processing.deepstack_object_driveway
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: image_processing.deepstack_object_driveway
                above: "0"
            sequence:
              - service: shell_command.copy_driveway_deepstack_files
              - service: script.post_to_home_log_with_local_attachments
                data:
                  title: "{{ title }}"
                  message: "{{ message }}"
                  filePath: >-
                    "{{states('input_text.latest_deepstack_driveway_file_path')}}"
              - service: script.post_to_home_log
                data:
                  message: >-
                    The following detected in the driveway:{% for object in state_attr('image_processing.deepstack_object_driveway','targets_found') %}{% for key, value in object.items() %}{{ '\n* ' ~ key ~ ' (' ~ value ~ '%)' }}{% endfor %}{% endfor %}
        default:
          - service: script.post_to_home_log
            data:
              message: ":white_check_mark: Nothing detected in the driveway."
    mode: single
  front_garden_door_bell_camera_process_image:
    alias: Front Garden Doorbell Process Camera
    icon: mdi:camera
    description: "Send front garden camera image for processing and post a message."
    fields:
      message:
        description: Message to post
      title:
        description: Header to the message posted.
    sequence:
      - service: script.post_to_home_log
        data:
          message: ":door: :camera: doorbell camera updated."
      - service: input_text.set_value
        data:
          value:
            front_door_{{ now ().year }}_{{ now ().month }}_{{ now().day }}_{{ now().hour
            }}_{{ now ().minute }}.jpg
        target:
          entity_id: input_text.latest_doorbell_photo_file
      - service: input_text.set_value
        entity_id: input_text.doorbell_last_video_id
        data_template:
          value: "{{ state_attr('camera.front_door', 'last_video_id') | string }}"
      - service: image_processing.scan
        target:
          entity_id: image_processing.deepstack_object_front_door
      - delay:
          hours: 0
          minutes: 0
          seconds: 5
          milliseconds: 0
      - service: script.post_to_home_log_with_local_attachments
        data:
          title: Doorbell rung
          message: Doorbell image.
          filePath:
            camera/front_door/front_door_{{ now().year }}_{{ now().month }}_{{
            now().day }}_{{ now().hour }}_{{ now().minute }}.jpg
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: image_processing.deepstack_object_front_door
                above: "0"
            sequence:
              - service: shell_command.copy_front_door_deepstack_files
              - service: script.post_to_home_log_with_local_attachments
                data:
                  title: "{{ title }}"
                  message: "{{ message }}"
                  filePath: "{{ states('input_text.latest_deepstack_frontdoor_file_path') }}"
              - service: script.post_to_home_log
                data:
                  message: >-
                    The following detected at the front door:{% for object in state_attr('image_processing.deepstack_object_front_door','targets_found') %}{% for key, value in object.items() %}{{ '\n* ' ~ key ~ ' (' ~ value ~ '%)' }}{% endfor %}{% endfor %}
        default:
          - service: script.post_to_home_log
            data:
              message: ":white_check_mark: Nothing detected at the front door."
    mode: single
  lounge_camera_process_objects:
    alias: Lounge camera process objects
    icon: mdi:camera
    description: "Send lounge camera image for processing and post a message."
    fields:
      message:
        description: Message to post
      title:
        description: Header to the message posted.
    sequence:
      - service: image_processing.scan
        target:
          entity_id: image_processing.deepstack_object_lounge
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: image_processing.deepstack_object_lounge
                above: "0"
            sequence:
              - service: shell_command.copy_lounge_deepstack_files
              - service: script.post_to_home_log_with_local_attachments
                data:
                  title: "{{ title }}"
                  message: "{{ message }}"
                  filePath: "{{ states('input_text.latest_deepstack_lounge_file_path') }}"
              - service: script.post_to_home_log
                data:
                  message: >-
                    The following detected in the lounge:{% for object in state_attr('image_processing.deepstack_object_lounge','targets_found') %}{% for key, value in object.items() %}{{ '\n* ' ~ key ~ ' (' ~ value ~ '%)' }}{% endfor %}{% endfor %}
        default:
          - service: script.post_to_home_log
            data:
              message: ":white_check_mark: Nothing detected in the lounge."
    mode: single
  stairs_camera_process_image:
    alias: Stairs Camera Process Image
    icon: mdi:camera
    description: "Send stairs camera image for processing and post a message."
    fields:
      message:
        description: Message to post
      title:
        description: Header to the message posted.
    sequence:
      - service: image_processing.scan
        target:
          entity_id: image_processing.deepstack_object_upstairs
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: image_processing.deepstack_object_upstairs
                above: "0"
            sequence:
              - service: shell_command.copy_upstairs_deepstack_files
              - service: script.post_to_home_log_with_local_attachments
                data:
                  title: "{{ title }}"
                  message: "{{ message }}"
                  filePath: "{{ states('input_text.latest_deepstack_upstairs_file_path') }}"
              - service: script.post_to_home_log
                data:
                  message: >-
                    The following detected upstairs:{% for object in state_attr('image_processing.deepstack_object_upstairs','targets_found') %}{% for key, value in object.items() %}{{ '\n* ' ~ key ~ ' (' ~ value ~ '%)' }}{% endfor %}{% endfor %}
        default:
          - service: script.post_to_home_log
            data:
              message: ":white_check_mark: Nothing detected on the stairs."
    mode: single
shell_command:
  copy_conservatory_deepstack_files: !secret copy_conservatory_deepstack_files_command
  copy_driveway_deepstack_files: !secret copy_driveway_deepstack_files_command
  copy_front_door_deepstack_files: !secret copy_front_door_deepstack_files_command
  copy_lounge_deepstack_files: !secret copy_lounge_deepstack_files_command
  copy_upstairs_deepstack_files: !secret copy_upstairs_deepstack_files_command
