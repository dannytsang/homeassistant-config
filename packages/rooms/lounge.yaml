# Created by Danny Tsang <danny@tsang.uk>
automation:
  # Lights related automation.
  - id: "1583956425622"
    alias: "^Lounge: Dark And Motion Detected"
    description: Added a second delay https://community.home-assistant.io/t/hue-motion-sensor-with-illuminance-condition/128290
    trigger:
      - entity_id: binary_sensor.lounge_area_motion
        platform: state
        to: "on"
        from: "off"
      - platform: state
        entity_id: binary_sensor.lounge_motion
        to: "on"
      - platform: state
        entity_id: binary_sensor.lounge_motion_2
        to: "on"
      - platform: state
        entity_id: binary_sensor.lounge_motion_3
        to: "on"
    condition:
      - and:
        - condition: state
          entity_id: input_boolean.enable_lounge_motion_trigger
          state: "on"
        - or:
          - below: "30"
            condition: numeric_state
            entity_id: sensor.lounge_motion_2_light_level
          - below: "25"
            condition: numeric_state
            entity_id: sensor.lounge_motion_3_light_level
        - or:
          - condition: numeric_state
            entity_id: light.lounge_left_lamp
            attribute: brightness
            below: "190"
          - condition: numeric_state
            entity_id: light.lounge_right_lamp
            attribute: brightness
            below: "190"
          - condition: template
            value_template:
              "{{ state_attr('light.lounge_left_lamp', 'brightness')
              == none }}"
          - condition: template
            value_template:
              "{{ state_attr('light.lounge_right_lamp', 'brightness')
              == none }}"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: device_tracker.lap_ctc0501
                state: home
              - or:
                  - below: "81"
                    condition: numeric_state
                    entity_id: sensor.lounge_motion_2_light_level
                  - below: "65"
                    condition: numeric_state
                    entity_id: sensor.lounge_motion_3_light_level
            sequence:
              - data:
                  message:
                    ":paw_prints: :computer: :bulb: :high_brightness: Motion detected
                    in the lounge, it's dark ({{ states('sensor.lounge_motion_2_light_level')
                    }} & {{ states('sensor.lounge_motion_3_light_level') }} lux < 20-25
                    lux) and Terina''s work computer is on. Turning lounge lights on."
                service: script.post_to_home_log
              - service: scene.turn_on
                target:
                  entity_id: scene.lounge_lights
          - conditions:
              - or:
                  - below: "25"
                    condition: numeric_state
                    entity_id: sensor.lounge_motion_2_light_level
                  - below: "30"
                    condition: numeric_state
                    entity_id: sensor.lounge_motion_3_light_level
            sequence:
              - data:
                  message:
                    ":paw_prints: :bulb: :high_brightness: Motion detected in the lounge
                    and it's dark ({{ states('sensor.lounge_motion_2_light_level') }} &
                    {{ states('sensor.lounge_motion_3_light_level') }} lux < 20-25 lux).
                    Turning lounge lights on."
                service: script.post_to_home_log
              - service: scene.turn_on
                target:
                  entity_id: scene.lounge_lights
        default: []
    mode: queued
    max: 10
  - id: "1606170045630"
    alias: "^Lounge: No Motion After 5 Minutes And TV Is Off Dim Lights"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.lounge_area_motion
        to: "off"
        for: 00:05:00
    condition:
      - condition: state
        entity_id: input_boolean.enable_lounge_motion_trigger
        state: "on"
      - condition: numeric_state
        entity_id: sensor.tv_plug_power_meter
        below: "10"
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":no_pedestrians: :bulb: :low_brightness: No motion detected and :tv:TV
            is turned off in the lounge for 5 minutes. Dimming lights"
      - service: scene.turn_on
        target:
          entity_id: scene.lounge_dim_lights
        data:
          transition: 2
    mode: single
  - id: "1605567425876"
    alias: "^Lounge: No Motion After 10 Minutes"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.lounge_area_motion
        from: "on"
        to: "off"
        for: 00:10:00
    condition:
      - condition: state
        entity_id: input_boolean.enable_lounge_motion_trigger
        state: "on"
      - condition: numeric_state
        entity_id: sensor.tv_plug_power_meter
        below: "10"
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":no_pedestrians: No motion detected in the lounge for 10 minutes and
            :tv:TV is turned off. Turning lounge :bulb: lights off."
      - service: scene.turn_on
        target:
          entity_id: scene.lounge_lights_off
        data:
          transition: 2
    mode: single
  - id: "1588859622571"
    alias: "^Lounge: Motion Detected In The Morning"
    description: ""
    trigger:
      - entity_id: binary_sensor.lounge_motion
        platform: state
        to: "on"
      - entity_id: binary_sensor.stairs_motion
        platform: state
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.enable_morning_routine
        state: "on"
      - condition: state
        entity_id: group.adult_people
        state: home
      - condition: state
        entity_id: alarm_control_panel.house_alarm
        state: armed_home
    action:
      - data: {}
        service: script.morning_script
    mode: single
  - id: "1610918759041"
    alias: "^Lounge: Restart Harmony Hub"
    description: ""
    trigger:
      - platform: time
        at: 03:00:00
    condition:
      - condition: time
        weekday:
          - mon
      - condition: state
        entity_id: binary_sensor.tv_powered_on
        state: "off"
    action:
      - service: script.post_to_home_log
        data:
          message: ":TV: Restarting Harmony hub."
      - service: switch.turn_off
        target:
          entity_id: switch.harmony_hub_plug
      - delay:
          hours: 0
          minutes: 1
          seconds: 0
          milliseconds: 0
      - service: switch.turn_on
        target:
          entity_id: switch.harmony_hub_plug
    mode: single
  - id: "1610388245160"
    alias: "^Lounge: TV Turned Off Dim Lights"
    description: "TV is turned off and dim lights if there has been no motion."
    trigger:
      - platform: numeric_state
        entity_id: sensor.tv_plug_power_meter
        below: "35"
        for: 00:05:00
    condition:
      - condition: state
        entity_id: light.lounge_lamps
        state: "on"
      - condition: state
        entity_id: binary_sensor.lounge_area_motion
        state: "off"
      - condition: template
        value_template:
          " {{ (as_timestamp(now())-as_timestamp(states.binary_sensor.lounge_area_motion.last_updated))
          > 300 }}"
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":bulb: :low_brightness: TV turned off for 5 minutes. Dimming lounge
            lights."
      - service: scene.turn_on
        target:
          entity_id: scene.lounge_dim_lights
        data:
          transition: 2
    mode: single
  - id: "1610409803685"
    alias: "^Lounge: TV Turned Off Turn Off Lights"
    description: "TV is turned off and turn lights off if there has been no motion."
    trigger:
      - platform: numeric_state
        entity_id: sensor.tv_plug_power_meter
        for: 00:10:00
        below: "35"
    condition:
      - condition: state
        entity_id: light.lounge_lamps
        state: "on"
      - condition: state
        entity_id: binary_sensor.lounge_area_motion
        state: "off"
      - condition: template
        value_template:
          " {{ (as_timestamp(now())-as_timestamp(states.binary_sensor.lounge_area_motion.last_updated))
          > 300 }}"
    action:
      - service: script.post_to_home_log
        data:
          message: TV turned off for 10 minutes. Turning lounge lights off.
      - service: scene.turn_on
        target:
          entity_id: scene.lounge_lights_off
        data:
          transition: 2
    mode: single
  # Bay Window
  - id: "1608493783373"
    alias: "^Lounge: Bay Window High Temperature"
    description: ""
    trigger:
      - platform: event
        event_type: ifttt_webhook_received
        event_data:
          action: bay_window_high_temp
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":warning: :thermometer: Bay window is above 35c. Turning server fan
            on."
      - service: switch.turn_on
        target:
          entity_id: switch.server_fan
    mode: single
  - id: "1608493853210"
    alias: "^Lounge: Bay Window Below High Temperature"
    description: ""
    trigger:
      - platform: event
        event_type: ifttt_webhook_received
        event_data:
          action: bay_window_low_temp
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":thermometer: :snowflake: Bay window below high temperature. Turning
            server fan off."
      - service: switch.turn_off
        target:
          entity_id: switch.server_fan

    mode: single
  - id: "1611063957341"
    alias: "^Lounge: Server Fan Running Longer Than 1 Hour"
    description: ""
    trigger:
      - platform: state
        entity_id: switch.server_fan
        to: "on"
        for: 01:00:00
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          message:
            Server fan has been running for more than 1 hour. Consider turning
            Fan off.
      - if:
          - condition: state
            entity_id: input_boolean.enable_direct_notifications
            state: "on"
        then:
          - service: notify.mobile_app_dannys_phone
            data:
              message: Turn off server fan?
              data:
                actions:
                  - title: "Yes"
                    action: server_fan_off
                  - title: "No"
                    action: ignore
              title: Server fan on for over 1 hour
    mode: single
  # Camera
  - id: "1630015457540"
    alias: "^Lounge: Person Detected"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.lounge_person_motion
        from: "off"
        to: "on"
    condition:
      - condition: state
        entity_id: switch.lounge_detect
        state: "on"
    action:
      - service: camera.snapshot
        data_template:
          filename:
            "{{ states('input_text.latest_frigate_lounge_person_file_path')
            }}"
        target:
          entity_id: camera.lounge_person
      - service: script.send_home_log_with_local_attachments
        data_template:
          title: Person detected in lounge
          message: Frigate detected a person in the lounge.
          filePath:
            "{{ states('input_text.latest_frigate_lounge_person_file_path')
            }}"
    mode: queued
    max: 10
  # door / window
  - id: "1631454174806"
    alias: "^Lounge: Door or Window Open"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.lounge_door_and_windows
        from: "off"
        to: "on"
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          message:
            ":door: :window: Lounge door/window opened."
      - service: script.lounge_turn_on_camera
    mode: single
  - id: "1631454249839"
    alias: "^Lounge: Door Or Windows Closed"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.lounge_door_and_windows
        from: "on"
        to: "off"
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          message: ":door: :window: All doors/windows closed in the lounge."
      - service: script.lounge_turn_off_camera
    mode: single
  # Switches
  - id: "1610388192224"
    alias: "^Lounge: TV Turned On"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.tv_plug_power_meter
        above: "35"
    condition: []
    action:
      - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.playstation_powered_on
              state: 'off'
          sequence:
            - service: script.lounge_select_vcr_dvr_input
        default:
          - service: script.lounge_select_game_input
    mode: single
input_boolean:
  enable_lounge_motion_trigger:
    name: Enable motion trigger for lounge
    icon: mdi:motion-sensor
scene:
  - id: "1582387315374"
    name: Lounge Lights On
    entities:
      light.lounge_left_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 240
        color_temp: 310
        friendly_name: Lounge Left Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
      light.lounge_right_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 240
        color_temp: 310
        friendly_name: Lounge Right Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
  - id: "1606169827098"
    name: Lounge Dim Lights
    entities:
      light.lounge_left_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 76
        color_temp: 285
        friendly_name: Lounge Left Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
      light.lounge_right_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 76
        color_temp: 285
        friendly_name: Lounge Right Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
  - id: "1582455234238"
    name: Lounge Lights Off
    entities:
      light.lounge_right_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Lounge Right Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "off"
      light.lounge_left_lamp:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Lounge Left Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "off"
  - id: "1634579522178"
    name: "Lounge: Lights Green"
    entities:
      light.lounge_left_lamp:
        min_mireds: 111
        max_mireds: 666
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        supported_color_modes:
          - color_temp
          - hs
        color_mode: hs
        brightness: 255
        hs_color:
          - 119.533
          - 100
        rgb_color:
          - 1
          - 255
          - 0
        xy_color:
          - 0.173
          - 0.747
        friendly_name: Lounge Left Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
      light.lounge_right_lamp:
        min_mireds: 111
        max_mireds: 666
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        supported_color_modes:
          - color_temp
          - hs
        color_mode: hs
        brightness: 255
        hs_color:
          - 119.533
          - 100
        rgb_color:
          - 1
          - 255
          - 0
        xy_color:
          - 0.173
          - 0.747
        friendly_name: Lounge Right Lamp
        icon: mdi:floor-lamp
        supported_features: 55
        state: "on"
    icon: mdi:lamp
script:
  # Camera
  lounge_turn_off_camera:
    alias: Lounge Turn Off Camera
    sequence:
      - choose:
        - conditions:
            - or:
                - not:
                    - condition: state
                      entity_id: alarm_control_panel.house_alarm
                      state: disarmed
                - condition: state
                  entity_id: binary_sensor.front_door
                  state: "on"
          sequence:
            - service: script.post_to_home_log
              data:
                message: "Alarm is on or front door is open. Keeping lounge:camera_with_flash: camera detection on."
        default:
          - service: script.post_to_home_log
            data:
              message: "Turning lounge :camera: camera detection off."
          - service: switch.turn_off
            target:
              entity_id:
                - switch.lounge_detect
                - switch.lounge_snapshots
    mode: single
    icon: mdi:cctv
  lounge_turn_on_camera:
    alias: Lounge Turn On Camera
    sequence:
      - service: script.post_to_home_log
        data:
          message: "Turning lounge :camera_with_flash: camera detection on."
      - service: switch.turn_on
        target:
          entity_id:
            - switch.lounge_detect
            - switch.lounge_snapshots
    mode: single
    icon: mdi:cctv
  # Receiver
  lounge_select_game_input:
    sequence:
      - service: script.post_to_home_log
        data:
          message: "Changing Onkyo to :tv: VCR/DVR input."
      - delay:
          hours: 0
          minutes: 0
          seconds: 13
          milliseconds: 0
      - service: remote.send_command
        target:
          entity_id: remote.living_room
        data:
          device: Onkyo AV Receiver
          command: InputGame
      - service: script.post_to_home_log
        data:
          message: "Changed Onkyo to :tv: Game input."
    mode: single
    alias: Lounge Reciever Select Game Input
    icon: mdi:audio-video
  lounge_select_vcr_dvr_input:
    sequence:
      - service: script.post_to_home_log
        data:
          message: "Changing Onkyo to :tv: VCR/DVR input."
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - service: remote.send_command
        target:
          entity_id: remote.living_room
        data:
          device: Onkyo AV Receiver
          command: InputVCR/DVR
      - service: script.post_to_home_log
        data:
          message: "Changed Onkyo to :tv: VCR/DVR input."
      - delay:
          hours: 0
          minutes: 0
          seconds: 3
          milliseconds: 0
      - service: remote.send_command
        target:
          entity_id: remote.living_room
        data:
          device: Onkyo AV Receiver
          command: InputVCR/DVR
    mode: single
    alias: Lounge Reciever Select VCR/DVR Input
    description: "Cater for Onkyo / Samsung where the HDMI input select changes 
    to TV after the 2 devices are powered on."
    icon: mdi:audio-video
  lounge_flash_lounge_lights_green:
    alias: "Lounge: Flash Lounge Lights Green"
    sequence:
      - service: scene.create
        data:
          scene_id: current_lounge_lights
          snapshot_entities:
            - light.lounge_left_lamp
            - light.lounge_right_lamp
      - service: scene.turn_on
        target:
          entity_id: scene.lounge_lights_green
        data:
          transition: 0
      - delay:
          hours: 0
          minutes: 0
          seconds: 0
          milliseconds: 500
      - service: scene.turn_on
        target:
          entity_id: scene.current_lounge_lights
    mode: single
    icon: mdi:lamp
sensor:
  # Aggregated stats
  - platform: min_max
    name: Lounge Area Light Level
    entity_ids:
      - sensor.lounge_motion_2_light_level
      - sensor.lounge_motion_3_light_level
    type: mean
  - platform: min_max
    name: Lounge Area Temperature
    entity_ids:
      - sensor.lounge_motion_2_temperature
      - sensor.lounge_motion_3_temperature
    type: mean
template:
  - binary_sensor:
      - name: Playstation Powered On
        device_class: "power"
        icon: "mdi:google-controller{{ '' if states('sensor.playstation_plug_power_meter') | float(0) > 15 else '-off' }}"
        state: "{{ states('sensor.playstation_plug_power_meter') | float(0) > 15 }}"
      - name: TV Powered On
        device_class: "power"
        icon: "mdi:television-classic{{ '' if states('sensor.tv_plug_power_meter') | float(0) > 25 else '-off' }}"
        state: "{{ states('sensor.tv_plug_power_meter') | float(0) > 25 }}"
      - name: Sky Powered On
        device_class: "power"
        icon: "mdi:television-classic{{ '' if states('sensor.sky_power_meter') | float(0) > 15 else '-off' }}"
        state: "{{ states('sensor.sky_power_meter') | float(0) > 15 }}"
  - sensor:
      - name: Thermostat Current Temperature
        unit_of_measurement: C
        device_class: "temperature"
        state_class: "measurement"
        state: "{{ state_attr('climate.thermostat', 'current_temperature') | float(0) }}"
      - name: Thermostat Target Temperature
        unit_of_measurement: C
        device_class: "temperature"
        state: "{{ state_attr('climate.thermostat', 'temperature') | float(0) }}"
