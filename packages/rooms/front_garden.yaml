# Created by Danny Tsang <danny@tsang.uk>
automation:
  - id: "1613924044189"
    alias: "^Front Garden: Doorbell Pressed"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door_ding
        from: "off"
        to: "on"
    condition: []
    action:
      - service: script.post_to_home_log
        data:
          title: Ding Dong
          message: ":door: :bell: Someone is has rung the door bell."
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.wait_for_doorbell_camera_update
    mode: single
  - id: "1621070004545"
    alias: "^Front Garden: Doorbell Camera Updated"
    description: ""
    trigger:
      - platform: state
        entity_id: camera.front_door
    condition:
      - condition: template
        value_template:
          "{{ state_attr('camera.front_door', 'last_video_id') | string
          != states('input_text.doorbell_last_video_id') | string}}"
    action:
      - service: script.front_garden_door_bell_camera_process_image
        data:
          title: Doorbell Picture updated
          message: ":door: :bell: Doorbell photo updated"
      # Bug: https://github.com/home-assistant/home-assistant.io/issues/21599
      - service: downloader.download_file
        data:
          url: "{{ state_attr('camera.front_door', 'video_url') }}"
          subdir: "front_door"
          filename: "{{state_attr('camera.front_door', 'friendly_name')}}.mp4"
    mode: queued
    max: 10
  - id: "1584089698583"
    alias: "^Front Garden: Doorbell Battery Low"
    description: ""
    trigger:
      - entity_id: sensor.front_doorbell_battery
        platform: state
        to: "10"
    condition: []
    action:
      - data:
          message: ":warning: :battery: Conservatory motion sensor is low on battery"
        service: script.post_to_home_log
    mode: single
  - id: "1584089831265"
    alias: "^Front Garden: Doorbell Battery Critically Low"
    description: ""
    trigger:
      - entity_id: sensor.front_doorbell_battery
        platform: state
        to: "5"
    condition: []
    action:
      - data:
          message:
            ":warning: :battery: Conservatory motion sensor is critically low on
            battery"
        service: script.post_to_home_log
    mode: single
  # Motion
  - id: "1613482098461"
    alias: "^Front Garden: Motion Detected"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.front_garden_motion
        from: "off"
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.enable_front_garden_motion_trigger
        state: "on"
    action:
      - service: script.driveway_camera_process_objects
        data:
          title: Front Door Bell Snapshot
          message: Motion Detected In Front Garden
    mode: queued
    max: 10
  - id: "1629147974029"
    alias: "^Front Garden: Person Detected"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.road_person_motion
        from: "off"
        to: "on"
        id: road
      - platform: state
        entity_id: binary_sensor.shared_driveway_person_motion
        id: shared_driveway
        from: "off"
        to: "on"
      - platform: state
        entity_id: binary_sensor.front_garden_person_motion
        id: front_garden
        from: "off"
        to: "on"
    condition:
      - condition: state
        entity_id: switch.driveway_detect
        state: "on"
    action:
      - service: camera.snapshot
        data_template:
          filename:
            "{{ states('input_text.latest_frigate_driveway_person_file_path')
            }}"
        target:
          entity_id: camera.driveway_person
      - choose:
          - conditions:
              - condition: trigger
                id: front_garden
            sequence:
              - service: script.send_home_log_with_local_attachments
                data_template:
                  title: Person detected in the front garden
                  message: Frigate detected a person in the front garden.
                  filePath:
                    "{{ states('input_text.latest_frigate_driveway_person_file_path')
                    }}"
          - conditions:
              - condition: trigger
                id: shared_driveway
            sequence:
              - service: script.send_home_log_with_local_attachments
                data_template:
                  title: Person detected in the shared driveway
                  message: Frigate detected a person in the shared driveway.
                  filePath:
                    "{{ states('input_text.latest_frigate_driveway_person_file_path')
                    }}"
          - conditions:
              - condition: trigger
                id: general
            sequence:
              - service: script.send_home_log_with_local_attachments
                data_template:
                  title: Person detected in the road
                  message: Frigate detected a person in the road.
                  filePath:
                    "{{ states('input_text.latest_frigate_driveway_person_file_path')
                    }}"
        default: []
    mode: queued
    max: 10
input_boolean:
  enable_front_door_trigger:
    name: Enable front door sensor
    icon: mdi:door-open
  enable_front_garden_motion_trigger:
    name: Enable motion trigger for front garden
    icon: mdi:motion-sensor
input_text:
  latest_doorbell_photo_file:
    name: Latest Doorbell Photo File Name
    icon: mdi:image
script:
  front_garden_motion_notification:
    alias: Front Garden Motion Notification
    sequence:
      - repeat:
          count: "4"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.office_front_garden_motion_notification
            - delay:
                hours: 0
                minutes: 0
                seconds: 1
                milliseconds: 0
            - service: scene.turn_on
              target:
                entity_id: scene.office_turn_off_light_notification
    mode: single
  front_garden_turn_off_camera:
    alias: Front Garden Turn Off Camera
    sequence:
      - service: switch.turn_off
        target:
          entity_id:
            - switch.driveway_detect
            - switch.driveway_snapshots
    mode: single
    icon: mdi:cctv
  front_garden_turn_on_camera:
    alias: Front Garden Turn On Camera
    sequence:
      - service: switch.turn_on
        target:
          entity_id:
            - switch.driveway_detect
            - switch.driveway_snapshots
    mode: single
    icon: mdi:cctv
