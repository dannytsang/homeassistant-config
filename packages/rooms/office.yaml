# Created by Danny Tsang <danny@tsang.uk>
automation:
  # Motion
  - id: "1606428361967"
    alias: "Office: Motion Detected And Light Is On"
    description:
      "Split automation depending on light state due to dynamic attributes based on state.
      See https://community.home-assistant.io/t/dynamic-attributes/93226/2?u=tuxinator94"
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.office_motion_occupancy
          - binary_sensor.office_motion_3
          - binary_sensor.office_area_motion_2
          - binary_sensor.under_office_desk_occupancy
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
      - or:
          - condition: state
            entity_id: light.office_light_2
            state: "on"
          - condition: state
            entity_id: light.office_3
            state: "on"
    action:
      - choose:
          - conditions:
              - and:
                  - condition: sun
                    before: sunset
                    before_offset: "-01:00:00"
                  - condition: numeric_state
                    entity_id: sensor.office_motion_illuminance
                    above: input_number.office_light_level_threshold
              - not:
                  - condition: state
                    entity_id: sensor.office_motion_illuminance
                    state: "unavailable"
            sequence:
              - service: script.send_to_home_log
                data:
                  message: >-
                    :paw_prints: :bulb: :high_brightness: Motion detected in the office
                    but it's bright enough ({{ states('sensor.office_motion_illuminance') }} >
                    {{ states('input_number.office_light_level_threshold', with_unit=True) }}).
                    Skipping turning light on.
                  title: ":office: Office"
                  log_level: "Debug"
          - conditions:
              - and:
                  - condition: numeric_state
                    entity_id: sensor.office_motion_illuminance
                    below: input_number.office_light_level_threshold
                  - or:
                      - condition: numeric_state
                        entity_id: light.office_light_2
                        attribute: brightness
                        below: "200"
                      - condition: numeric_state
                        entity_id: light.office_3
                        attribute: brightness
                        below: "200"
            sequence:
              - parallel:
                  - service: scene.turn_on
                    target:
                      entity_id: scene.office_main_light_on
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :paw_prints: :bulb: :high_brightness: Motion detected in the office
                        and it's dark ({{ states('sensor.office_motion_illuminance') }} <
                        {{ states('input_number.office_light_level_threshold', with_unit=True) }}).
                        Turning up :bulb: :high_brightness: lights.
                      title: ":office: Office"
                      log_level: "Debug"
          - conditions:
              - and:
                  - or:
                      - condition: numeric_state
                        entity_id: sensor.office_motion_illuminance
                        above: input_number.office_light_level_threshold
                      - condition: state
                        entity_id: sensor.office_motion_illuminance
                        state: "unavailable"
                  - or:
                      - condition: numeric_state
                        entity_id: light.office_light_2
                        attribute: brightness
                        below: "200"
                      - condition: numeric_state
                        entity_id: light.office_3
                        attribute: brightness
                        below: "200"
            sequence:
              - parallel:
                  - service: scene.turn_on
                    target:
                      entity_id: scene.office_main_light_off
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :paw_prints: :bulb: :high_brightness: Motion detected in the office
                        and bright ({{ states('sensor.office_motion_illuminance') }} <
                        {{ states('input_number.office_light_level_threshold', with_unit=True) }}).
                        Turning office lights off.
                      title: ":office: Office"
                      log_level: "Debug"
        default: []
    mode: queued
    max: 10
  - id: "1632064858461"
    alias: "Office: Motion Detected And Light Is Off"
    description:
      "Split automation depending on light state due to dynamic attributes based on state.
      See https://community.home-assistant.io/t/dynamic-attributes/93226/2?u=tuxinator94"
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.office_motion_occupancy
          - binary_sensor.office_motion_3
          - binary_sensor.office_area_motion_2
          - binary_sensor.under_office_desk_occupancy
        to: "on"
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
      - or:
          - condition: state
            entity_id: light.office_light_2
            state: "off"
          - condition: state
            entity_id: light.office_3
            state: "off"
    action:
      - choose:
          - conditions:
              - and:
                  - condition: sun
                    before: sunset
                    before_offset: "-01:00:00"
                  - condition: numeric_state
                    entity_id: sensor.office_motion_illuminance
                    above: input_number.office_light_level_threshold
              - not:
                  - condition: state
                    entity_id: sensor.office_motion_illuminance
                    state: "unavailable"
            sequence:
              - service: script.send_to_home_log
                data:
                  message: >-
                    :paw_prints: :bulb: :high_brightness: Motion detected in the office
                    but it's bright enough ({{ states('sensor.office_motion_illuminance') }} >
                    {{ states('input_number.office_light_level_threshold', with_unit=True) }}).
                    Skipping turning light on.
                  title: ":office: Office"
                  log_level: "Debug"
        default:
          - parallel:
              - service: scene.turn_on
                target:
                  entity_id: scene.office_main_light_on
              - service: script.send_to_home_log
                data:
                  message: >-
                    :paw_prints: :bulb: :high_brightness: Motion detected in the office
                    and it's dark ({{ states('sensor.office_motion_illuminance') }} <
                    {{ states('input_number.office_light_level_threshold') }}).
                    Turning :bulb: :high_brightness: lights on.
                  title: ":office: Office"
                  log_level: "Debug"
    mode: single
  - id: "1606170234725"
    alias: "Office: No Motion After 5 Minutes And Computer Off"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.office_area_motion_2
        to: "off"
        for: 00:05:00
        from: "on"
    condition:
      - condition: state
        entity_id: group.jd_computer
        state: "not_home"
      - condition: state
        entity_id: group.dannys_work_computer
        state: "not_home"
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                :no_pedestrians: No motion detected in the office after 5 minutes.
                :bulb: :low_brightness:Dimming lights.
              log_level: "Debug"
          - service: scene.turn_on
            target:
              entity_id: scene.office_main_lights_dim
            data:
              transition: 2
    mode: single
  - id: "1606170234726"
    alias: "Office: No Motion After 14 Minutes And Computer On"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.office_area_motion_2
        to: "off"
        for: 00:14:00
        from: "on"
    condition:
      - or:
          - condition: state
            entity_id: group.jd_computer
            state: "home"
          - condition: state
            entity_id: group.dannys_work_computer
            state: "home"
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                :no_pedestrians: No motion detected in the office after 9 minutes and
                :desktop_computer: computer is on. :bulb: :low_brightness:Dimming lights.
              log_level: "Debug"
          - service: scene.turn_on
            target:
              entity_id: scene.office_main_lights_dim
            data:
              transition: 2
    mode: single
  - id: "1584277767373"
    alias: "Office: No Motion Detected And Computer Is Off"
    description: ""
    trigger:
      - entity_id: binary_sensor.office_area_motion_2
        for: 00:06:00
        platform: state
        to: "off"
    condition:
      - and:
          - not:
              - condition: state
                entity_id: group.jd_computer
                state: "home"
          - not:
              - condition: state
                entity_id: group.sam_computer
                state: "home"
          - not:
              - condition: state
                entity_id: group.dannys_work_computer
                state: "home"
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                :no_pedestrians: :bulb: No motion detected in the office for 6 minutes
                and :desktop_computer: is not connected. Turning office and desk lights off.
              title: ":office: Office"
              log_level: "Debug"
          - service: scene.turn_on
            target:
              entity_id: scene.office_all_lights_off
            data:
              transition: 2
    mode: single
  - id: "1587044886886"
    alias: "Office: No Motion Detected And Computer Is On"
    description: ""
    trigger:
      - entity_id: binary_sensor.office_area_motion_2
        for: 00:15:00
        platform: state
        to: "off"
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_motion_triggers
        state: "on"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                :no_pedestrians: No motion in the office for 10 minutes
                and :desktop_computer: is connected. Turning lights off.
              title: ":office: Office"
              log_level: "Debug"
          - service: scene.turn_on
            target:
              entity_id: scene.office_main_light_off
    mode: single
  # Plugs / switches
  - id: "1622584959878"
    alias: "Office: High Temperature"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.office_area_mean_temperature
        above: "26"
      - platform: numeric_state
        entity_id: sensor.office_area_mean_temperature
        above: "29"
        for: 00:01:00
      - platform: numeric_state
        entity_id: sensor.office_area_mean_temperature
        for: 00:01:00
        above: "31"
    condition:
      - condition: state
        entity_id: switch.office_fan
        state: "off"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: group.adult_people
                state: "home"
              - condition: time
                before: "22:00:00"
              - condition: time
                after: "08:30:00"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message:
                        ":hotsprings: :people_holding_hands: Office temperature is high
                        ({{ states('sensor.office_area_mean_temperature') }}c) and someone is home.
                        Turning on fan."
                      title: ":office: Office"
                      log_level: "Debug"
                  - service: switch.turn_on
                    target:
                      entity_id: switch.office_fan
          - conditions:
              - condition: numeric_state
                entity_id: sensor.office_area_mean_temperature
                above: "29"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :warning: :hotsprings: Office temperature is above 29c
                        ({{ states('sensor.office_area_mean_temperature') }}c).
                      title: ":office: Office"
                      log_level: "Debug"
                  - service: script.send_actionable_notification_with_2_buttons
                    data:
                      message: Turn on office fan?
                      title: ♨️🏢Office temperature is 29c+
                      people:
                        - person.danny
                      action1_title: "Yes"
                      action1_name: switch_on_office_fan
                      action2_title: "No"
                      action2_name: ignore
          - conditions:
              - condition: numeric_state
                entity_id: sensor.office_area_mean_temperature
                above: "31"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :warning: :hotsprings: Temperature is above 31c. Turning
                        fan on.
                      title: ":office: Office"
                      log_level: "Debug"
                  - service: switch.turn_on
                    target:
                      entity_id: switch.office_fan
        default: []
    mode: single
  - id: "1596190251094"
    alias: "Office: Turn Fan Off After 1 Hour"
    description: ""
    trigger:
      - entity_id: switch.office_fan
        for: 01:00:00
        platform: state
        to: "on"
        id: 1h
        from: "off"
      - entity_id: switch.office_fan
        for: 02:00:00
        platform: state
        to: "on"
        id: 2h
        from: "off"
    condition: []
    action:
      parallel:
        - choose:
            - conditions:
                - condition: trigger
                  id: 1h
              sequence:
                - service: script.send_to_home_log
                  data:
                    message: Turned off office Fan after 1 hour.
                    title: ":office: Office"
                    log_level: "Debug"
            - conditions:
                - condition: trigger
                  id: 2h
              sequence:
                - service: script.send_to_home_log
                  data:
                    message: Turned off office Fan after 2 hours.
                    title: ":office: Office"
                    log_level: "Debug"
          default: []
        - service: switch.turn_off
          target:
            entity_id: switch.office_fan
    mode: single
  # Computer related automations
  - id: "1619865008647"
    alias: "Office: Computer Turned On"
    description: ""
    trigger:
      - platform: state
        entity_id: group.jd_computer
        from: "not_home"
        to: "home"
    condition: []
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: "Turned on."
              title: ":desktop_computer: Computer"
              log_level: "Debug"
          - service: switch.turn_on
            target:
              entity_id: switch.goxlr
          - service: script.send_to_home_log
            data:
              message: ":level_slider: Turned on GoXLR."
              title: ":desktop_computer: Computer"
              log_level: "Debug"
    mode: single
  - id: "1635673894105"
    alias: "Office: Computer Turned Off"
    description: ""
    trigger:
      - platform: state
        entity_id: group.jd_computer
        to: "not_home"
        from: "home"
        id: router
    condition: []
    action:
      - service: script.send_to_home_log
        data:
          message: ":desktop_computer: :tv: Computer turned off."
          log_level: "Debug"
      - service: script.office_pc_turned_off_notification
        data: {}
    mode: single
  - id: "1606256309890"
    alias: "Office: Computer Turned Off For A Period Of Time"
    description: ""
    trigger:
      - platform: state
        entity_id: group.jd_computer
        for: 00:10:00
        to: "not_home"
        from: "home"
        id: router
    condition:
      - not:
          - condition: state
            entity_id: device_tracker.udm_pro
            state: "unavailable"
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: router
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Turned off for more than 10 minutes."
                      title: ":desktop_computer: Computer"
                      log_level: "Debug"
                  - service: scene.turn_on
                    target:
                      entity_id: scene.office_desk_lights_off
                  - service: script.send_to_home_log
                    data:
                      messsage: Turned off desk lights.
                      log_level: "Debug"
                  - service: switch.turn_off
                    target:
                      entity_id: switch.goxlr
                  - service: script.send_to_home_log
                    data:
                      message: "Turned off for more than 10 minutes. Turned
                        off :level_slider: goXLR"
                      title: ":desktop_computer: Computer"
                      log_level: "Debug"
                  - service: script.office_turn_off_backup_drive
          - conditions:
              - condition: trigger
                id: pc
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: ":desktop_computer: :tv: Computer turned off for more than 10 minutes."
                      log_level: "Debug"
                  - service: scene.turn_on
                    target:
                      entity_id: scene.office_desk_lights_off
                  - service: script.send_to_home_log
                    data:
                      messsage: Turned off desk lights.
                      log_level: "Debug"
                  - service: switch.turn_off
                    target:
                      entity_id: switch.goxlr
                  - service: script.send_to_home_log
                    data:
                      message: "Turned off for more than 10 minutes. Turned
                        off :level_slider: goXLR"
                      title: ":desktop_computer: Computer"
                      log_level: "Debug"
                  - service: script.office_turn_off_backup_drive
        default: []
    mode: single
  - id: "1678741966794"
    alias: "Office: Computer Turned Off"
    description: ""
    trigger:
      - platform: state
        entity_id:
          - group.jd_computer
        from: "home"
        to: "not_home"
        for:
          hours: 0
          minutes: 5
          seconds: 0
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: sun
        after: sunrise
      - condition: time
        after: "08:00:30"
      - condition: sun
        before: sunset
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                Computer turned off. Opening blinds.
              title: ":office: Office"
              log_level: "Debug"
          - service: script.office_open_blinds
            data: {}
    mode: single
  # Blinds
  - id: "1622374444832"
    alias: "Office: Open Blinds In The Morning"
    description: ""
    trigger:
      - platform: time
        at: "08:00:00"
    condition: []
    action:
      - choose:
          - conditions:
              - or:
                  - condition: numeric_state
                    entity_id: weather.home_weather
                    attribute: temperature
                    above: input_number.forecast_high_temperature
                  - condition: numeric_state
                    entity_id: weather.home_hourly
                    attribute: temperature
                    above: input_number.forecast_high_temperature
            sequence:
              - service: script.send_to_home_log
                data:
                  message: >-
                    :clock{{ now().strftime('%I') | int }}{% if now().minute | int > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                    Temperature forecast to be over {{ states('input_number.forecast_high_temperature') }}c
                    ({{ state_attr('weather.home_weather', 'temperature')|float(0)
                    if state_attr('weather.home_weather', 'temperature')|float(0) > state_attr('weather.home_hourly', 'temperature')|float(0)
                    else state_attr('weather.home_hourly', 'temperature')|float(0) }}
                    {{ state_attr('input_number.forecast_high_temperature', 'unit_of_measurement') }}).
                    Not opening blinds.
                  title: ":office: Office"
                  log_level: "Debug"
          - alias: "Really bright and blinds are open already"
            conditions:
              - condition: numeric_state
                entity_id: sensor.front_garden_motion_illuminance_lux
                above: input_number.blind_high_brightness_threshold
              - condition: numeric_state
                entity_id: cover.office_blinds
                attribute: current_tilt_position
                above: 0
              - or:
                  - condition: state
                    entity_id: group.dannys_work_computer
                    state: "home"
                  - condition: state
                    entity_id: group.jd_computer
                    state: "home"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :clock{{ now().strftime('%I') | int }}{% if now().minute | int > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                        Closing blinds.
                      title: ":office: Office"
                      log_level: "Debug"
                  - service: script.office_close_blinds
                    data: {}
          - alias: "Really bright and blinds are closed already"
            conditions:
              - condition: numeric_state
                entity_id: sensor.front_garden_motion_illuminance_lux
                above: input_number.blind_high_brightness_threshold
              - or:
                  - condition: state
                    entity_id: group.dannys_work_computer
                    state: "home"
                  - condition: state
                    entity_id: group.jd_computer
                    state: "home"
            sequence:
              - service: script.send_to_home_log
                data:
                  message: >-
                    :clock{{ now().strftime('%I') | int }}{% if now().minute | int > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                    Keeping blinds closed.
                  title: ":office: Office"
                  log_level: "Debug"
          - conditions:
              - condition: numeric_state
                entity_id: sensor.front_garden_motion_illuminance_lux
                above: input_number.blind_low_brightness_threshold
              - condition: numeric_state
                entity_id: sensor.front_garden_motion_illuminance_lux
                below: input_number.blind_high_brightness_threshold
              - or:
                  - condition: state
                    entity_id: group.dannys_work_computer
                    state: "home"
                  - condition: state
                    entity_id: group.jd_computer
                    state: "home"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: >-
                        :clock{{ now().strftime('%I') | int }}{% if now().minute | int > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                        It's bright outside ({{ states('sensor.front_garden_motion_illuminance_lux', with_unit=True) }}) so partially opening office blinds.
                      title: ":office: Office"
                      log_level: "Debug"
                  - service: cover.set_cover_tilt_position
                    data:
                      tilt_position: 25
                    target:
                      entity_id: cover.office_blinds
        default:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: >-
                    :clock{{ now().strftime('%I') | int }}{% if now().minute | int > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                    Opening blinds.
                  title: ":office: Office"
                  log_level: "Debug"
              - service: script.office_open_blinds
                data: {}
    mode: single
  - id: "1622374233312"
    alias: "Office: Close Office Blinds At Night 2"
    description: ""
    trigger:
      - platform: sun
        event: sunset
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        above: 25
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.office_windows
                state: "on"
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":warning: :window: Office window is still open so not closing
                    blinds. before closing blinds. :warning:"
                  title: ":office: Office"
                  log_level: "Debug"
        default:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: ":city_sunset: :sun_with_face: :window: It's getting dark, closing office blinds."
                  title: ":office: Office"
                  log_level: "Debug"
              - service: cover.set_cover_tilt_position
                data:
                  tilt_position: 25
                target:
                  entity_id: cover.office_blinds
    mode: single
  - id: "1622374233310"
    alias: "Office: Close Office Blinds At Night 2"
    description: ""
    trigger:
      - platform: sun
        event: sunset
        offset: 01:00:00
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        above: 0
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.office_windows
                state: "on"
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":warning: :window: Office window is still open so not closing
                    blinds. before closing blinds. :warning:"
                  title: ":office: Office"
                  log_level: "Debug"
        default:
          - parallel:
              - service: script.send_to_home_log
                data:
                  message: ":city_sunset: :sun_with_face: :window: It's getting dark, closing office blinds."
                  title: ":office: Office"
                  log_level: "Debug"
              - service: script.office_close_blinds
                data: {}
    mode: single
  - id: "1622666920056"
    alias: "Office: Window Closed At Night"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.office_windows
        from: "on"
        to: "off"
        for:
          hours: 0
          minutes: 1
          seconds: 0
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - or:
          - condition: sun
            after: sunset
            after_offset: -01:00:00
          - condition: sun
            before: sunrise
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                :window: :city_sunset: Office window closed and it's dark. Closing
                blinds.
              title: ":office: Office"
              log_level: "Debug"
          - service: script.office_close_blinds
            data: {}
    mode: single
  - id: "1680528200295"
    alias: "Office: No Direct Sun Light In The Morning"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        below: input_number.office_blinds_morning_sun_azimuth_threshold
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        below: 50
      - condition: time
        after: "08:10:00"
      - condition: state
        entity_id: binary_sensor.office_windows
        state: "off"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                Morning :sun: sun is out of the way. Opening :office: office blinds.

                Azimuth: {{ state_attr('sun.sun', 'azimuth') }} ({{ states('input_number.lounge_blinds_morning_sun_azimuth_threshold')}}).

                Elevation: {{ state_attr('sun.sun', 'elevation') }}.
              title: ":office: Office"
              log_level: "Debug"
          - service: script.office_open_blinds
            data: {}
    mode: single
  - id: "1680528200297"
    alias: "Office: No Direct Sun Light In The Afternoon"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        above: input_number.office_blinds_afternoon_sun_azimuth_threshold
      - platform: numeric_state
        entity_id: sun.sun
        attribute: elevation
        above: input_number.office_blinds_afternoon_sun_elevation_threshold
    condition:
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        above: input_number.office_blinds_afternoon_sun_azimuth_threshold
      - condition: numeric_state
        entity_id: sun.sun
        attribute: elevation
        above: input_number.office_blinds_afternoon_sun_elevation_threshold
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        below: 50
      - condition: state
        entity_id: binary_sensor.office_windows
        state: "off"
    action:
      - service: script.send_to_home_log
        data:
          message: >-
            Afternoon :sun: sun is out of the way. Opening :office: office blinds.

            Azimuth: {{ state_attr('sun.sun', 'azimuth') }} ({{ states('input_number.office_blinds_afternoon_sun_azimuth_threshold')}}).

            Elevation: {{ state_attr('sun.sun', 'elevation') }} ({{ states('input_number.office_blinds_afternoon_sun_elevation_threshold')}}).
          title: ":office: Office"
          log_level: "Debug"
      - service: script.office_open_blinds
        data: {}
    mode: single
  - id: "1678300398737"
    alias: "Office: Bright Outside"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.front_garden_motion_illuminance_lux
        above: input_number.blind_low_brightness_threshold
        for: "00:01:00"
    condition:
      - condition: sun
        after: sunrise
      - condition: time
        after: "08:10:00"
      - condition: sun
        before: sunset
      - condition: numeric_state
        entity_id: sensor.front_garden_motion_illuminance_lux
        below: input_number.blind_high_brightness_threshold
      # Between morning and afternoon non direct sun light positon
      - condition: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        above: input_number.office_blinds_morning_sun_azimuth_threshold
      - condition: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        below: input_number.office_blinds_afternoon_sun_azimuth_threshold
      - condition: numeric_state
        entity_id: sun.sun
        attribute: elevation
        below: input_number.office_blinds_afternoon_sun_elevation_threshold
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        above: 25
      - condition: state
        entity_id: binary_sensor.office_windows
        state: "off"
      - or:
          - condition: state
            entity_id: group.dannys_work_computer
            state: "home"
          - condition: state
            entity_id: group.jd_computer
            state: "home"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                It's bright outside ({{ states('sensor.front_garden_motion_illuminance_lux', with_unit=True) }}) and computer is on.
                Partially closing blinds.

                Azimuth: {{ state_attr('sun.sun', 'azimuth') }}.

                Elevation: {{ state_attr('sun.sun', 'elevation') }}.
              title: ":office: Office"
              log_level: "Debug"
          - service: cover.set_cover_tilt_position
            data:
              tilt_position: 25
            target:
              entity_id: cover.office_blinds
    mode: single
  - id: "1678300398736"
    alias: "Office: Really Bright Outside"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.front_garden_motion_illuminance_lux
        above: input_number.blind_high_brightness_threshold
        for: "00:01:00"
    condition:
      - condition: sun
        after: sunrise
      - condition: time
        after: "08:00:30"
      - condition: sun
        before: sunset
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        above: 0
      - condition: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        above: input_number.office_blinds_morning_sun_azimuth_threshold
      - condition: numeric_state
        entity_id: sun.sun
        attribute: azimuth
        below: input_number.office_blinds_afternoon_sun_azimuth_threshold
      - condition: state
        entity_id: binary_sensor.office_windows
        state: "off"
      - or:
          - condition: state
            entity_id: group.dannys_work_computer
            state: "home"
          - condition: state
            entity_id: group.jd_computer
            state: "home"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                It's really bright outside ({{ states('sensor.front_garden_motion_illuminance_lux', with_unit=True) }}).
                Closing blinds.
              title: ":office: Office"
              log_level: "Debug"
          - service: script.office_close_blinds
            data: {}
    mode: single
  - id: "1678637987424"
    alias: "Office: Outside Went Darker"
    description: ""
    trigger:
      - platform: numeric_state
        entity_id: sensor.front_garden_motion_illuminance_lux
        for:
          hours: 0
          minutes: 5
          seconds: 0
        below: input_number.blind_low_brightness_threshold
    condition:
      - condition: sun
        after: sunrise
      - condition: time
        after: "08:00:30"
      - condition: sun
        before: sunset
      - condition: numeric_state
        entity_id: cover.office_blinds
        attribute: current_tilt_position
        below: 50
      - condition: state
        entity_id: input_boolean.enable_office_blind_automations
        state: "on"
      - condition: state
        entity_id: binary_sensor.office_windows
        state: "off"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: >-
                It is not as bright outside ({{ states('sensor.front_garden_motion_illuminance_lux', with_unit=True) }}).
                Opening Blinds
              title: ":office: Office"
              log_level: "Debug"
          - service: script.office_open_blinds
            data: {}
    mode: single
  # Lights
  - id: "1614555883547"
    alias: "Office: Toggle Key Light"
    description: ""
    trigger:
      - platform: webhook
        webhook_id: keylight_toggle
        allowed_methods:
          - GET
        local_only: false
    condition:
      - condition: template
        value_template: "{{ trigger.json.key|string == states('input_text.office_key_light_key') }}"
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: ":bulb: Toggle Key light"
              log_level: "Debug"
          - service: light.toggle
            data: {}
            target:
              entity_id:
                - light.elgato_key_light_left
                - light.elgato_key_light_right
          - choose:
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.workday_sensor
                    state: "on"
                  - condition: time
                    after: "09:00:00"
                    before: "17:30:00"
                    weekday:
                      - mon
                      - tue
                      - wed
                      - thu
                      - fri
                  - condition: state
                    entity_id: media_player.spotify_danny
                    state: "playing"
                sequence:
                  - service: media_player.media_stop
                    data: {}
                    target:
                      entity_id: media_player.spotify_danny
                  - service: script.send_to_home_log
                    data:
                      message: ":stop_button: Turning off music."
                      log_level: "Debug"
            default: []
    mode: single
  # Smoke alarm
  - id: "1646778627153"
    alias: "Office: Carbon Monoxide Detected"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.nest_protect_office_co_status
        to: "on"
    condition: []
    action:
      - parallel:
          - service: script.send_direct_notification
            data:
              title: ":skull_and_crossbones: CO Detected in the office"
              message: ":skull_and_crossbones: Carbon Monide detected in the :office: office."
          - service: script.set_central_heating_to_off
            data: {}
          - service: script.set_how_water_to_home_mode
            data: {}
    mode: single
  - id: "1646778909669"
    alias: "Office: Smoked Detected"
    description: ""
    trigger:
      - platform: state
        entity_id: binary_sensor.nest_protect_office_smoke_status
        to: "on"
    condition: []
    action:
      - parallel:
          - service: script.send_direct_notification
            data:
              title: ":smoking: Smoke detected in the office"
              message: ":smoking: Smoke detected in the :office: office."
          - service: script.set_central_heating_to_off
            data: {}
          - service: script.set_how_water_to_home_mode
            data: {}
    mode: single

scene:
  - id: "1600795089307"
    name: "Office: Turn On Main Light"
    entities:
      light.office_light_2:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 204
        color_temp: 270
        friendly_name: Office Light 2
        supported_features: 55
        state: "on"
      light.office_3:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 255
        color_temp: 285
        friendly_name: Office Light 3
        supported_features: 55
        state: "on"
    icon: mdi:lightbulb
  - id: "1606247204381"
    name: Office Turn Off Main Light
    entities:
      light.office_light_2:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 2
        supported_features: 55
        state: "off"
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light
        supported_features: 55
        state: "off"
      light.office_3:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 3
        supported_features: 55
        state: "off"
      light.office_light_4:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 4
        supported_features: 55
        state: "off"
  - id: "1612921949654"
    name: Office Dim Main Lights
    entities:
      light.office_light_2:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 51
        color_temp: 270
        friendly_name: Office Light 2
        supported_features: 55
        state: "on"
      light.office_3:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 51
        color_temp: 285
        friendly_name: Office Light 3
        supported_features: 55
        state: "on"
  - id: "1606247529306"
    name: Office Turn Off All Lights
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light
        supported_features: 55
        state: "off"
      light.office_desk_top:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Office Desk Top
        supported_features: 63
        state: "off"
      light.office_desk_right:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Right Office Desk
        supported_features: 63
        state: "off"
      light.office_desk_left:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Left Office Desk
        supported_features: 63
        state: "off"
      light.office_light_2:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 2
        supported_features: 55
        state: "off"
      light.office_3:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 3
        supported_features: 55
        state: "off"
      light.office_light_4:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light 4
        supported_features: 55
        state: "off"
  - id: "1607645842037"
    name: Office Turn Off Desk Lights
    entities:
      light.office_desk_top:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Office Desk Top
        supported_features: 63
        state: "off"
      light.office_desk_right:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Right Office Desk
        supported_features: 63
        state: "off"
      light.office_desk_left:
        min_mireds: 153
        max_mireds: 500
        effect_list:
          - colorloop
          - random
        friendly_name: Left Office Desk
        supported_features: 63
        state: "off"
  - id: "1600776152370"
    name: "Office: Doorbell Notification"
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 255
        hs_color:
          - 120
          - 100
        rgb_color:
          - 0
          - 255
          - 0
        xy_color:
          - 0.172
          - 0.747
        friendly_name: Office Light
        supported_features: 55
        state: "on"
    icon: mdi:lightbulb
  - id: "1606170296807"
    name: Office Sun Light
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 128
        color_temp: 245
        friendly_name: Office Light
        supported_features: 55
        state: "on"
  # Notifications
  - id: "1645654665047"
    name: Office PC Turned Off Notification
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        supported_color_modes:
          - color_temp
          - hs
        color_mode: hs
        brightness: 255
        hs_color:
          - 299.997
          - 100
        rgb_color:
          - 254
          - 0
          - 255
        xy_color:
          - 0.384
          - 0.154
        friendly_name: Office Light
        supported_features: 55
        state: "on"
    icon: mdi:lightbulb
  - id: "1613476016502"
    name: "Office: Turn Off Light Notification"
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        friendly_name: Office Light
        supported_features: 55
        state: "off"
  - id: "1613476289811"
    name: "Office: Front Door Open Notification"
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 255
        hs_color:
          - 240
          - 100
        rgb_color:
          - 0
          - 0
          - 255
        xy_color:
          - 0.136
          - 0.04
        friendly_name: Office Light
        supported_features: 55
        state: "on"
  - id: "1613476535744"
    name: "Office: Front Garden Motion Notification"
    entities:
      light.office_light:
        min_mireds: 111
        max_mireds: 400
        effect_list:
          - effect_colorloop
          - effect_pulse
          - effect_stop
        brightness: 255
        hs_color:
          - 284.995
          - 100
        rgb_color:
          - 191
          - 0
          - 255
        xy_color:
          - 0.301
          - 0.116
        friendly_name: Office Light
        supported_features: 55
        state: "on"
script:
  # PC
  office_turn_off_backup_drive:
    alias: Office Turn Off Backup Drive
    sequence:
      - and:
          - condition: state
            entity_id: switch.external_hdd
            state: "on"
          - condition: state
            entity_id: group.jd_computer
            state: "not_home"
      - service: script.send_to_home_log
        data:
          message: ":floppy_disk: Turning off external HDD"
          log_level: "Debug"
      - service: switch.turn_off
        target:
          entity_id: switch.external_hdd
    mode: single
  office_pc_turned_off_notification:
    alias: Office PC Turned Off Notification
    sequence:
      - service: scene.turn_on
        data:
          transition: 1
        target:
          entity_id: scene.office_pc_turned_off_notification
      - delay:
          hours: 0
          minutes: 0
          seconds: 1
          milliseconds: 0
      - service: scene.turn_on
        data:
          transition: 1
        target:
          entity_id: scene.office_turn_off_light_notification
    mode: single
  # Blinds
  # Used in UI
  office_open_blinds:
    alias: Office Open Blinds
    sequence:
      - service: cover.set_cover_tilt_position
        data:
          tilt_position: 50
        target:
          entity_id: cover.office_blinds
  office_close_blinds:
    alias: Office Close Blinds
    sequence:
      - service: cover.set_cover_tilt_position
        data:
          tilt_position: 0
        target:
          entity_id: cover.office_blinds

sensor:
  # historical stats
  # Computer
  - platform: history_stats
    name: PC Uptime Today
    unique_id: 0991cb72-ffe8-408a-826d-48b0230353c8
    entity_id: group.jd_computer
    state: "home"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: PC Uptime Last 24 Hours
    unique_id: 472320b6-4109-4e07-b914-c8ea54491362
    entity_id: group.jd_computer
    state: "home"
    type: time
    end: "{{ now() }}"
    duration:
      hours: 24
  - platform: history_stats
    name: PC Uptime Yesterday
    unique_id: 8f999940-08bd-49be-85f7-495dfcbe4309
    entity_id: group.jd_computer
    state: "home"
    type: time
    end: "{{ now().replace(hour=0, minute=0, second=0) }}"
    duration:
      hours: 24
  - platform: history_stats
    name: PC Uptime This Week
    unique_id: 837d727a-2290-4527-ab68-3cd78344321c
    entity_id: group.jd_computer
    state: "home"
    type: time
    start: "{{ as_timestamp( now().replace(hour=0, minute=0, second=0) ) - now().weekday() * 86400 }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: PC Uptime Last 30 Days
    unique_id: 9ec48946-234a-4093-844c-800ba67ab340
    entity_id: group.jd_computer
    state: "home"
    type: time
    end: "{{ now().replace(hour=0, minute=0, second=0) }}"
    duration:
      days: 30
  - platform: history_stats
    name: Work Computer Uptime Today
    unique_id: cb2cfc1a-39b5-4225-86b4-5b34d287c0b6
    entity_id: group.dannys_work_computer
    state: "home"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Work Computer Uptime Yesterday
    unique_id: 2fd1cec2-a453-4347-8e7f-14f25e08144c
    entity_id: group.dannys_work_computer
    state: "home"
    type: time
    end: "{{ now().replace(hour=0, minute=0, second=0) }}"
    duration:
      hours: 24
  - platform: history_stats
    name: Work Computer Uptime This Week
    unique_id: dc0e517b-2308-4c6f-8ad8-38665f312ce3
    entity_id: group.dannys_work_computer
    state: "home"
    type: time
    start: "{{ as_timestamp( now().replace(hour=0, minute=0, second=0) ) - now().weekday() * 86400 }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Work Computer Uptime Last 30 Days
    unique_id: 3695a5ba-ebfe-43c2-a7b3-2e04704ae4c4
    entity_id: group.dannys_work_computer
    state: "home"
    type: time
    end: "{{ now().replace(hour=0, minute=0, second=0) }}"
    duration:
      days: 30

template:
  - trigger:
      - platform: state
        entity_id:
          - binary_sensor.office_window_left
          - binary_sensor.office_window_right
          - input_number.close_blinds_brightness_threshold
          - input_number.forecast_high_temperature
          - sensor.front_garden_motion_illuminance_lux
          - sensor.office_area_mean_temperature
          - sun.sun
          - weather.home_hourly
      - platform: time_pattern
        minutes: "/15"
    binary_sensor:
      - name: Office Blind Anticipated State
        unique_id: 20930498-7de2-4151-ae84-9c5566dcafe9
        device_class: opening
        state: >-
          {{ not(states('sensor.front_garden_motion_illuminance_lux')|float(0) < states('input_number.close_blinds_brightness_threshold')|float(10000)
          and not(states('sun.sun') == 'above_horizon')
          and states('binary_sensor.office_window_left') == 'off'
          and states('binary_sensor.office_window_right') == 'off')
          and (state_attr('weather.home_hourly', 'temperature')|float(0)) > (states('input_number.forecast_high_temperature')|float(24))
          and (states('sensor.office_area_mean_temperature')|float(0)) <= 23.5
          and not(states('weather.home_hourly') in ['sunny','partlycloudy']) }}
        attributes:
          brightness: "{{ (states('sensor.front_garden_motion_illuminance_lux')|float(0)) < (states('input_number.close_blinds_brightness_threshold')|float(10000)) }}"
          sun: "{{ states('sun.sun') == 'above_horizon' }}"
          temperature: "{{ (states('sensor.office_area_mean_temperature')|float(0)) > 23.5 }}"
          temperature_hour_forecast: "{{ states('weather.home_hourly')|float(0) > states('input_number.forecast_high_temperature')|float(24) }}"
          weather: "{{ states('home_hourly')|default('') in ['sunny','partlycloudy'] }}"
          window_left: "{{ states('binary_sensor.office_window_left') == 'off' }}"
          window_right: "{{ states('binary_sensor.office_window_right') == 'off' }}"
