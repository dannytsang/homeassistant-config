# Created by Danny Tsang <danny@tsang.uk>
automation:
  # region Motion
  - id: "1754227355547"
    alias: "Bathroom: Motion Detected"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.bathroom_motion_pir
          - binary_sensor.bathroom_motion_2_occupancy
        to: "on"
    conditions: []
    actions:
      - choose:
          - conditions:
              - condition: state
                entity_id: light.bathroom_lights
                state: "off"
              - condition: numeric_state
                entity_id: sensor.bathroom_area_mean_light_level
                above: input_number.bathroom_light_level_threshold
            sequence:
              - action: script.send_to_home_log
                data:
                  message: >-
                    ğŸ¾ Motion detected but it's too bright (
                    {{ states('sensor.bathroom_area_mean_light_level') }} > {{ states('input_number.bathroom_light_level_threshold') }}).
                    Skipping turning on lights.
                  title: "ğŸ› Bathroom"
                  log_level: "Debug"
          - conditions:
              - condition: state
                entity_id: light.bathroom_lights
                state: "off"
            sequence:
              - parallel:
                  - action: script.send_to_home_log
                    data:
                      message: "ğŸ¾ Motion detected. Turning ğŸ’¡ light on."
                      title: "ğŸ› Bathroom"
                      log_level: "Debug"
                  - action: light.turn_on
                    metadata: {}
                    data: {}
                    target:
                      entity_id: light.bathroom_lights
        default:
          - action: script.send_to_home_log
            data:
              message: "ğŸ¾ Motion detected and ğŸ’¡ light is already on."
              title: "ğŸ› Bathroom"
              log_level: "Debug"
      - action: timer.cancel
        target:
          entity_id: timer.bathroom_light_off
        data: {}
    mode: single
  - id: "1754227694151"
    alias: "Bathroom: No Motion Detected"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.bathroom_area_motion
        to: "off"
    conditions: []
    actions:
      - choose:
          - alias: Door closed
            conditions:
              - condition: state
                entity_id: binary_sensor.bathroom_door_contact
                state: "off"
            sequence:
              - action: script.send_to_home_log
                data:
                  message: "ğŸš· No motion detected and door closed. Skipping turning ğŸ’¡ light off."
                  title: "ğŸ› Bathroom"
                  log_level: "Debug"
        default:
          - choose:
              - alias: After midnight
                conditions:
                  - condition: time
                    after: "00:00:00"
                  - condition: time
                    before: "06:00:00"
                sequence:
                  - parallel:
                      - action: script.send_to_home_log
                        data:
                          message: >-
                            ğŸš· No motion detected. Starting night
                            â³ timer.
                          title: "ğŸ› Bathroom"
                          log_level: "Debug"
                      - action: timer.start
                        target:
                          entity_id: timer.bathroom_light_off
                        data:
                          duration: 00:02:30
            default:
              - parallel:
                  - action: script.send_to_home_log
                    data:
                      message: "ğŸš· No motion detected. Starting â³ timer."
                      title: "ğŸ› Bathroom"
                      log_level: "Debug"
                  - action: timer.start
                    target:
                      entity_id: timer.bathroom_light_off
                    data:
                      duration: 00:03:00
    mode: single
  # region Lights
  - id: "1754254675071"
    alias: "Bathroom: Light Turned Off"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - light.bathroom_lights
        to: "off"
    conditions: []
    actions:
      - parallel:
          - action: script.send_to_home_log
            data:
              message: "ğŸ’¡ Lights turned off. Cancelling light â³timer."
              title: "ğŸ› Bathroom"
              log_level: "Debug"
          - action: timer.cancel
            target:
              entity_id: timer.bathroom_light_off
    mode: single
  - id: "1754254675073"
    alias: "Bathroom: Light Switch Toggled"
    description: ""
    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.bathroom_light_input_0
    conditions: []
    actions:
      - delay:
          seconds: 1
      - choose:
          - conditions:
              - condition: state
                entity_id: light.bathroom_lights
                state: "on"
            sequence:
              - parallel:
                  - action: script.send_to_home_log
                    data:
                      message: "Light switch used"
                      title: "ğŸ› Bathroom"
                      log_level: "Debug"
                  - action: timer.cancel
                    target:
                      entity_id: timer.bathroom_light_off
                    data: {}
        default: []
    mode: single
  - id: "1754254675072"
    alias: "Bathroom: Light Timer Finished"
    description: ""
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bathroom_light_off
    conditions: []
    actions:
      - parallel:
          - action: script.send_to_home_log
            data:
              message: "ğŸ’¡ Light âŒ›timer finished. Turning off lights."
              title: "ğŸ› Bathroom"
              log_level: "Debug"
          - action: light.turn_off
            target:
              entity_id: light.bathroom_lights
    mode: single
  # region Door
  - id: "1680461746985"
    alias: "Bathroom: High Humidity"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id: sensor.bathroom_motion_humidity
        for:
          hours: 0
          minutes: 30
          seconds: 0
        above: 59.9
    conditions:
      - condition: state
        entity_id: binary_sensor.bathroom_window_contact
        state: "off"
      - condition: state
        entity_id: binary_sensor.bathroom_door_contact
        state: "off"
    actions:
      - action: script.send_direct_notification
        data:
          message: "High Humidity ({{ states('sensor.bathroom_motion_humidity') }} > 59.9%). The ğŸšªdoor and ğŸªŸwindow is closed."
          title: "ğŸ› Bathroom"
          log_level: "Debug"
          people:
            entity_id:
              - person.danny
              - person.terina
    mode: single
  # region Toothnrush
  - id: "1760479357022"
    alias: "Bathroom: Dannyâ€™s Toothbrush"
    description: ""
    triggers:
      - trigger: numeric_state
        entity_id:
          - sensor.dannys_toothbrush_time
        above: 300
    conditions:
      - condition: state
        entity_id: light.bathroom_lights
        state: "on"
    actions:
      - action: light.turn_off
        target:
          entity_id: light.bathroom_lights
        data: {}
      - delay:
          hours: 0
          minutes: 0
          seconds: 1
          milliseconds: 0
      - action: light.turn_on
        target:
          entity_id: light.bathroom_lights
        data: {}
    mode: single

script:
  bathroom_flash_light:
    alias: Bathroom Flash Light
    sequence:
      - repeat:
          count: 2
          sequence:
            - action: light.turn_on
              data:
                brightness_pct: 100
              entity_id: light.bathroom
            - action: light.turn_off
              data: {}
              entity_id: light.bathroom
    mode: single

sensor:
  - platform: mold_indicator
    name: Bathroom Mould Indicator
    indoor_temp_sensor: sensor.bathroom_door_temperature
    indoor_humidity_sensor: sensor.bathroom_motion_humidity
    outdoor_temp_sensor: sensor.gw2000a_outdoor_temperature
    calibration_factor: 1.32
