# Created by Danny Tsang <danny@tsang.uk>
automation:
  # Blinds
  - id: "1605925028960"
    alias: "Ashlee's Room: Timed Close Blinds"
    description: ""
    trigger:
      - platform: time
        at: input_datetime.childrens_bed_time
      - platform: sun
        event: sunset
        id: sunset
    condition:
      - not:
          - condition: numeric_state
            entity_id: cover.ashlees_blinds
            attribute: current_position
            below: input_number.blind_closed_position_threshold
      - condition: state
        entity_id: input_boolean.enable_ashlees_blind_automations
        state: "on"
    action:
      - choose:
          # Window is still open
          - conditions:
              - condition: state
                entity_id: binary_sensor.ashlees_window
                state: "on"
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":warning: :clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :window: Ashlee's window is still open. Waiting until
                    it's closed before closing blinds. :warning:"
                  title: "Ashlee's :bed: bedroom"
          # No children mode
          - conditions:
              - condition: state
                entity_id: input_select.home_mode
                state: No Children
              - condition: trigger
                id: sunset
              - condition: state
                entity_id: binary_sensor.ashlees_window
                state: "off"
            sequence:
              - service: script.send_to_home_log
                data:
                  message: ":city_sunset: :window: It's getting dark, closing Ashlee's blinds."
                  title: "Ashlee's :bed: bedroom"
              - service: cover.close_cover
                target:
                  entity_id: cover.ashlees_blinds
          # Bed sensor enabled
          - conditions:
              - condition: state
                entity_id: input_boolean.enable_ashlees_bed_sensor
                state: "on"
              - condition: state
                entity_id: binary_sensor.ashlees_window
                state: "off"
              - condition: trigger
                id: sunset
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}:
                    :city_sunset: :window: It's getting dark and no one is in Ashlee's :bed: bed,
                    closing Ashlee's blinds."
                  title: "Ashlee's :bed: bedroom"
              - service: cover.close_cover
                target:
                  entity_id: cover.ashlees_blinds
          # Bed sensor is off
          - conditions:
              - condition: state
                entity_id: binary_sensor.ashlees_window
                state: "off"
              - condition: state
                entity_id: input_boolean.enable_ashlees_bed_sensor
                state: "off"
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :city_sunset: :window: It's getting dark, closing Ashlee's blinds."
                  title: "Ashlee's :bed: bedroom"
              - service: cover.close_cover
                target:
                  entity_id: cover.ashlees_blinds
        default: []
    mode: single
  - id: "1622891806607"
    alias: "Ashlee's Room: Window Closed After Dark"
    description: ""
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.ashlees_window
        from: "on"
        to: "off"
        for:
          hours: 0
          minutes: 1
          seconds: 0
    condition:
      - condition: numeric_state
        entity_id: cover.ashlees_blinds
        attribute: current_position
        above: input_number.bedroom_blind_closed_threshold
      - condition: state
        entity_id: input_boolean.enable_ashlees_blind_automations
        state: "on"
      - condition: time
        after: input_datetime.childrens_bed_time
    action:
      - service: script.send_to_home_log
        data:
          message: ":window: Window closed and it's dark. Closing blinds."
          title: "Ashlee's :bed: bedroom"
      - service: cover.close_cover
        target:
          entity_id: cover.ashlees_blinds
        data: {}
    mode: single
  - id: "1605775729191"
    alias: "Ashlee's Room: Turn Off Lamp After An Hour"
    description: ""
    trigger:
      - platform: state
        entity_id: switch.ashlees_lamp
        to: "on"
        for: 01:00:00
    condition: []
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.ashlees_lamp
      - service: script.send_to_home_log
        data:
          message: "Lamp has been on for 1 hour. Turning lamp off."
          title: "Ashlee's :bed: bedroom"
    mode: single
  - id: "1599994669457"
    alias: "Ashlee's Room: Open Blinds In The Morning"
    description: ""
    trigger:
      - at: 07:30:00
        platform: time
      - at: 08:00:00
        platform: time
    condition:
      - condition: numeric_state
        entity_id: cover.ashlees_blinds
        attribute: current_position
        below: input_number.blind_closed_position_threshold
      - condition: state
        entity_id: input_boolean.enable_ashlees_blind_automations
        state: "on"
      - not:
          - condition: state
            entity_id: input_select.home_mode
            state: Guest
          - condition: state
            entity_id: input_select.home_mode
            state: "No Children"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "on"
            sequence:
              - data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :sunrise: :window: School day. Opening Ashlee's blinds"
                  title: "Ashlee's :bed: bedroom"
                service: script.send_to_home_log
              - service: cover.open_cover
                target:
                  entity_id: cover.ashlees_blinds
          - conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "on"
            sequence:
              - data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :sunrise: :window: Non school day. Opening Ashlee's blinds"
                  title: "Ashlee's :bed: bedroom"
                service: script.send_to_home_log
              - service: cover.open_cover
                target:
                  entity_id: cover.ashlees_blinds
        default: []
    mode: single
  - id: "1599994669458"
    alias: "Ashlee's Room: Open Blinds In The Morning No Children Mode"
    description: ""
    trigger:
      - at: 08:00:00
        platform: time
        id: workday
      - at: 09:00:00
        platform: time
        id: non_workday
    condition:
      - condition: state
        entity_id: input_select.home_mode
        state: "No Children"
    action:
      - choose:
          - conditions:
              - condition: state
                state: "off"
                entity_id: binary_sensor.workday_sensor
              - condition: trigger
                id: workday
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :window: Opening blinds
                    with {{ states('input_select.home_mode') }} on a non working day."
                  title: "Ashlee's :bed: bedroom"
              - service: cover.open_cover
                target:
                  entity_id: cover.ashlees_blinds
          - conditions:
              - condition: state
                state: "on"
                entity_id: binary_sensor.workday_sensor
              - condition: trigger
                id: non_workday
            sequence:
              - service: script.send_to_home_log
                data:
                  message:
                    ":clock{{ now().strftime('%I') | int }}{% if now().minute | int
                    > 25 and now().minute | int < 35 %}30{% else %}{% endif %}: :window: Opening blinds
                    with {{ states('input_select.home_mode') }} on a working day."
                  title: "Ashlee's :bed: bedroom"
              - service: cover.open_cover
                target:
                  entity_id: cover.ashlees_blinds
        default: []
    mode: single
  - id: "1655237597647"
    alias: "Ashlee's Bedroom: Someone Is In Bed"
    description: ""
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.ashlees_bed_occupied
        from: "off"
        to: "on"
        for:
          hours: 0
          minutes: 0
          seconds: 30
    condition: []
    action:
      - parallel:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.enable_ashlees_bed_sensor
                    state: "on"
                  - condition: state
                    entity_id: input_boolean.enable_ashlees_blind_automations
                    state: "on"
                  - condition: numeric_state
                    entity_id: cover.ashlees_blinds
                    attribute: current_position
                    below: input_number.blind_closed_position_threshold
                  - or:
                      - condition: time
                        after: input_datetime.childrens_bed_time
                      - condition: time
                        before: 05:00:00
                  - condition: state
                    entity_id: binary_sensor.ashlees_window
                    state: "off"
                sequence:
                  - service: script.send_to_home_log
                    data:
                      message:
                        "Someone is in Ashlee's :bed: bed after :clock730:. Closing
                        blinds."
                      title: "Ashlee's :bed: bedroom"
                  - service: cover.close_cover
                    data: {}
                    target:
                      entity_id: cover.ashlees_blinds
            default: []
    mode: single
  # Switches
  - id: "1655235874989"
    alias: "Ashlee's Bedroom: Turn Off Fan After 1 Hour"
    description: ""
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.ashlees_bedroom_fan_turn_off
    condition: []
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: ":fan: Fan has been on for an hour. Turning fan off."
              title: ":bed: Ashlee's bedroom"
          - service: switch.turn_off
            data: {}
            target:
              entity_id: switch.ashlees_fan
    mode: single
  - id: "165523587499"
    alias: "Ashlee's Bedroom: Fan Turn On"
    description: ""
    trigger:
      - platform: state
        entity_id:
          - switch.ashlees_fan
        to: "on"
    condition: []
    action:
      - parallel:
          - service: script.send_to_home_log
            data:
              message: ":fan: Fan turned on."
              title: ":bed: Ashlee's bedroom"
          - service: timer.start
            data:
              duration: 01:00:00
            target:
              entity_id: timer.ashlees_bedroom_fan_turn_off
    mode: single
  # Hue Remote
  - id: "1656355431188"
    alias: "Ashlee's Bedroom: Hue Remote Short Presses"
    description: ""
    trigger:
      - platform: event
        event_type: hue_event
        event_data:
          id: ashlee_s_switch_button
          type: short_release
    condition: []
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.unique_id == '1096f89c-ec38-4b07-afc0-67a6294443af'}}"
            sequence:
              - service: script.send_to_home_log
                data:
                  message: "Power button pressed. :bulb: Toggling light."
                  title: ":bed: Ashlee's Bedroom"
              - service: light.toggle
                data: {}
                target:
                  entity_id: light.ashlees_main_light
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.unique_id == '0c3030ec-fe67-4f11-9682-01a6ff9b10d1'}}"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Hue buttom on remote pressed. Toggle Ahlee's :bulb: lamp."
                      title: ":bed: Ashlee's Bedroom"
                  - service: switch.toggle
                    data: {}
                    target:
                      entity_id: switch.ashlees_lamp
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.unique_id == 'a4594566-7671-449a-b348-2d9822d62f38'}}"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Bright buttom on remote pressed. Opening :window: Ashlee's blinds."
                      title: ":bed: Ashlee's Bedroom"
                  - service: cover.open_cover
                    data: {}
                    target:
                      entity_id: cover.ashlees_blinds
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.unique_id == '0c27554e-9338-4bd2-8cff-6255654fca42'}}"
            sequence:
              - parallel:
                  - service: script.send_to_home_log
                    data:
                      message: "Dim buttom on remote pressed. Closing :window: Ashlee's blinds."
                      title: ":bed: Ashlee's Bedroom"
                  - service: cover.close_cover
                    data: {}
                    target:
                      entity_id: cover.ashlees_blinds
        default: []
    mode: queued
    max: 10

script:
  ashlees_bedroom_close_blinds_by_weather:
    alias: Ashlee's Bedroom Close Blinds Based Weather
    description: "Close Leo's bedroom blinds depending on the weather."
    fields:
      temperature:
        description: Temperature in celcius.
        required: true
      weather_condition:
        description: Text weather condition e.g. lightning-rainy
        required: true
    sequence:
      # Only run the weather check if it's during the day otherwise it might be closed for evening.
      - if:
          - condition: sun
            before: sunset
          - condition: state
            entity_id: input_boolean.enable_ashlees_blind_automations
            state: "on"
          - condition: numeric_state
            entity_id: cover.ashlees_blinds
            attribute: current_position
            above: input_number.blind_open_position_threshold
        then:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ weather_condition in ['sunny','partlycloudy'] }}"
                sequence:
                  - choose:
                      # Check if window is open.
                      - conditions:
                          - condition: state
                            entity_id: binary_sensor.bedroom_window
                            state: "on"
                        sequence:
                          # TODO: replace with actionable notification
                          - service: script.send_to_home_log
                            data:
                              message:
                                "It's going to be hot ({{ temperature }} {{ weather_condition }}) and
                                the :window: window is open preventing the blinds from closing."
                              title: "Ashlee's :bed: Bedroom"
                    default:
                      - service: script.send_to_home_log
                        data:
                          message: "It's going to be hot ({{ temperature }} {{ weather_condition }}). Closing blinds."
                          title: "Ashlee's :bed: Bedroom"
                      - service: cover.close_cover
                        target:
                          entity_id: cover.ashlees_blinds
            default: []
    mode: single
    icon: mdi:roller-shade-closed

template:
  - binary_sensor:
      - name: Ashlees Bed Occupied
        unique_id: f884af3a-2eb7-42ee-9d23-4e3dc41e575d
        icon: >-
          mdi:bed-single{{ '-outline' if (states('sensor.ashlees_bed_top') | float(0) >= 0.1) or
          (states('sensor.ashlees_bed_middle_top') | float(0)) >= 0.1 or
          (states('sensor.ashlees_bed_middle_bottom') | float(0)) >= 0.1 or
          (states('sensor.ashlees_bed_bottom') | float(0)) >= 0.1 else '' }}
        device_class: occupancy
        state: >-
          {% if (states('sensor.ashlees_bed_top') | float(0)) >= 0.1 or
              (states('sensor.ashlees_bed_middle_top') | float(0)) >= 0.1 or
              (states('sensor.ashlees_bed_middle_bottom') | float(0)) >= 0.1 or
              (states('sensor.ashlees_bed_bottom') | float(0)) >= 0.1 %}
            on
          {% else %}
            off
          {% endif %}
        attributes:
          top: "{{ states('sensor.ashlees_bed_top') }}"
          top_middle: "{{ states('sensor.ashlees_bed_middle_top') }}"
          bottom_middle: "{{ states('sensor.ashlees_bed_middle_bottom') }}"
          bottom: "{{ states('sensor.ashlees_bed_bottom') }}"
  - trigger:
      - platform: state
        entity_id:
          - binary_sensor.ashlees_window
          - input_number.close_blinds_brightness_threshold
          - input_number.forecast_high_temperature
          - sensor.ashlees_bedroom_area_mean_temperature
          - sensor.ashlees_window_temperature
          - sensor.front_garden_motion_light_level
          - sun.sun
          - weather.home_hourly
      - platform: time_pattern
        minutes: "/15"
    binary_sensor:
      - name: Ashlee's Bedroom Blind Anticipated State
        unique_id: 48b99f2d-c634-418d-bfd0-19c2e2ce640f
        device_class: opening
        state: >-
          {{ not(states('sensor.front_garden_motion_light_level')|float(0) < states('input_number.close_blinds_brightness_threshold')|float(10000)
          and not(states('sun.sun') == 'above_horizon')
          and states('binary_sensor.ashlees_window') == 'off')
          and state_attr('weather.home_hourly', 'temperature')|float(0) < states('input_number.forecast_high_temperature')|float(24)
          and (states('sensor.ashlees_bedroom_area_mean_temperature')|float(0)) <= 23.5
          and (states('sensor.ashlees_window_temperature')|float(0)) <= 24
          and not(states('weather.home_hourly') in ['sunny','partlycloudy']) }}
        attributes:
          brightness: "{{ (states('sensor.front_garden_motion_light_level')|float(0)) < (states('input_number.close_blinds_brightness_threshold')|float(10000)) }}"
          sun: "{{ states('sun.sun') == 'above_horizon' }}"
          temperature: "{{ (states('sensor.ashlees_bedroom_area_mean_temperature')|float(0)) > 23.5 }}"
          temperature_hour_forecast: "{{ states('weather.home_hourly')|float(0) < states('input_number.forecast_high_temperature')|float(24) }}"
          weather: "{{ states('home_hourly')|default('') in ['sunny','partlycloudy'] }}"
          window: "{{ states('binary_sensor.ashlees_window') == 'off' }}"
          window_temperature: "{{ (states('sensor.ashlees_window_temperature')|float(0)) > 24 }}"
